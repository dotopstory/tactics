"use strict";var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],a=!0,n=!1,i=void 0;try{for(var o,l=e[Symbol.iterator]();!(a=(o=l.next()).done)&&(r.push(o.value),!t||r.length!==t);a=!0);}catch(e){n=!0,i=e}finally{try{!a&&l.return&&l.return()}finally{if(n)throw i}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toArray(e){return Array.isArray(e)?e:Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}!function(){function L(e,t,r){return{type:e,target:t,data:r,done:!1}}function e(){return{height:0}}e.update=function(e){e.done||4==++e.data.height&&(e.done=!0)};var t=Object.freeze({default:e});function r(e){return{height:4,time:0}}r.update=function(e){if(!e.done){var t=e.data;t.time++;var r=t.time%120/120;t.height=4+Math.sin(2*Math.PI*r)}};var a=Object.freeze({default:r});function n(e){return{height:Math.round(e||4)}}n.update=function(e){e.done||--e.data.height||(e.done=!0)};var i=Object.freeze({default:n});function o(e){return{path:e,cell:e[0].slice(),time:0}}o.update=function(e){if(e.done)return!1;var t=e.data,r=Math.floor(t.time/4),a=t.time%4*.25,n=t.path[r],i=t.path[r+1];return i?t.cell=[n[0]+(i[0]-n[0])*a,n[1]+(i[1]-n[1])*a]:(t.cell=n.slice(),e.done=!0),t.time++,!0};var l=Object.freeze({default:o});function s(e,t){var r=[t[0]-e[0],t[1]-e[1]],a=Math.sqrt(r[0]*r[0]+r[1]*r[1]);return{src:e,norm:[r[0]/a,r[1]/a],cell:e.slice(),time:0}}s.update=function(e){if(!e.done){var t=e.data,r=t.time<=4?t.time:4-(t.time-4);t.cell[0]=t.src[0]+t.norm[0]/8*r,t.cell[1]=t.src[1]+t.norm[1]/8*r,9==++t.time&&(e.done=!0)}};var u=Object.freeze({default:s});function f(){return{time:0,flashing:!1}}f.update=function(e){if(!e.done){var t=e.data;t.flashing=!t.flashing,15==++t.time&&(e.done=!0)}};var c=Object.freeze({default:f});function h(){return{time:0,visible:!0}}h.update=function(e){if(!e.done){var t=e.data;t.visible=!t.visible,30==++t.time&&(e.done=!0)}};var p=Object.freeze({default:h}),j={lift:t&&e||t,float:a&&r||a,drop:i&&n||i,move:l&&o||l,attack:u&&s||u,flinch:c&&f||c,fade:p&&h||p};function N(e,t){return Math.abs(t[0]-e[0])+Math.abs(t[1]-e[1])}function g(e){return e[0]}function v(e){return e[1]}function Le(e,t){return g(e)===g(t)&&v(e)===v(t)}function U(e,t){t||(t=1);for(var r=[{steps:0,cell:e}],a=[];r.length;)for(var n=r.shift(),i=[[g(n.cell)-1,v(n.cell)],[g(n.cell)+1,v(n.cell)],[g(n.cell),v(n.cell)-1],[g(n.cell),v(n.cell)+1]],o=0;o<i.length;o++){var l=i[o];if(!Le(e,l)){for(var s=0;s<a.length;s++){if(Le(l,a[s]))break}s<a.length||(a.push(l),n.steps+1<t&&r.push({steps:n.steps+1,cell:l}))}}return a}function d(e){return e.layout.size[0]}function je(e,t){return e.tiles[e.layout.data[v(t)*d(e)+g(t)]]}function V(e,t){for(var r=0;r<e.units.length;r++){var a=e.units[r];if(Le(t,a.cell))return a}}function m(e,t){return 0<=g(t)&&g(t)<d(e)&&0<=v(t)&&v(t)<e.layout.size[1]}function y(e,t,r,a){return{type:e,faction:t,ai:r,cell:a,hp:3}}function J(e,t){if("warrior"===e.type)if("warrior"===t.type)t.hp-=2;else if("knight"===t.type)t.hp-=2;else{if("rogue"===t.type)return;"mage"===t.type&&(t.hp-=3)}else if("knight"===e.type)"warrior"===t.type?t.hp-=2:"knight"===t.type?t.hp-=1:"rogue"===t.type?t.hp-=2:"mage"===t.type&&(t.hp-=2);else if("rogue"===e.type)if("warrior"===t.type)t.hp-=2;else{if("knight"===t.type)return;"rogue"===t.type?t.hp-=1:"mage"===t.type&&(t.hp-=2)}else"mage"===e.type&&("warrior"===t.type?t.hp-=2:"knight"===t.type?t.hp-=1:"rogue"===t.type?t.hp-=2:"mage"===t.type&&(t.hp-=1));t.hp<0&&(t.hp=0)}function qe(e){switch(e.type){case"warrior":return 5;case"knight":return 4;case"rogue":return 6;case"mage":return 5}}function K(e){switch(e.type){case"warrior":case"knight":case"rogue":return 1;case"mage":return 2}}function Re(e,t){return e.faction===t.faction||"player"===e.faction&&"ally"===t.faction||"ally"===e.faction&&"player"===t.faction}function Xe(e,t){var r=K(t),a=qe(t);if(!a)return[];for(var n=[{steps:0,cell:t.cell}],i=[t.cell];n.length;)for(var o=n.shift(),l=U(o.cell),s=0;s<l.length;s++){var u=l[s];if(m(e,u))if(!je(e,u).solid){for(var f=0;f<i.length&&!Le(u,i[f]);f++);if(!(f<i.length)){for(f=0;f<e.units.length;f++){if(Le(u,(g=e.units[f]).cell))break;g=null}if((!g||g&&!Re(t,g))&&i.push(u),(!g||g&&Re(t,g))&&o.steps<a-1)n.push({steps:o.steps+1,cell:u});else{var c=U(u,r);for(f=0;f<c.length;f++){var h=c[f];if(m(e,h)&&!Le(h,t.cell)){for(var p=0;p<i.length&&!Le(h,i[p]);p++);if(!(p<i.length)){for(p=0;p<e.units.length;p++){var g;if(Le(h,(g=e.units[p]).cell))break;g=null}g&&i.push(h)}}}}}}}return i}function I(e,t){var r=document.createElement("canvas");return r.width=e,r.height=t,r.getContext("2d")}var Ye={warrior:"axe",knight:"shield",rogue:"dagger",mage:"hat"};function q(e,t){var r=e.phase.pending;r.splice(r.indexOf(t),1),r.length||function e(t){var r=t.map,a=t.phase;a.faction="player"===a.faction?"enemy":"player";a.pending=r.units.filter(function(e){return e.faction===a.faction});a.pending.length||e(t)}(e)}function R(e,t,r){var a=document.createElement("canvas");return a.width=e,a.height=t,{sprites:r,context:a.getContext("2d"),anims:[],path:[],viewport:{size:[e,t],position:[72,160]},mouse:null,cursor:null,target:null,selection:null,hover:{time:0,target:null,dialog:null,entering:!1},cache:{time:0,phase:{faction:"player",next:"player",pending:[]},units:[],hover:{target:null,last:null},range:null,selection:null,moving:!1,focus:null}}}R.render=function(h,e){var p=h.sprites,t=h.context,g=h.anims,r=h.cursor,v=h.cache,d=h.viewport,a=e.map,m=e.phase,n=_slicedToArray(a.layout.size,2),i=n[0],o=n[1],l=t.canvas,y=g[0],s=["tiles","shadows","walls","squares","pieces","arrows","cursor","selection","dialogs"],w={},u=!0,f=!1,c=void 0;try{for(var b,x=s[Symbol.iterator]();!(u=(b=x.next()).done);u=!0){var k=b.value;w[k]=[]}}catch(e){f=!0,c=e}finally{try{!u&&x.return&&x.return()}finally{if(f)throw c}}if(v.units.length||(v.units=a.units.map(function(e){return Object.assign({original:e},e)})),v.phase.pending.length<m.pending.length&&!g.find(function(e){return e.target.faction===v.phase.faction})&&(v.phase.pending=m.pending.slice()),v.phase.faction!==v.phase.next){var I=g.find(function(e){return e.target.faction===v.phase.faction});(!I||0<g.indexOf(I))&&(v.phase.faction=v.phase.next)}if(v.phase.next!==m.faction&&v.phase.faction===v.phase.next&&(v.phase.next=m.faction),h.selection?v.focus=h.selection:y&&"enemy"===v.phase.faction&&"enemy"===y.target.faction?v.focus=y.target:v.focus=null,v.focus){var A=v.focus,z=_slicedToArray(A.cell,2),M=z[0],S=z[1],O=16*M+8-d.size[0]/2,C=16*S+8-d.size[1]/2;d.position[0]+=(O-d.position[0])/16,d.position[1]+=(C-d.position[1])/16}t.beginPath(),t.fillStyle="black",t.fillRect(0,0,l.width,l.height);var T=h.hover.dialog;if(v.hover.target!==h.hover.target){v.hover.target=h.hover.target;var _=h.hover.target;if(h.hover.entering!==!!_&&(h.hover.entering=!!_),_){v.hover.last=_;var D=p.pieces.symbols[Ye[_.type]];(T=h.hover.dialog=p.ui.TextBox(["  "+_.type.toUpperCase(),"","HP  "+_.hp+"/3","STR "+function(e){switch(e.type){case"warrior":return 3;case"knight":return 2;case"rogue":return 1;case"mage":return 0}}(_),"INT "+function(e){switch(e.type){case"warrior":return 0;case"knight":return 2;case"rogue":return 1;case"mage":return 3}}(_),"AGI "+function(e){switch(e.type){case"warrior":return 2;case"knight":return 0;case"rogue":return 3;case"mage":return 1}}(_),"MOV "+qe(_)])).getContext("2d").drawImage(D,16,16)}}var E=h.hover.target||v.hover.last;if(E){var L=h.mouse&&h.mouse[0]>=d.size[0]/2?-T.width:t.canvas.width,j=L+((h.mouse&&h.mouse[0]>=d.size[0]/2?8:t.canvas.width-T.width-8)-L)/8*h.hover.time,q=t.canvas.height-T.height-8;h.hover.entering&&8<++h.hover.time?h.hover.time=8:!h.hover.entering&&--h.hover.time<0&&(h.hover.time=0),w.dialogs.push({image:T,position:[j,q]})}for(var R=0;R<o;R++)for(var X=0;X<i;X++){var Y=je(a,[X,R]),P=16*X-d.position[0],B=16*R-d.position[1],F=null;"wall"===Y.name?(F=p.tiles.wall,je(a,[X,R+1])!==Y&&(F=p.tiles["wall-base"])):"floor"===Y.name?F=p.tiles.floor:"grass"===Y.name&&(F=p.tiles.grass),Y.solid?w.walls.push({image:F,position:[P,B]}):w.tiles.push({image:F,position:[P,B]})}if(E=h.selection){v.selection!==E&&(v.range=Xe(a,E),v.selection=E,v.selected=E);var G=!0,H=!1,N=void 0;try{for(var U,V=v.range[Symbol.iterator]();!(G=(U=V.next()).done);G=!0){var J=U.value,K=_slicedToArray(J,2),Q=K[0],W=K[1],Z=16*Q-d.position[0],$=16*W-d.position[1],ee="move",te=!0,re=!1,ae=void 0;try{for(var ne,ie=a.units[Symbol.iterator]();!(te=(ne=ie.next()).done);te=!0){var oe=ne.value;if(Le(J,oe.cell)){ee=Re(E,oe)?"ally":"attack";break}}}catch(e){re=!0,ae=e}finally{try{!te&&ie.return&&ie.return()}finally{if(re)throw ae}}if("move"===ee||"attack"===ee){var le=p.ui.squares[ee];w.squares.push({image:le,position:[Z,$]})}}}catch(e){H=!0,N=e}finally{try{!G&&V.return&&V.return()}finally{if(H)throw N}}}else v.selection&&y&&"move"===y.type&&y.target===v.selection&&(v.moving=!0),v.range=null,v.selection=null;for(var se=function(e){var t=v.units[e],r={warrior:"axe",knight:"shield",rogue:"dagger",mage:"hat"}[t.type],a=p.pieces[t.faction][r],n=t.cell,i=0;if(y&&t.original===y.target){if("lift"===y.type||"float"===y.type||"drop"===y.type)i=-y.data.height;else if("move"===y.type)n=y.data.cell,y.done&&(t.cell=y.data.cell,v.moving=!1);else if("attack"===y.type)n=y.data.cell;else if("flinch"===y.type)y.data.flashing&&(a=p.pieces.flashing);else if("fade"===y.type){if(y.done)return v.units.splice(e--,1),"continue";if(!y.data.visible)return"continue"}}else!v.phase.pending.includes(t.original)||m.pending.includes(t.original)||g.length||v.phase.pending.splice(v.phase.pending.indexOf(t.original),1);var o=_slicedToArray(n,2),l=o[0],s=o[1],u=16*l-d.position[0],f=16*s-d.position[1];t.faction!==v.phase.faction||v.phase.pending.includes(t.original)||g.find(function(e){return e.target===t.original})||(a=p.pieces.done[t.faction][r]);var c="pieces";(t.original===h.selection||g.find(function(e){return["lift","float","drop","attack"].includes(e.type)&&e.target===t.original}))&&(c="selection"),w[c].push({image:a,position:[u,f+i]}),w.shadows.push({image:p.pieces.shadow,position:[u+1,f+4]}),ue=e},ue=0;ue<v.units.length;ue++)se(ue);if(h.path.length){var fe,ce=function(e,t){for(var r=[],a=0;a<e.length;a++){var n=_slicedToArray(e[a],2),i=n[0],o=n[1],l=!1,s=!1,u=!1,f=!1,c=e[a-1];if(c){var h=i-c[0],p=o-c[1];1===h?l=!0:-1===h&&(s=!0),1===p?u=!0:-1===p&&(f=!0)}var g=e[a+1];if(g){var v=g[0]-i,d=g[1]-o;-1===v?l=!0:1===v&&(s=!0),-1===d?u=!0:1===d&&(f=!0)}if(l||s||u||f){var m=null;l&&s?m="horiz":u&&f?m="vert":u&&l?m="upLeft":u&&s?m="upRight":f&&l?m="downLeft":f&&s?m="downRight":l&&!a?m="leftStub":s&&!a?m="rightStub":u&&!a?m="upStub":f&&!a?m="downStub":l?m="left":s?m="right":u?m="up":f&&(m="down"),m&&r.push({image:t[m],position:[i,o]})}}return r}(h.path,p.ui.arrows);(fe=w.arrows).push.apply(fe,_toConsumableArray(ce.map(function(e){return{image:e.image,position:[16*e.position[0]-d.position[0],16*e.position[1]-d.position[1]]}})))}if(r&&(!v.moving||v.moving&&v.time%2)){var he=_slicedToArray(r,2),pe=he[0],ge=he[1],ve=16*pe-d.position[0],de=16*ge-d.position[1],me=Math.floor(v.time/30)%p.ui.cursor.length;w.cursor.push({image:p.ui.cursor[me],position:[ve,de]})}var ye=!0,we=!1,be=void 0;try{for(var xe,ke=s[Symbol.iterator]();!(ye=(xe=ke.next()).done);ye=!0){var Ie=xe.value,Ae=w[Ie];Ae.sort(function(e,t){return e.position[1]-t.position[1]});var ze=!0,Me=!1,Se=void 0;try{for(var Oe,Ce=Ae[Symbol.iterator]();!(ze=(Oe=Ce.next()).done);ze=!0){var Te=Oe.value,_e=_slicedToArray(Te.position,3),De=_e[0],Ee=_e[1];_e[2],t.drawImage(Te.image,Math.round(De),Math.round(Ee))}}catch(e){Me=!0,Se=e}finally{try{!ze&&Ce.return&&Ce.return()}finally{if(Me)throw Se}}}}catch(e){we=!0,be=e}finally{try{!ye&&ke.return&&ke.return()}finally{if(we)throw be}}},R.update=function(e){e.cache.time++;var t=e.anims,r=t[0];r&&(r.done?t.shift():j[r.type].update(r))};var w={piece:{palette:[80,50,3,3],shadow:[112,0,14,14],symbols:{shield:[112,72,8,8],bow:[112,34,8,8],dagger:[112,16,8,8],sword:[112,104,8,8],axe:[96,120,8,8],hat:[64,120,8,8],lance:[0,120,8,8]},base:[96,34,16,16]},tiles:{"wall-base":[96,104,16,16],floor:[112,56,16,16],grass:[96,16,16,16],wall:[80,34,16,16]},ui:{cursor:[64,104,32,16],box:[64,56,48,48],squares:[80,0,32,16],arrows:[0,56,64,64],typeface:[0,0,80,56],swords:[80,16,16,18]}};function b(e,t,r,a,n){var i=document.createElement("canvas"),o=i.getContext("2d");return i.width=a,i.height=n,o.drawImage(e,-t,-r),i}var A={get:function(e,t,r){var a=4*(r*e.width+t),n=e.data[a],i=e.data[a+1],o=e.data[a+2],l=e.data[a+3];return[n,i,o,l]},replace:function(e,t,r){for(var a=0;a<e.data.length;a+=4){for(var n=0;n<4&&e.data[a+n]===t[n];n++);if(4===n)for(var n=0;n<4;n++)e.data[a+n]=r[n]}}};function x(e){var t=function e(t,r){var a={};for(var n in r)if(Array.isArray(r[n])){var i=_slicedToArray(r[n],4),o=i[0],l=i[1],s=i[2],u=i[3];a[n]=b(t,o,l,s,u)}else a[n]=e(t,r[n]);return a}(e,w);return{tiles:t.tiles,pieces:function(e){var t={player:{},enemy:{},ally:{},done:{player:{},enemy:{},ally:{}},flashing:null,symbols:e.symbols,shadow:e.shadow},r=e.palette.getContext("2d").getImageData(0,0,3,3),a={black:[0,0,0,255],white:[255,255,255,255],cyan:A.get(r,0,0),blue:A.get(r,1,0),navy:A.get(r,2,0),pink:A.get(r,0,1),red:A.get(r,1,1),purple:A.get(r,2,1),lime:A.get(r,0,2),green:A.get(r,1,2),teal:A.get(r,2,2)},n={player:[a.cyan,a.blue,a.navy],enemy:[a.pink,a.red,a.purple],ally:[a.lime,a.green,a.teal]};for(var i in n){var o=n[i];for(var l in e.symbols){var s=e.symbols[l],u=I(s.width,s.height);u.drawImage(s,0,0);var f=e.base.getContext("2d").getImageData(0,0,16,16);A.replace(f,a.white,o[1]),A.replace(f,a.black,o[2]);var c=I(f.width,f.height);c.putImageData(f,0,0);var h=u.getImageData(0,0,s.width,s.height);A.replace(h,a.white,o[0]),u.putImageData(h,0,0),c.drawImage(u.canvas,4,4),A.replace(h,o[0],o[2]),u.putImageData(h,0,0),c.drawImage(u.canvas,4,3),t[i][l]=c.canvas}}for(var p in n){var g=n[p];for(var v in e.symbols){var d=e.symbols[v],m=I(d.width,d.height);m.drawImage(d,0,0);var y=e.base.getContext("2d").getImageData(0,0,16,16);A.replace(y,a.white,g[2]);var w=I(y.width,y.height);w.putImageData(y,0,0);var b=m.getImageData(0,0,d.width,d.height);A.replace(b,a.white,g[1]),m.putImageData(b,0,0),w.drawImage(m.canvas,4,4),A.replace(b,g[1],a.black),m.putImageData(b,0,0),w.drawImage(m.canvas,4,3),t.done[p][v]=w.canvas}}var x=e.base.getContext("2d").getImageData(0,0,16,16);A.replace(x,a.blue,a.white),A.replace(x,a.navy,a.white);var k=I(x.width,x.height);return k.putImageData(x,0,0),t.flashing=k.canvas,t}(t.piece),ui:function(e){var u={swords:e.swords,cursor:function(e){for(var t=e.width/16,r=new Array(t),a=0;a<t;a++)r[a]=b(e,16*a,0,16,16);return r}(e.cursor),typeface:function(e){for(var t={},r=0,a=0;a<7;a++)for(var n=0;n<10;n++){var i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,.!?abcdefghijklmnopqrstuvwxyz'\"/ "[r++];t[i]=b(e,8*n,8*a,8,8)}return t}(e.typeface),box:{topLeft:b(e.box,0,0,16,16),top:b(e.box,16,0,16,16),topRight:b(e.box,32,0,16,16),left:b(e.box,0,16,16,16),center:b(e.box,16,16,16,16),right:b(e.box,32,16,16,16),bottomLeft:b(e.box,0,32,16,16),bottom:b(e.box,16,32,16,16),bottomRight:b(e.box,32,32,16,16)},squares:{move:b(e.squares,0,0,16,16),attack:b(e.squares,16,0,16,16)},arrows:{left:b(e.arrows,0,0,16,16),right:b(e.arrows,16,0,16,16),up:b(e.arrows,32,0,16,16),down:b(e.arrows,48,0,16,16),leftStub:b(e.arrows,0,16,16,16),rightStub:b(e.arrows,16,16,16,16),upStub:b(e.arrows,32,16,16,16),downStub:b(e.arrows,48,16,16,16),upLeft:b(e.arrows,0,32,16,16),upRight:b(e.arrows,16,32,16,16),downLeft:b(e.arrows,32,32,16,16),downRight:b(e.arrows,48,32,16,16),horiz:b(e.arrows,0,48,16,16),vert:b(e.arrows,16,48,16,16)}};return u.Text=f,u.Box=c,u.TextBox=function(e){var t=e.map(function(e){return e.length}),r=8*Math.max.apply(Math,_toConsumableArray(t)),a=8*e.length,n=c(r+32,a+32),i=document.createElement("canvas"),o=i.getContext("2d");i.width=r,i.height=a;for(var l=0;l<e.length;l++){var s=e[l];s.length&&o.drawImage(f(s),0,8*l)}return n.getContext("2d").drawImage(i,16,16),n},u;function f(e){var t=document.createElement("canvas");t.width=8*e.length,t.height=8;for(var r=t.getContext("2d"),a=0;a<e.length;a++){var n=e[a],i=u.typeface[n];r.drawImage(i,8*a,0)}return t}function c(e,t){var r=Math.ceil(e/16),a=Math.ceil(t/16),n=document.createElement("canvas"),i=n.getContext("2d");n.width=e,n.height=t;for(var o=1;o<r-1;o++)i.drawImage(u.box.top,16*o,0),i.drawImage(u.box.bottom,16*o,t-16);for(var l=1;l<a-1;l++){i.drawImage(u.box.left,0,16*l),i.drawImage(u.box.right,e-16,16*l);for(var s=1;s<r-1;s++)i.drawImage(u.box.center,16*s,16*l)}return i.drawImage(u.box.topLeft,0,0),i.drawImage(u.box.topRight,n.width-16,0),i.drawImage(u.box.bottomLeft,0,n.height-16),i.drawImage(u.box.bottomRight,n.width-16,n.height-16),n}}(t.ui)}}function Q(e,t,r){for(var a=[],n=[t],i={},o={},l={},s={},u={},f=0;f<e.length;f++){s[h=e[f]]=1/0,u[h]=1/0}for(s[t]=0,u[t]=N(t,r);n.length;){var c={score:1/0,index:-1,cell:null};for(f=0;f<n.length;f++){(d=u[h=n[f]])<c.score&&(c.score=d,c.index=f,c.cell=h)}var h;if(Le(h=c.cell,r)){for(;!Le(h,t);)a.unshift(h),h=l[h];return a.unshift(h),a}n.splice(c.index,1),i[h]=!1,o[h]=!0;var p=U(h);for(f=0;f<p.length;f++){var g=p[f];if(!o[g]){for(var v=0;v<e.length;v++){if(Le(e[v],g))break}var d;if(v!==e.length)i[g]||(i[g]=!0,n.push(g)),(d=s[h]+1)>=s[g]||(l[g]=h,s[g]=d,u[g]=d+N(g,r))}}}}function W(r,e){(e=e.slice()).sort(function(e,t){return e.hp-t.hp});for(var t=1/0,a=0;a<e.length;a++){var n=e[a];if(!(n.hp<=t)){e=e.slice(0,a+1);break}t=n.hp}return e.sort(function(e,t){return N(r.cell,e.cell)-N(r.cell,t.cell)}),e[0]}var k,z=document.querySelector("main");(k="sprites.png",new Promise(function(e,t){var r=new Image;r.src=k,r.onload=function(){e(r)},r.onerror=function(){t(new Error("Failed to load image `"+k+"`"))}})).then(function(e){var D=R(256,240,x(e)),C=D.context.canvas,c=!1,E=null;z.appendChild(C),function e(){R.render(D,Y);R.update(D);if("player"===D.cache.phase.faction){if(D.mouse){var t=D.viewport;if(D.mouse[0]<=32&&0<=t.position[0]){var r=Math.round((32-D.mouse[0])/32*4);t.position[0]-=r}else if(D.mouse[0]>=t.size[0]-32&&t.position[0]+t.size[0]<=400){var a=Math.round((32-(t.size[0]-D.mouse[0]))/32*4);t.position[0]+=a}if(D.mouse[1]<=32&&0<=t.position[1]){var n=Math.round((32-D.mouse[1])/32*4);t.position[1]-=n}else if(D.mouse[1]>=t.size[1]-32&&t.position[1]+t.size[1]<=400){var i=Math.round((32-(t.size[1]-D.mouse[1]))/32*4);t.position[1]+=i}}E=null}else if(!E){var o=X.units.filter(function(e){return"enemy"===e.faction});E=function(B,t){for(var F=[],G={tiles:B.tiles,layout:B.layout,units:B.units.map(function(e){return Object.assign({},e)})},H=[],e=_slicedToArray(B.layout.size,2),r=e[0],a=e[1],n=0;n<a;n++)for(var i=0;i<r;i++){var o=n*r+i,l=B.layout.data[o];B.tiles[l].solid||H.push([i,n])}var s=G.units.filter(function(e){return e.faction===t}),u=function(r){var e=[];F.push(e);var a=[];if("defend"===r.ai){var t=U(r.cell,K(r)),n=!0,i=!1,o=void 0;try{for(var l,s=t[Symbol.iterator]();!(n=(l=s.next()).done);n=!0){var u=l.value,f=V(G,u);f&&!Re(r,f)&&a.push(f)}}catch(e){i=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(i)throw o}}if(a.length){var c=W(r,a);e.push(["attack",B.units[G.units.indexOf(c)]]),J(r,c)}}else if("wait"===r.ai){var h=Xe(G,r),p=!0,g=!1,v=void 0;try{for(var d,m=h[Symbol.iterator]();!(p=(d=m.next()).done);p=!0){var y=d.value,w=V(G,y);w&&!Re(r,w)&&a.push(w)}}catch(e){g=!0,v=e}finally{try{!p&&m.return&&m.return()}finally{if(g)throw v}}if(a.length){var b=W(r,a),x=U(b.cell,K(r)).filter(function(t){return h.find(function(e){return Le(e,t)})&&!V(G,t)});if(x.length){x.sort(function(e,t){return N(b.cell,t)-N(b.cell,e)});var k=x[0];e.push(["move",k],["attack",B.units[G.units.indexOf(b)]]),r.cell=k,J(r,b)}}}else if("attack"===r.ai){var I=Xe(G,r),A=!0,z=!1,M=void 0;try{for(var S,O=I[Symbol.iterator]();!(A=(S=O.next()).done);A=!0){var C=S.value,T=V(G,C);T&&!Re(r,T)&&a.push(T)}}catch(e){z=!0,M=e}finally{try{!A&&O.return&&O.return()}finally{if(z)throw M}}if(a.length){a.sort(function(e,t){return e.hp-t.hp}),3===a[0].hp&&a.sort(function(e,t){return N(r.cell,e.cell)-N(r.cell,t.cell)});var _=a[0],D=U(_.cell,K(r)).filter(function(t){return I.find(function(e){return Le(e,t)})&&!V(G,t)});if(D.length){D.sort(function(e,t){return N(_.cell,t)-N(_.cell,e)});var E=D[0];e.push(["move",E],["attack",B.units[G.units.indexOf(_)]]),r.cell=E,J(r,_)}}else if((a=G.units.filter(function(e){return!Re(r,e)})).length){var L=a.map(function(e){return Q(H,r.cell,e.cell).slice(0,-1)});a.sort(function(e,t){return L[a.indexOf(e)].length-L[a.indexOf(t)]});for(var j=a[0],q=L.find(function(e){return 1===N(e[e.length-1],j.cell)}),R=[],X=function(e){var t=I[e],r=q.find(function(e){return Le(t,e)});r&&!V(G,t)&&R.push(r)},Y=0;Y<I.length;Y++)X(Y);if(R.length){R.sort(function(e,t){return q.indexOf(t)-q.indexOf(e)});var P=R[0];e.push(["move",P]),r.cell=P}}}},f=!0,c=!1,h=void 0;try{for(var p,g=s[Symbol.iterator]();!(f=(p=g.next()).done);f=!0)u(p.value)}catch(e){c=!0,h=e}finally{try{!f&&g.return&&g.return()}finally{if(c)throw h}}return F}(X,"enemy");for(var l=0;l<E.length;l++){var s=E[l],u=o[l],f=!0,c=!1,h=void 0;try{for(var p,g=s[Symbol.iterator]();!(f=(p=g.next()).done);f=!0){var v=p.value,d=_toArray(v),m=d[0],y=d.slice(1);if("move"===m){var w=_slicedToArray(y,1),b=w[0],x=Xe(X,u),k=!0,I=!1,A=void 0;try{for(var z,M=o[Symbol.iterator]();!(k=(z=M.next()).done);k=!0){var S=z.value;x.push(S.cell)}}catch(e){I=!0,A=e}finally{try{!k&&M.return&&M.return()}finally{if(I)throw A}}var O=Q(x,u.cell,b);D.anims.push(L("move",u,j.move(O))),u.cell=b}else if("attack"===m){var C=_slicedToArray(y,1),T=C[0];if(!X.units.includes(T))continue;var _=T.hp;J(u,T),D.anims.push(L("attack",u,j.attack(u.cell,T.cell))),T.hp<_&&D.anims.push(L("flinch",T,j.flinch())),T.hp||(X.units.splice(X.units.indexOf(T),1),D.anims.push(L("fade",T,j.fade())))}}}catch(e){c=!0,h=e}finally{try{!f&&g.return&&g.return()}finally{if(c)throw h}}q(Y,u)}}requestAnimationFrame(e)}(),window.addEventListener("mousemove",function(e){if(e.target===C){var t=D.viewport,r=[Math.floor((e.offsetX+t.position[0])/16),Math.floor((e.offsetY+t.position[1])/16)];D.mouse=[e.offsetX,e.offsetY],D.cursor=r;var a=V(X,r);D.hover.target=a||null;var n=D.selection;if(n){var i=D.path[D.path.length-1],o=V(X,r);if(Le(r,n.cell))D.path=[n.cell];else if(!Le(i,r)&&!(o&&N(i,r)<=K(n))&&D.cache.range.find(function(e){return Le(e,r)})){for(var l=0;l<D.path.length;l++){var s=D.path[l];if(Le(s,r))break}if(l<D.path.length)return void D.path.splice(l+1,D.path.length-l-1);for(var u=D.cache.range.slice(),f=0;f<u.length;f++){var c=u[f];if(c){var h=V(X,c);h&&!Re(n,h)&&u.splice(f--,1)}}var p=X.units.filter(function(e){return Re(n,e)}),g=!0,v=!1,d=void 0;try{for(var m,y=p[Symbol.iterator]();!(g=(m=y.next()).done);g=!0){var w=m.value;u.push(w.cell)}}catch(e){v=!0,d=e}finally{try{!g&&y.return&&y.return()}finally{if(v)throw d}}for(var b=u.slice(),x=0;x<b.length;x++)for(var k=b[x],I=0;I<D.path.length;I++){var A=D.path[I];if(Le(k,A)){b.splice(x--,1);break}}var z=r;if(o){var M=U(o.cell,K(n)).filter(function(t){return u.find(function(e){return Le(e,t)})});M.length&&(z=M[0])}if(p.find(function(e){return Le(z,e.cell)}))return;var S,O=Q(b,i,z);if(O&&D.path.length+O.length-2<=qe(n))O.shift(),(S=D.path).push.apply(S,_toConsumableArray(O));else D.path=Q(u,n.cell,z)}}}else D.cursor=null,D.mouse=null}),C.addEventListener("mousedown",function(e){if(!D.cursor){var t=D.viewport;D.cursor=[Math.floor((e.offsetX-t.position[0])/16),Math.floor((e.offsetY-t.position[1])/16)]}if(D.mouse=[e.offsetX,e.offsetY],!D.selection){var r=V(X,D.cursor);r&&"player"===r.faction&&"player"===M.faction&&!D.anims.find(function(e){return"enemy"===e.target.faction})&&M.pending.includes(r)&&(c=!0,D.selection=r,D.path=[r.cell],D.anims.push(L("lift",r,j.lift()),L("float",r,j.float())))}}),C.addEventListener("mouseup",function(e){if(!D.cursor){var t=D.viewport;D.cursor=[Math.floor((e.offsetX-t.position[0])/16),Math.floor((e.offsetY-t.position[1])/16)]}D.mouse=[e.offsetX,e.offsetY];var r=D.selection;if(r){if(Le(D.cursor,r.cell)){if(c)c=!1;else{D.selection=null,D.path=[],q(Y,r);var a=null,n=D.anims[0];!n||"lift"!==n.type&&"float"!==n.type||(a=n.data.height,D.anims.shift()),D.anims.push(L("drop",r,j.drop(a)))}return}if(D.cache.range.find(function(e){return Le(e,D.cursor)})){c=!1;var i=D.selection,o=V(X,D.cursor);if(o&&Re(i,o))return;"float"===D.anims[0].type&&D.anims.shift();var l=L("move",i,j.move(D.path));if(D.anims.push(l),i.cell=D.path[D.path.length-1],o){var s=o.hp;J(i,o),D.anims.push(L("attack",i,j.attack(i.cell,o.cell))),o.hp<s&&D.anims.push(L("flinch",o,j.flinch())),o.hp||(X.units.splice(X.units.indexOf(o),1),D.anims.push(L("fade",o,j.fade())))}q(Y,i)}else{var u=null,f=D.anims[0];!f||"lift"!==f.type&&"float"!==f.type||(u=f.data.height,D.anims.shift()),D.anims.push(L("drop",r,j.drop(u)))}c||(D.selection=null,D.path=[])}})});for(var X={tiles:[{name:"grass",solid:!1},{name:"wall",solid:!0},{name:"floor",solid:!1}],layout:{size:[25,25],data:"##########################      ##.......##      ##      ##.......##      ##      ##.......##      ##      ####...####      ##      ####...####      ##      ##.......##      ##    ####.......####    ##    ####.......####    ##    ...............    ##    ####.......####    ##    ####.......####    ##      ##.......##      ##      ###########      ##      ###########      ##                       ##                       ##      ##       ##      ##      ##       ##      ##########       ##################       #########                                                                                                    ".split("").map(function(e){switch(e){case" ":return 0;case"#":return 1;case".":return 2}})},units:[y("knight","player",!1,[11,16]),y("knight","player",!1,[13,16]),y("warrior","player",!1,[10,18]),y("rogue","player",!1,[12,18]),y("warrior","player",!1,[14,18]),y("mage","player",!1,[11,20]),y("mage","player",!1,[13,20]),y("knight","enemy","defend",[12,1]),y("warrior","enemy","wait",[10,2]),y("warrior","enemy","wait",[14,2]),y("knight","enemy","defend",[11,4]),y("knight","enemy","defend",[12,4]),y("knight","enemy","defend",[13,4]),y("knight","enemy","defend",[5,9]),y("knight","enemy","defend",[19,9]),y("warrior","enemy","wait",[13,12]),y("rogue","enemy","wait",[11,11]),y("rogue","enemy","wait",[12,9]),y("warrior","enemy","wait",[13,7]),y("mage","enemy","attack",[15,10]),y("mage","enemy","attack",[9,7]),y("warrior","enemy","attack",[0,23]),y("knight","enemy","attack",[1,21]),y("warrior","enemy","attack",[24,22]),y("knight","enemy","attack",[22,23]),y("rogue","enemy","wait",[3,13]),y("rogue","enemy","wait",[21,13]),y("warrior","enemy","attack",[2,18]),y("mage","enemy","attack",[4,3]),y("rogue","enemy","attack",[2,4]),y("mage","enemy","attack",[22,4]),y("rogue","enemy","attack",[20,3]),y("rogue","enemy","wait",[23,14])]},M={faction:"player",pending:[]},Y={phase:M,map:X},S=0;S<X.units.length;S++){var O=X.units[S];O.faction===M.faction&&M.pending.push(O)}}();