"use strict";var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var a=[],i=!0,n=!1,r=void 0;try{for(var o,l=e[Symbol.iterator]();!(i=(o=l.next()).done)&&(a.push(o.value),!t||a.length!==t);i=!0);}catch(e){n=!0,r=e}finally{try{!i&&l.return&&l.return()}finally{if(n)throw r}}return a}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}!function(){var a={piece:{palette:[188,128,3,3],shadow:[160,32,14,14],symbols:{shield:[160,88,8,8],bow:[136,72,8,8],dagger:[112,88,8,8],axe:[112,112,8,8],hat:[176,64,8,8]},base:[16,176,16,16]},tiles:{"shadow-corner":[160,64,16,16],black:[112,72,16,16],"wall-base":[0,176,16,16],floor:[144,48,16,16],"shadow-edge":[144,32,16,16],grass:[176,0,16,16],wall:[96,112,16,16]},effects:{attack:[0,164,192,12]},ui:{cursor:[144,0,32,32],box:[64,64,48,48],squares:[64,112,32,16],arrows:[0,0,64,128],"enemy-phase":[0,146,170,18],healthbar:[112,64,48,8],symbols:{dragon:[128,72,8,8],shield:[160,80,8,8],bow:[176,16,8,8],boot:[32,176,8,8],dagger:[160,48,8,8],sword:[174,32,8,8],next:[176,24,8,8],eye:[184,16,8,8],clock:[112,120,8,8],axe:[120,112,8,8],hat:[112,96,8,8],enemy:[120,88,8,8],lance:[128,80,8,8]},"player-phase":[0,128,188,18],typeface:[64,0,80,64],swords:[170,146,16,18]}};function h(e,t,a,i,n){var r=document.createElement("canvas"),o=r.getContext("2d");return r.width=i,r.height=n,o.drawImage(e,-t,-a),r}var z={get:function(e,t,a){var i=4*(a*e.width+t),n=e.data[i],r=e.data[i+1],o=e.data[i+2],l=e.data[i+3];return[n,r,o,l]},set:function(e,t,a,i){var n=4*(a*e.width+t);e.data[n+0]=i[0],e.data[n+1]=i[1],e.data[n+2]=i[2],e.data[n+3]=i[3]},replace:function(e,t,a){for(var i=0;i<e.data.length;i+=4){for(var n=0;n<4&&e.data[i+n]===t[n];n++);if(4===n)for(var n=0;n<4;n++)e.data[i+n]=a[n]}}};function an(e,t){var a=document.createElement("canvas");return a.width=e,a.height=t,a.getContext("2d")}var c={warrior:"axe",knight:"shield",rogue:"dagger",mage:"hat"};function o(e){var t=function e(t,a){var i={};for(var n in a)if(Array.isArray(a[n])){var r=_slicedToArray(a[n],4),o=r[0],l=r[1],s=r[2],c=r[3];i[n]=h(t,o,l,s,c)}else i[n]=e(t,a[n]);return i}(e,a);return{tiles:t.tiles,pieces:function(e){var t={player:{},enemy:{},ally:{},done:{player:{},enemy:{},ally:{}},flashing:null,symbols:e.symbols,shadow:e.shadow},a=e.palette.getContext("2d").getImageData(0,0,3,3),i={black:[0,0,0,255],white:[255,255,255,255],cyan:z.get(a,0,0),blue:z.get(a,1,0),navy:z.get(a,2,0),pink:z.get(a,0,1),red:z.get(a,1,1),purple:z.get(a,2,1),lime:z.get(a,0,2),green:z.get(a,1,2),teal:z.get(a,2,2)},n={player:[i.cyan,i.blue,i.navy],enemy:[i.pink,i.red,i.purple],ally:[i.lime,i.green,i.teal]};for(var r in n){var o=n[r];for(var l in e.symbols){var s=e.symbols[l],c=an(s.width,s.height);c.drawImage(s,0,0);var u=e.base.getContext("2d").getImageData(0,0,16,16);z.replace(u,i.white,o[1]),z.replace(u,i.black,o[2]);var f=an(u.width,u.height);f.putImageData(u,0,0);var h=c.getImageData(0,0,s.width,s.height);z.replace(h,i.white,o[0]),c.putImageData(h,0,0),f.drawImage(c.canvas,4,4),z.replace(h,o[0],o[2]),c.putImageData(h,0,0),f.drawImage(c.canvas,4,3),t[r][l]=f.canvas}}for(var g in n){var p=n[g];for(var d in e.symbols){var m=e.symbols[d],v=an(m.width,m.height);v.drawImage(m,0,0);var y=e.base.getContext("2d").getImageData(0,0,16,16);z.replace(y,i.white,p[2]);var w=an(y.width,y.height);w.putImageData(y,0,0);var b=v.getImageData(0,0,m.width,m.height);z.replace(b,i.white,p[1]),v.putImageData(b,0,0),w.drawImage(v.canvas,4,4),z.replace(b,p[1],i.black),v.putImageData(b,0,0),w.drawImage(v.canvas,4,3),t.done[g][d]=w.canvas}}var k=e.base.getContext("2d").getImageData(0,0,16,16);z.replace(k,i.black,i.white);var x=an(k.width,k.height);return x.putImageData(k,0,0),t.flashing=x.canvas,t}(t.piece),ui:function(e){var y={symbols:e.symbols,swords:e.swords,cursor:(t=e.cursor,{player:[h(t,0,0,16,16),h(t,16,0,16,16)],enemy:[h(t,0,16,16,16),h(t,16,16,16,16)]}),typeface:function(e){for(var t=e.width/8,a=e.height/8,i={},n=0,r=0;r<a;r++)for(var o=0;o<t;o++){var l="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,.!?abcdefghijklmnopqrstuvwxyz;:'\"()/\\-     "[n++];i[l]=h(e,8*o,8*r,8,8)}return i}(e.typeface),healthbar:e.healthbar,phases:{player:e["player-phase"],enemy:e["enemy-phase"]},box:{topLeft:h(e.box,0,0,16,16),top:h(e.box,16,0,16,16),topRight:h(e.box,32,0,16,16),left:h(e.box,0,16,16,16),center:h(e.box,16,16,16,16),right:h(e.box,32,16,16,16),bottomLeft:h(e.box,0,32,16,16),bottom:h(e.box,16,32,16,16),bottomRight:h(e.box,32,32,16,16)},squares:{move:h(e.squares,0,0,16,16),attack:h(e.squares,16,0,16,16)},arrows:{player:{left:h(e.arrows,0,0,16,16),right:h(e.arrows,16,0,16,16),up:h(e.arrows,32,0,16,16),down:h(e.arrows,48,0,16,16),leftStub:h(e.arrows,0,16,16,16),rightStub:h(e.arrows,16,16,16,16),upStub:h(e.arrows,32,16,16,16),downStub:h(e.arrows,48,16,16,16),upLeft:h(e.arrows,0,32,16,16),upRight:h(e.arrows,16,32,16,16),downLeft:h(e.arrows,32,32,16,16),downRight:h(e.arrows,48,32,16,16),horiz:h(e.arrows,0,48,16,16),vert:h(e.arrows,16,48,16,16)},enemy:{left:h(e.arrows,0,64,16,16),right:h(e.arrows,16,64,16,16),up:h(e.arrows,32,64,16,16),down:h(e.arrows,48,64,16,16),leftStub:h(e.arrows,0,80,16,16),rightStub:h(e.arrows,16,80,16,16),upStub:h(e.arrows,32,80,16,16),downStub:h(e.arrows,48,80,16,16),upLeft:h(e.arrows,0,96,16,16),upRight:h(e.arrows,16,96,16,16),downLeft:h(e.arrows,32,96,16,16),downRight:h(e.arrows,48,96,16,16),horiz:h(e.arrows,0,112,16,16),vert:h(e.arrows,16,112,16,16)}}};var t;return y.Text=u,y.Box=f,y.TextBox=function(e){var t=0,a=0,i=null;if(Array.isArray(e)){i=e.map(function(e){return u(e)});var n=e.map(function(e){return e.width}),r=Math.max.apply(Math,_toConsumableArray(n));t=r,a=8*e.length}else i=u(e),t=i.width,a=8;var o=f(t+16,a+16),l=an(t,a);if(Array.isArray(e))for(var s=0;s<i.length;s++){var c=i[s];l.drawImage(c,0,8*s)}else l.drawImage(i,0,0);return l.canvas.width&&o.getContext("2d").drawImage(l.canvas,8,8),o},y.HealthBar=s,y.UnitDetails=function(e){var t=y.symbols[c[e.type]],a=u(e.name),i=f(a.width+t.width+20,24),n=i.getContext("2d");n.drawImage(t,8,8),n.drawImage(a,20,8);var r=f(84,24),o=s(e.hp/3,e.faction),l=u("HP");return(n=r.getContext("2d")).drawImage(l,8,8),n.drawImage(o,28,8),{name:i,hp:r}},y.Arrow=function(e,t){for(var a=[],i=0;i<e.length;i++){var n=_slicedToArray(e[i],2),r=n[0],o=n[1],l=!1,s=!1,c=!1,u=!1,f=e[i-1];if(f){var h=r-f[0],g=o-f[1];1===h?l=!0:-1===h&&(s=!0),1===g?c=!0:-1===g&&(u=!0)}var p=e[i+1];if(p){var d=p[0]-r,m=p[1]-o;-1===d?l=!0:1===d&&(s=!0),-1===m?c=!0:1===m&&(u=!0)}if(l||s||c||u){var v=null;l&&s?v="horiz":c&&u?v="vert":c&&l?v="upLeft":c&&s?v="upRight":u&&l?v="downLeft":u&&s?v="downRight":l&&!i?v="leftStub":s&&!i?v="rightStub":c&&!i?v="upStub":u&&!i?v="downStub":l?v="left":s?v="right":c?v="up":u&&(v="down"),v&&a.push({image:y.arrows[t][v],position:[r,o]})}}return a},y;function u(e){for(var t=0,a=0;a<e.length;a++){var i=e[a];t+=" "===i?4:8}var n=document.createElement("canvas");n.width=t,n.height=8;for(var r=n.getContext("2d"),o=0,l=0;o<e.length;o++){var s=e[o];if(" "===s)l+=4;else{var c=y.typeface[s];r.drawImage(c,l,0),l+=8}}return n}function f(e,t){var a=Math.ceil(e/16),i=Math.ceil(t/16),n=document.createElement("canvas"),r=n.getContext("2d");n.width=e,n.height=t;for(var o=1;o<a-1;o++)r.drawImage(y.box.top,16*o,0),r.drawImage(y.box.bottom,16*o,t-16);for(var l=1;l<i-1;l++)r.drawImage(y.box.left,0,16*l),r.drawImage(y.box.right,e-16,16*l);return r.fillRect(4,4,n.width-8,n.height-8),r.drawImage(y.box.topLeft,0,0),r.drawImage(y.box.topRight,n.width-16,0),r.drawImage(y.box.bottomLeft,0,n.height-16),r.drawImage(y.box.bottomRight,n.width-16,n.height-16),n}function s(e,t){var a=an(48,8);return a.drawImage(y.healthbar,0,0),a.fillStyle={player:"rgb(144, 224, 232)",enemy:"rgb(248, 192, 224)",ally:"rgb(200, 224, 255)"}[t],a.fillRect(3,3,Math.floor(42*e),2),a.canvas}}(t.ui),effects:function(){var e=an(1,1);e.fillStyle="white",e.fillRect(0,0,1,1);var t=an(2,2);return t.fillStyle="white",t.fillRect(0,0,2,2),{small:e.canvas,large:t.canvas}}()}}var t={name:"grass",solid:!1},i={name:"wall",solid:!0},n={name:"floor",solid:!1};"##########################      ##.......##      ##      ##.......##      ##      ##.......##      ##      ####...####      ##      ####...####      ##      ##.......##      ##    ####.......####    ##    ####.......####    ##    ...............    ##    ####.......####    ##    ####.......####    ##      ##.......##      ##      ###########      ##      ###########      ##                       ##                       ##      ##       ##      ##      ##       ##      ##########       ##################       #########                                                                                                    ".split("").map(function(e){switch(e){case" ":return t;case"#":return i;case".":return n}});var r={name:"grass",solid:!1},l={name:"floor",solid:!1},s={name:"wall",solid:!0},e={tiles:{grass:r,floor:l,wall:s},layout:{size:[20,20],data:["           #########","       ##  #......##"," #     ##  ##......#"," #         ##....###","        #   ###..###","        # #####...##","      ##  ###.#...# ","      ##  #.......# ","          ....##### ","#         ##..##### ","#    #    #####     ","     #     ####     ","                    ","                    ","        ##    #     ","        ##    #     "," #               ## "," ##    #         ## "," ##    #            ","                    "].join("").split("").map(function(e){switch(e){case" ":return r;case".":return l;case"#":return s}})},units:[["Hector","warrior","player",!1,[5,16]],["Oswin","knight","player",!1,[6,14]],["Erk","mage","player",!1,[4,13]],["Matthew","rogue","player",!1,[3,15]],["Nergal","mage","enemy","defend",[15,1]],["GOLEM","knight","enemy","wait",[13,2]],["GOLEM","knight","enemy","wait",[17,1]],["TROLL","knight","enemy","defend",[15,4]],["TROLL","knight","enemy","defend",[16,4]],["ORC","warrior","enemy","attack",[17,5]],["TROLL","knight","enemy","defend",[10,8]],["GOBLIN","rogue","enemy","attack",[8,6]],["ORC","warrior","enemy","attack",[5,8]],["TROLL","knight","enemy","attack",[2,6]],["GOBLIN","rogue","enemy","attack",[9,12]],["ORC","warrior","enemy","attack",[7,12]],["TROLL","knight","enemy","attack",[19,6]],["TROLL","knight","enemy","attack",[19,7]],["TROLL","knight","enemy","attack",[0,0]],["TROLL","knight","enemy","attack",[0,1]]]};function nn(e,t){return Math.abs(t[0]-e[0])+Math.abs(t[1]-e[1])}function u(e){return e[0]}function f(e){return e[1]}function rn(e,t){return u(e)===u(t)&&f(e)===f(t)}function on(e,t){t||(t=1);for(var a=[{steps:0,cell:e}],i=[];a.length;)for(var n=a.shift(),r=[[u(n.cell)-1,f(n.cell)],[u(n.cell)+1,f(n.cell)],[u(n.cell),f(n.cell)-1],[u(n.cell),f(n.cell)+1]],o=0;o<r.length;o++){var l=r[o];if(!rn(e,l)){for(var s=0;s<i.length;s++){if(rn(l,i[s]))break}s<i.length||(i.push(l),n.steps+1<t&&a.push({steps:n.steps+1,cell:l}))}}return i}function ln(e){return e.layout.size[0]}function sn(e){return e.layout.size[1]}function cn(e,t){return e.layout.data[f(t)*ln(e)+u(t)]}function un(e,t){for(var a=0;a<e.units.length;a++){var i=e.units[a];if(rn(t,i.cell))return i}}function g(e,t){return 0<=u(t)&&u(t)<ln(e)&&0<=f(t)&&f(t)<sn(e)}function fn(e,t){var a={move:[t.cell],attack:[]},i=dn(t),n=[{steps:0,cell:t.cell}];for(i||(n.length=0);n.length;)for(var r=n.shift(),o=on(r.cell),l=0;l<o.length;l++){if(g(e,c=o[l])&&!cn(e,c).solid){for(var s=0;s<a.move.length&&!rn(c,a.move[s]);s++);if(!(s<a.move.length)){if((u=un(e,c))||a.move.push(c),u&&!hn(t,u)){for(s=0;s<a.attack.length&&!rn(a.attack[s],c);s++);s===a.attack.length&&a.attack.push(c)}r.steps<i-1&&(!u||hn(t,u))&&n.push({steps:r.steps+1,cell:c})}}}for(l=0;l<a.move.length;l++)for(o=on(a.move[l],t.equipment.weapon.rng),s=0;s<o.length;s++){var c,u;if(g(e,c=o[s])&&!cn(e,c).solid&&!rn(t.cell,c))if(!(u=un(e,c))||!hn(t,u)){for(var f=0;f<a.attack.length&&!rn(a.attack[f],c);f++);f===a.attack.length&&a.attack.push(c)}}return a}function hn(e,t){return e.faction===t.faction||"player"===e.faction&&"ally"===t.faction||"ally"===e.faction&&"player"===t.faction}function O(e,t,a){e.cell=t}function gn(e,t){var a=pn(e,t);return a&&(t.hp-=Math.min(t.hp,a)),a}function pn(e,t){var a,i,n,r;if((r=(n=e).equipment.weapon,n.stats.agi+(r?r.acc:0)-(i=(a=t).equipment.armor,a.stats.agi-(i?i.wt:0)))<0)return null;if("warrior"===e.type)switch(t.type){case"warrior":case"knight":return 2;case"rogue":return 0;case"mage":return 3}else if("knight"===e.type)switch(t.type){case"warrior":return 2;case"knight":return 1;case"rogue":case"mage":return 2}else if("rogue"===e.type)switch(t.type){case"warrior":return 2;case"knight":return 0;case"rogue":return 1;case"mage":return 2}else if("mage"===e.type)switch(t.type){case"warrior":return 2;case"knight":case"rogue":case"mage":return 1}}function H(e){return e.equipment.weapon.rng}function dn(e){if("defend"===e.ai)return 0;var t=e.equipment.armor;return 5-(t?t.wt:0)+Math.floor(e.stats.agi/2)}var p={warrior:{str:2,int:0,agi:1},knight:{str:1,int:0,agi:0},rogue:{str:1,int:1,agi:2},mage:{str:1,int:1,agi:1}},d={axe:{target:"str",atk:2,acc:0,rng:1},lance:{target:"str",atk:3,acc:2,rng:1},dagger:{target:"str",atk:2,acc:1,rng:1},tome:{target:"int",atk:1,acc:1,rng:2}},m={warrior:{weapon:d.axe,armor:null},knight:{weapon:d.lance,armor:{def:2,wt:1}},rogue:{weapon:d.dagger,armor:null},mage:{weapon:d.tome,armor:null}};function mn(e,t){var a=e.phase.pending,i=a.indexOf(t);return-1!==i&&(a.splice(i,1),a.length||vn(e),!0)}function vn(e){var t=e.map,a=e.phase;a.faction="player"===a.faction?"enemy":"player",a.pending=t.units.filter(function(e){return e.faction===a.faction}),a.pending.length||vn(e)}function yn(e,t){return{options:e,index:t||0,done:!1}}function U(e,t){t?--e.index<0&&(e.index=e.options.length-1):++e.index>=e.options.length&&(e.index=0)}function wn(e,t,a){for(var i=[],n=[t],r={},o={},l={},s={},c={},u=0;u<e.length;u++){s[h=e[u]]=1/0,c[h]=1/0}for(s[t]=0,c[t]=nn(t,a);n.length;){var f={score:1/0,index:-1,cell:null};for(u=0;u<n.length;u++){(m=c[h=n[u]])<f.score&&(f.score=m,f.index=u,f.cell=h)}var h;if(rn(h=f.cell,a)){for(;!rn(h,t);)i.unshift(h),h=l[h];return i.unshift(h),i}n.splice(f.index,1),r[h]=!1,o[h]=!0;var g=on(h);for(u=0;u<g.length;u++){var p=g[u];if(!o[p]){for(var d=0;d<e.length;d++){if(rn(e[d],p))break}var m;if(d!==e.length)r[p]||(r[p]=!0,n.push(p)),(m=s[h]+1)>=s[p]||(l[p]=h,s[p]=m,c[p]=m+nn(p,a))}}}}function v(){return{height:0,time:0,floating:!1}}v.update=function(e){if(!e.done){var t=e.data;if(t.time++,e.floating){var a=t.time%120/120;t.height=4+Math.sin(2*Math.PI*a)}else 4==++t.height&&(e.floating=!0)}};var y=Object.freeze({default:v});function w(e){return{height:Math.round(e||4)}}w.update=function(e){e.done||--e.data.height||(e.done=!0)};var b=Object.freeze({default:w});function k(e){return{path:e,cell:e[0].slice(),time:0}}k.update=function(e){if(e.done)return!1;var t=e.data,a=Math.floor(t.time/4),i=t.time%4*.25,n=t.path[a],r=t.path[a+1];return r?t.cell=[n[0]+(r[0]-n[0])*i,n[1]+(r[1]-n[1])*i]:(t.cell=n.slice(),e.done=!0),t.time++,!0};var x=Object.freeze({default:k});function M(e,t){var a=[t[0]-e[0],t[1]-e[1]],i=Math.sqrt(a[0]*a[0]+a[1]*a[1]);return{src:e,norm:[a[0]/i,a[1]/i],cell:e.slice(),time:0,connected:!1}}M.update=function(e){if(!e.done){var t=e.data,a=t.time<=7?t.time:7-(t.time-7);8<=t.time&&(t.connected=!0),t.cell[0]=t.src[0]+t.norm[0]/8*a,t.cell[1]=t.src[1]+t.norm[1]/8*a,15==++t.time&&(e.done=!0)}};var I=Object.freeze({default:M});function S(){return{time:0,flashing:!1}}S.update=function(e){if(!e.done){var t=e.data;t.flashing=!t.flashing,15==++t.time&&(e.done=!0)}};var q=Object.freeze({default:S});function A(){return{time:0,visible:!0}}A.update=function(e){if(!e.done){var t=e.data;t.visible=!t.visible,30==++t.time&&(e.done=!0)}};var L=Object.freeze({default:A});function R(){return{time:0,state:"enter",text:{x:0},bg:{x:0,width:0,height:0}}}R.update=function(e){if(!e.done){var t=e.data,a=t.time,i=t.text,n=t.bg;if(10<a&&a<=25){t.state="enter";var r=(a-10)/15,o=Math.sin(Math.PI/2*r);i.x=o}else if(25<a&&a<=40)t.state="pass",i.x=(a-25)/15;else if(40<a&&a<=55){t.state="exit";var l=(a-40)/15,s=1-Math.sin(Math.PI/2+Math.PI/2*l);i.x=s}if(a<=40){if(n.width<1)n.width+=1/16;else if(n.height<1){var c=(a-16)/8,u=Math.sin(Math.PI/2*c);n.height=u}}else 0<n.height?n.height-=1/8:n.x<1&&(n.x+=1/16);65==++t.time&&(e.done=!0)}};var C=Object.freeze({default:R}),bn={lift:y&&v||y,drop:b&&w||b,move:x&&k||x,attack:I&&M||I,flinch:q&&S||q,fade:L&&A||L,phase:C&&R||C};function kn(e,t,a){return{type:e,target:t,data:a,done:!1}}var xn="rgb(80, 120, 248)",zn="rgb(208, 0, 88)",Mn={warrior:"axe",knight:"shield",rogue:"dagger",mage:"hat"};function F(e,t){var a=e.context,i=e.sprites,n=e.cache,r=e.state,o=r.time,l=r.cursor,s=r.viewport,c=r.anims,u=r.attacks,f=r.dialogs,h=r.log,g=r.ai,p=t.map,d=a.canvas,m=c[0],v=u[0],y=f[0],w=["floors","squares","shadows","walls","pieces","arrows","cursor","selection","effects","ui"],b={},k=!0,x=!1,z=void 0;try{for(var M,I=w[Symbol.iterator]();!(k=(M=I.next()).done);k=!0){b[M.value]=[]}}catch(e){x=!0,z=e}finally{try{!k&&I.return&&I.return()}finally{if(x)throw z}}if(a.beginPath(),a.fillStyle="black",a.fillRect(0,0,d.width,d.height),n.units||(n.units=p.units.map(function(e){return Object.assign({original:e},e)})),n.map||(n.map=function(e,t){for(var a=ln(e),i=sn(e),n=an(16*a,16*i),r=an(16*a,16*i),o=0;o<i;o++)for(var l=0;l<a;l++){var s=16*l,c=16*o,u=cn(e,[l,o]),f=null;if("wall"===u.name)f=o+1<i&&"wall"!==cn(e,[l,o+1]).name?t["wall-base"]:t.wall,r.drawImage(f,s,c);else{var h=null;0<=l-1&&"wall"===cn(e,[l-1,o]).name&&0<=o-1&&"wall"!==cn(e,[l-1,o-1]).name?h=t["shadow-corner"]:0<=l-1&&"wall"===cn(e,[l-1,o]).name&&(h=t["shadow-edge"]),f=t[u.name],n.drawImage(f,s,c),h&&n.drawImage(h,s,c)}}return{floors:n.canvas,walls:r.canvas}}(p,i.tiles)),b.floors.push({image:n.map.floors,position:[0,0]}),b.walls.push({image:n.map.walls,position:[0,0]}),!l.cell){var S=p.units.find(function(e){return"player"===e.faction});l.cell=S.cell.slice(),l.prev=l.cell.slice()}if(!n.log){var O=i.ui.Box(s.size[0]-16,36),q={image:O,position:[8,s.size[1]]};n.log={row:0,col:0,focus:0,time:0,interrupt:!0,bookmark:0,box:q,texts:[],surface:an(O.width-16,O.height-16)}}var A=p.units.filter(function(e){return"enemy"===e.faction}),L=g.strategy?A[g.index]:null,R=y&&"actions"===y.type&&y,C=y&&"forecast"===y.type&&y,T=y&&"pause"===y.type&&y,D=!h.length||n.log.row===h.length-1&&n.log.col===h[h.length-1].length-1,E=(!D||!n.log.interrupt&&n.log.time<300)&&(v||!n.log.interrupt&&.001<!nn(l.cell,l.prev))&&!T;if(E){var j=n.log,B=j.box,N=j.surface;n.log.interrupt&&(n.log.interrupt=!1,n.log.time=0,B.image.getContext("2d").fillRect(8,8,B.image.width-16,B.image.height-16));var P=s.size[1]-B.image.height-8;if(B.position[1]+=(P-B.position[1])/8,Math.abs(P-B.position[1])<4){n.log.focus<n.log.row&&2<=n.log.row&&n.log.row<h.length&&(n.log.focus+=(n.log.row-n.log.focus)/8);var _=h[n.log.row].slice(0,n.log.col+1),U=i.ui.Text(_);n.log.texts[n.log.row]=U,N.canvas.height=Math.max(0,12*(h.length-n.log.bookmark)-4);n.log.row,n.log.bookmark;for(var F=n.log.bookmark;F<=n.log.row;F++){var G=n.log.texts[F];N.drawImage(G,0,12*(F-n.log.bookmark))}var K=an(B.image.width-16,B.image.height-16),H=Math.max(0,12*(n.log.focus-n.log.bookmark-1));K.drawImage(n.log.surface.canvas,0,-Math.ceil(H));var J=B.image.getContext("2d");J.fillRect(8,8,B.image.width-16,B.image.height-16),J.drawImage(K.canvas,8,8),n.log.col!==h[n.log.row].length-1?n.log.col++:n.log.row!==h.length-1?(n.log.row++,n.log.col=0):n.log.time++}b.ui.push(B)}else{n.log.interrupt||(n.log.interrupt=!0,n.log.bookmark=n.log.row+1);var V=n.log.box,W=s.size[1]+V.image.height;V.position[1]<W&&(V.position[1]+=Math.min(8,W-V.position[1]),b.ui.push(V))}(c.length||v||!D)&&n.phase.pending||(n.phase.faction!==t.phase.faction&&(l.cell=t.phase.pending[0].cell.slice(),m=c[0]=kn("phase",t.phase.faction,bn.phase())),n.phase={pending:t.phase.pending.slice(),faction:t.phase.faction,done:!1});var Q=m&&"phase"===m.type,X=null;if(!Q||!s.target)if(v)X=v.target.cell;else if("enemy"===t.phase.faction&&L)X=L.cell;else if(C&&!n.moved){X=y.options[y.index].cell}else l.selection&&t.phase.pending.includes(l.selection.unit)&&!n.moved?l.selection&&t.phase.pending.includes(l.selection.unit)&&(X=l.selection.unit.cell):X=l.cell;s.target||(s.target=[]);var Y=16*ln(p);Y>s.size[0]?X&&(s.target[0]=16*X[0]+8-s.size[0]/2):s.target[0]=Y/2-s.size[0]/2;var Z=16*sn(p);if(Z>s.size[1]?X&&(s.target[1]=16*X[1]+8-s.size[1]/2):s.target[1]=Z/2-s.size[1]/2,!(!Q&&(C||v||"enemy"===n.phase.faction))){var $=Y-s.size[0];Y>s.size[0]&&(s.target[0]<0?s.target[0]=0:s.target[0]>$&&(s.target[0]=$));var ee=Z-s.size[1];Z>s.size[1]&&(s.target[1]<0?s.target[1]=0:s.target[1]>ee&&(s.target[1]=ee))}if(s.position?(s.position[0]+=(s.target[0]-s.position[0])/16,s.position[1]+=(s.target[1]-s.position[1])/16):s.position=s.target.slice(),n.attack&&n.attack.connected&&1===n.attack.time&&(s.shake=30),s.shake){s.shake--;var te=v.power,ae=1-s.shake%5/5,ie=v.attacker.cell[1]-v.target.cell[1]?1:0;s.offset[ie]=Math.sin(2*ae*Math.PI)*te*s.shake/30}else s.offset[0]=0,s.offset[1]=0;var ne=l.selection||n.selection;if(ne&&"enemy"!==n.phase.faction){var re=ne.unit,oe=ne.time,le=p.units.indexOf(re),se=n.units[le],ce=n.ranges[le];ce||(ce=n.ranges[le]=fn(p,re));var ue=n.squares[le];if(!ue){var fe=!0,he=!(n.squares[le]=ue=[]),ge=void 0;try{for(var pe,de=ce.move[Symbol.iterator]();!(fe=(pe=de.next()).done);fe=!0){var me=pe.value;ue.push({sprite:i.ui.squares.move,cell:me})}}catch(e){he=!0,ge=e}finally{try{!fe&&de.return&&de.return()}finally{if(he)throw ge}}var ve=!0,ye=!1,we=void 0;try{for(var be,ke=ce.attack[Symbol.iterator]();!(ve=(be=ke.next()).done);ve=!0){var xe=be.value,ze=!0,Me=!0,Ie=!1,Se=void 0;try{for(var Oe,qe=ce.move[Symbol.iterator]();!(Me=(Oe=qe.next()).done);Me=!0){if(rn(xe,Oe.value)){ze=!1;break}}}catch(e){Ie=!0,Se=e}finally{try{!Me&&qe.return&&qe.return()}finally{if(Ie)throw Se}}ze&&ue.push({sprite:i.ui.squares.attack,cell:xe})}}catch(e){ye=!0,we=e}finally{try{!ve&&ke.return&&ke.return()}finally{if(ye)throw we}}}l.selection&&n.selection!==l.selection&&(n.selection=ne,n.path=null),l.selection&&!c.find(function(e){return e.target===se})&&c.push(kn("lift",se,bn.lift())),n.selection&&n.selection!==l.selection&&(n.moved=!1,m&&"lift"===m.type&&(m.done=!0,c.push(kn("drop",m.target,bn.drop(m.data.height))),n.selection.time=0));var Ae=m&&"move"===m.type&&m.target===se,Le=m&&"attack"===m.type&&m.target===se;if(!n.moved){var Re=0;if(l.selection)Re=ne.time;else{var Ce=0,Te=!0,De=!1,Ee=void 0;try{for(var je,Be=ue[Symbol.iterator]();!(Te=(je=Be.next()).done);Te=!0){var Ne=je.value,Pe=nn(re.cell,Ne.cell);Ce<Pe&&(Ce=Pe)}}catch(e){De=!0,Ee=e}finally{try{!Te&&Be.return&&Be.return()}finally{if(De)throw Ee}}Re=Math.max(0,Ce-ne.time)}Re&&(ue=ue.filter(function(e){return nn(re.cell,e.cell)<=Re}),function(e,t,a){var i=!0,n=!1,r=void 0;try{for(var o,l=a[Symbol.iterator]();!(i=(o=l.next()).done);i=!0){var s=o.value,c=s.sprite,u=16*s.cell[0],f=16*s.cell[1];e.squares.push({image:c,position:[u,f]})}}catch(e){n=!0,r=e}finally{try{!i&&l.return&&l.return()}finally{if(n)throw r}}}(b,i.ui.squares,ue))}var _e=n.path,Ue=un(p,l.cell);if(rn(l.cell,re.cell))_e&&(_e.length=1);else if(t.phase.pending.includes(re)&&l.selection){var Fe=ce.move.slice(),Ge=p.units.filter(function(e){return hn(re,e)}),Ke=!0,He=!1,Je=void 0;try{for(var Ve,We=Ge[Symbol.iterator]();!(Ke=(Ve=We.next()).done);Ke=!0){var Qe=Ve.value;Fe.push(Qe.cell)}}catch(e){He=!0,Je=e}finally{try{!Ke&&We.return&&We.return()}finally{if(He)throw Je}}var Xe=re.cell;if(_e&&_e.length&&(Xe=_e[_e.length-1]),ce.move.find(function(e){return rn(l.cell,e)}))if(_e){for(var Ye=0;Ye<_e.length;Ye++){var Ze=_e[Ye];if(rn(l.cell,Ze))break}if(Ye<_e.length-1)_e.splice(Ye+1,_e.length-Ye-1);else{var $e,et=wn(Fe.filter(function(t){return!_e.find(function(e){return rn(t,e)})}),_e[_e.length-1],l.cell);if(et&&_e.length+et.length-2<=dn(re))et.shift(),($e=_e).push.apply($e,_toConsumableArray(et));else _e=n.path=wn(Fe,re.cell,l.cell)}}else _e=n.path=wn(Fe,re.cell,l.cell);else if(Ue&&!hn(re,Ue)&&nn(Xe,Ue.cell)>re.equipment.weapon.rng){var tt=on(Ue.cell,re.equipment.weapon.rng);if(_e){var at=function(){var t=_e[Ye];if(Ue&&tt.find(function(e){return rn(t,e)}))return _e.splice(Ye+1,_e.length-Ye-1),"break"};for(Ye=_e.length;Ye--;){if("break"===at())break}}if(!_e||-1===Ye){for(var it=null,nt=function(e){var t=ce.move[e];if(tt.find(function(e){return rn(t,e)}))return it=t,"break"},rt=0;rt<ce.move.length;rt++){if("break"===nt(rt))break}_e=n.path=wn(Fe,re.cell,it)}}}if(_e&&(l.selection&&!n.moved||Ae&&oe%2)){var ot,lt=i.ui.Arrow(_e,n.phase.faction);(ot=b.arrows).push.apply(ot,_toConsumableArray(lt.map(function(e){return{image:e.image,position:[16*e.position[0],16*e.position[1]]}})))}if(n.moved&&!Ae&&!Le&&!f.length){var st=null,ct=on(se.cell,se.equipment.weapon.rng),ut=[],ft=!0,ht=!1,gt=void 0;try{for(var pt,dt=ct[Symbol.iterator]();!(ft=(pt=dt.next()).done);ft=!0){var mt=un(p,pt.value);mt&&!hn(re,mt)&&ut.push(mt)}}catch(e){ht=!0,gt=e}finally{try{!ft&&dt.return&&dt.return()}finally{if(ht)throw gt}}if(st=(n.enemies=ut).length?["attack","wait"]:["wait"],f.push({type:"actions",menu:yn(st)}),n.target){var vt=n.target.unit,yt=ut.indexOf(vt);f.unshift({type:"forecast",menu:yn(ut,yt)}),l.cell=vt.cell.slice(),l.prev=vt.cell.slice()}}}if(e.state.paused)if(f.length){var wt=T.menu;if(wt.done)"end turn"===wt.options[wt.index]&&vn(t),e.state.paused=!1,f.shift()}else f.push({type:"pause",menu:yn(["end turn"])});var bt=16*l.cell[1]+8-s.target[1]>=s.size[1]/2,kt=l.selection||v&&n.selected||l.under,xt=n.dialogs.selection;if(!kt||n.selected&&kt!==n.selected||Q||T||C&&xt&&8===xt.name.position[1]||xt&&!C&&!v&&(bt&&!C&&xt&&8!==xt.name.position[1]||!bt&&xt&&8===xt.name.position[1])){if(n.selected){n.selected.unit;var zt=n.dialogs.selection;if(zt){var Mt=zt.name,It=zt.hp;Mt.position[0]>-Mt.image.width||It.position[0]>-It.image.width?(Mt.position[0]-=16,It.position[0]-=16):(n.dialogs.selection=null,n.selected=null),b.ui.push(Mt,It)}}}else{n.selected||(n.selected=kt);var St=kt.unit,Ot=t.map.units.indexOf(St),qt=n.units[Ot];if(!n.dialogs.selection){var At=s.size[1]-68;bt&&!C&&(At=0);var Lt=i.ui.UnitDetails(qt);n.dialogs.selection={name:{image:Lt.name,position:[-Lt.name.width,At+8]},hp:{image:Lt.hp,position:[-Lt.hp.width,At+36]}}}var Rt=n.dialogs.selection,Ct=Rt.name,Tt=Rt.hp,Dt=0,Et=0;v||E?Dt=(Et=s.size[1]-4-36-4-Tt.image.height-4)-4-Ct.image.height:bt&&!C||(Dt=(Et=s.size[1]-4-Tt.image.height-4)-4-Ct.image.height),(v||!bt||C)&&(Ct.position[1]+=(Dt-Ct.position[1])/8,Tt.position[1]+=(Et-Tt.position[1])/8),kt&&(12<=kt.time&&(Ct.position[0]+=(8-Ct.position[0])/8),16<=kt.time&&(Tt.position[0]+=(8-Tt.position[0])/8)),b.ui.push(Ct,Tt)}var jt=null,Bt=n.dialogs.target;if(C){var Nt=C.menu;jt=Nt.options[Nt.index],jt=n.target?n.target.unit!==jt?{unit:jt,time:0}:n.target:n.target={unit:jt,time:0},l.cell=jt.unit.cell.slice()}else v?jt=n.target:l.selection&&"enemy"!==n.phase.faction&&l.under&&l.selection!==l.under&&!hn(l.selection.unit,l.under.unit)&&(jt=l.under);if(!jt||n.target&&jt!==n.target||R||Q||C&&Bt&&8===Bt.name.position[1]){if(n.target){n.target.unit;var Pt=n.dialogs.target;if(Pt){var _t=Pt.name,Ut=Pt.hp;_t.position[0]<s.size[0]||Ut.position[0]<s.size[0]?(_t.position[0]+=16,Ut.position[0]+=16):(n.dialogs.target=null,n.target=null),b.ui.push(_t,Ut)}}}else{n.target||(n.target=jt);var Ft=jt.unit;if(!n.dialogs.target){var Gt=s.size[1]-68;bt&&!C&&(Gt=0);var Kt=i.ui.UnitDetails(Ft);n.dialogs.target={name:{image:Kt.name,position:[s.size[0],Gt+8]},hp:{image:Kt.hp,position:[s.size[0],Gt+36]}}}var Ht=n.dialogs.target,Jt=Ht.name,Vt=Ht.hp,Wt=0,Qt=0;if(v||E?Wt=(Qt=s.size[1]-8-36-4-Vt.image.height)-4-Jt.image.height:bt&&!C||(Wt=(Qt=s.size[1]-8-Vt.image.height)-4-Jt.image.height),(v||!bt||C)&&(Jt.position[1]+=(Wt-Jt.position[1])/8,Vt.position[1]+=(Qt-Vt.position[1])/8),jt){if(12<=jt.time){var Xt=s.size[0]-8-Jt.image.width;Jt.position[0]+=(Xt-Jt.position[0])/8}if(16<=jt.time){var Yt=s.size[0]-8-Vt.image.width;Vt.position[0]+=(Yt-Vt.position[0])/8}}b.ui.push(Jt,Vt)}if(v&&!Q){var Zt=v.attacker,$t=v.target,ea=v.power,ta=v.damage,aa=p.units.indexOf(Zt),ia=n.units[aa];if(n.attack){if(n.attack.countdown&&!--n.attack.countdown){var na=kn("attack",ia,bn.attack(Zt.cell,$t.cell));c.push(na),n.attack.normal=na.data.norm}}else{if(n.attack={countdown:7,time:0,connected:!1,normal:null},"player"===n.phase.faction&&"player"===Zt.faction){var ra=kn("drop",ia,bn.drop());c.push(ra)}v.counter?h.push(Zt.name+" counters -"):h.push(Zt.name+" attacks")}if(m&&"attack"===m.type&&m.data.connected&&!n.attack.connected)if(n.attack.connected=!0,null===ea){var oa="player"===$t.faction?".":"!";h.push($t.name+" dodges the attack"+oa)}else if(0===ea){var la="player"===$t.faction?".":"!";h.push($t.name+" blocks the attack"+la)}else{var sa=3===ta?"!!":".";h.push($t.name+" suffers "+ta+" damage"+sa)}if(n.attack&&n.attack.connected){var ca=n.attack.time;if(45<=ca&&!$t.hp&&p.units.includes($t)){var ua=p.units.indexOf($t);p.units.splice(ua,1),"player"===$t.faction?h.push($t.name+" is defeated."):"enemy"===$t.faction&&h.push("Defeated "+$t.name+".")}var fa=v.counter?n.dialogs.selection:n.dialogs.target;if(fa){var ha=fa.hp.image.getContext("2d"),ga=0;2*ca<=14*ta?(ga=Math.min(14*ta,2*ca),ha.fillStyle=zn):(ga=ca-14*ta,ha.fillStyle="black"),0<ga&&ga<=14*ta&&ha.fillRect(31+14*($t.hp+ta)-ga,11,ga,2)}if(60<=ca&&$t.hp||75<=ca){if(u.shift(),n.attack=null,$t.hp){var pa=t.map.units.indexOf($t);n.units[pa].hp=$t.hp}v.counter||"player"!==n.phase.faction||(mn(t,Zt),l.cell=Zt.cell.slice(),l.prev=Zt.cell.slice())}else{if(1===ca)for(var da=[$t.cell[0]-Zt.cell[0],$t.cell[1]-Zt.cell[1]],ma=Math.sqrt(da[0]*da[0]+da[1]*da[1]),va=[da[0]/ma,da[1]/ma],ya=Math.atan2(da[1],da[0]),wa=[16*$t.cell[0]+8-4*va[0],16*$t.cell[1]+8-4*va[1]],ba=ta/3*48,ka=0;ka<ba;ka++){var xa="small";Math.random()<.25&&(xa="large");var za=i.effects[xa],Ma=ya+1*Math.random()-.5,Ia=[-Math.cos(Ma)*Math.random()*2,-Math.sin(Ma)*Math.random()*2];n.particles.push({position:wa.slice(),velocity:Ia,image:za,time:0})}if(ca<=45){var Sa=n.attack.value;if(Sa)Sa.offset+=Sa.velocity,Sa.velocity+=.25,0<Sa.offset&&(Sa.offset=0,Sa.velocity*=-1/3);else{var Oa=null;Oa=null===ea?"MISS":0===ea?"0":3===ea?"3!!":ea.toString(),Sa=n.attack.value={offset:0,velocity:-2,image:i.ui.Text(Oa)}}b.effects.push({image:Sa.image,position:[16*$t.cell[0]+8-Sa.image.width/2,16*$t.cell[1]-12+Sa.offset]})}}}}for(var qa=n.particles,Aa=0;Aa<qa.length;Aa++){var La=qa[Aa];La.time++,La.position[0]+=La.velocity[0],La.position[1]+=La.velocity[1],La.velocity[0]*=.875,La.velocity[1]*=.875;var Ra=Math.random();b.effects.push(La),Ra<La.time/240&&qa.splice(Aa--,1)}if(R){var Ca=R.menu;if(Ca.done){var Ta=Ca.options[Ca.index];if("wait"===Ta){var Da=l.selection.unit,Ea=p.units.indexOf(Da),ja=n.units[Ea];Da.cell=ja.cell,l.selection=null,n.selection=null,n.squares.length=0,n.ranges.length=0,n.moved=!1,m.done=!0,c.push(kn("drop",m.target,bn.drop(m.data.height))),mn(t,Da),l.cell=Da.cell.slice(),l.prev=Da.cell.slice(),f.shift()}else"attack"===Ta&&f.unshift({type:"forecast",menu:yn(n.enemies)})}}var Ba=e.state.menu;if(T||R||C&&1<C.menu.options.length){var Na=null;T?Na=T.menu:C?Na=C.menu:R&&(Na=R.menu),Ba||(Ba=e.state.menu={data:Na,box:{size:[0,0],targetSize:null,element:{image:null,position:[144,48]}},cursor:null});var Pa=Ba.box;if(Ba.data!==Na||!Pa.targetSize){n.menu.labels.length=0,Ba.cursor=null;var _a=(Ba.data=Na).options;C&&(_a=_a.map(function(e){return e.name}));var Ua=null,Fa=!0,Ga=!1,Ka=void 0;try{for(var Ha,Ja=_a[Symbol.iterator]();!(Fa=(Ha=Ja.next()).done);Fa=!0){var Va=Ha.value,Wa=C?Va:Va.toUpperCase(),Qa=i.ui.Text(Wa);(!Ua||Qa.width>Ua.width)&&(Ua=Qa),n.menu.labels.push(Qa)}}catch(e){Ga=!0,Ka=e}finally{try{!Fa&&Ja.return&&Ja.return()}finally{if(Ga)throw Ka}}Pa.size=[0,0],Pa.targetSize=[Ua.width+36,16*Ba.data.options.length+16]}Pa.size[0]+=(Pa.targetSize[0]-Pa.size[0])/4,Pa.size[1]+=(Pa.targetSize[1]-Pa.size[1])/4}else if(Ba){var Xa=Ba.box;Xa.size[0]&&(Xa.size[0]-=Math.min(Xa.size[0],Xa.targetSize[0]/5),Xa.size[1]-=Math.min(Xa.size[1],Xa.targetSize[1]/5))}if(Ba){var Ya=Ba.box;if(Ya.size[0]&&Ya.size[1]){var Za,$a=Ya.targetSize[0]-Ya.size[0];if(Ya.element.image=(Za=i.ui).Box.apply(Za,_toConsumableArray(Ya.size.map(Math.round))),n.menu.box=Ya.element.image,$a<4){for(var ei=Ya.element.image.getContext("2d"),ti=0;ti<n.menu.labels.length;ti++){var ai=n.menu.labels[ti];ei.drawImage(ai,24,12+16*ti)}var ii=null,ni=Ba.data.options[Ba.data.index];if("attack"===ni?ii=i.ui.symbols.sword:"wait"===ni?ii=i.ui.symbols.clock:"end turn"===ni?ii=i.ui.symbols.next:C&&(ii=i.ui.symbols.sword),ii){var ri=o%180/180,oi=Math.sin(2*Math.PI*ri*2),li=12+16*Ba.data.index-oi;null===Ba.cursor?Ba.cursor=li:Ba.cursor+=(li-Ba.cursor)/2,ei.drawImage(ii,12,Ba.cursor)}}b.ui.push(Ya.element)}}if(C){var si=C.menu,ci=si.options[si.index];if(!n.dialogs.forecast){var ui=i.ui.Text("COMBAT FORECAST"),fi=i.ui.Box(ui.width+28,24),hi=fi.getContext("2d"),gi=i.ui.symbols.eye;hi.drawImage(gi,8,8),hi.drawImage(ui,20,8),n.dialogs.forecast={title:{image:fi,position:[-fi.width,8]}}}var pi=n.dialogs.forecast.title;pi.position[0]+=(8-pi.position[0])/8,b.ui.push(pi);var di=l.selection.unit,mi=p.units.indexOf(di),vi=e.cache.units[mi],yi=on(vi.cell,di.equipment.weapon.rng),wi=!0,bi=!1,ki=void 0;try{for(var xi,zi=yi[Symbol.iterator]();!(wi=(xi=zi.next()).done);wi=!0){var Mi=xi.value;b.squares.push({image:i.ui.squares.attack,position:[16*Mi[0],16*Mi[1]]})}}catch(e){bi=!0,ki=e}finally{try{!wi&&zi.return&&zi.return()}finally{if(bi)throw ki}}void 0===y.time?y.time=0:y.time++;var Ii=Math.floor(14),Si=255*Math.sin(y.time%60/60*Math.PI),Oi=nn(vi.cell,ci.cell),qi=!1,Ai=n.dialogs.target;if(Ai){var Li=Math.min(ci.hp,Oi<=di.equipment.weapon.rng?Number(pn(di,ci)):0);if(Li){ci.hp-Li<=0&&(qi=!0);var Ri=an(Li*Ii,2);Ri.fillStyle="rgb("+Si+", "+Si+", "+Si+")",Ri.fillRect(0,0,Ri.canvas.width,Ri.canvas.height),b.ui.push({image:Ri.canvas,position:[Ai.hp.position[0]+31+(ci.hp-Li)*Ii,Ai.hp.position[1]+11]})}}if(!qi){var Ci=n.dialogs.selection;if(Ci){var Ti=Math.min(di.hp,Oi<=ci.equipment.weapon.rng?Number(pn(ci,di)):0);if(Ti){var Di=an(Ti*Ii,2);Di.fillStyle="rgb("+Si+", "+Si+", "+Si+")",Di.fillRect(0,0,Di.canvas.width,Di.canvas.height),b.ui.push({image:Di.canvas,position:[Ci.hp.position[0]+31+(di.hp-Ti)*Ii,Ci.hp.position[1]+11]})}}}if(si.done){di.cell=vi.cell;var Ei=pn(di,ci),ji=Math.min(ci.hp,Number(Ei));if(gn(di,ci),u.push({attacker:di,target:ci,power:Ei,damage:ji}),!qi&&Oi<=ci.equipment.weapon.rng){var Bi=pn(ci,di),Ni=Math.min(di.hp,Number(Bi));gn(ci,di),u.push({attacker:ci,target:di,power:Bi,damage:Ni,counter:!0})}n.squares.length=0,n.ranges.length=0,n.moved=!1,l.selection=null,n.selection=null,f.length=0,m.done=!0}}else{var Pi=n.dialogs.forecast;if(Pi){var _i=Pi.title;_i.position[0]>-_i.image.width?(_i.position[0]-=Math.max(16,-_i.image.width-_i.position[0]),b.ui.push(_i)):n.dialogs.forecast=null}}var Ui=n.dialogs.objective;if(!Ui){var Fi=i.ui.TextBox("OBJECTIVE"),Gi=i.ui.TextBox("Defeat Nergal");Ui=n.dialogs.objective={lastUpdate:null,time:0,title:{image:Fi,position:[s.size[0],s.size[1]-Fi.height-36]},body:{image:Gi,position:[s.size[0],s.size[1]-Gi.height-8]}}}p.units.length!==Ui.lastUpdate&&(Ui.body.image=i.ui.TextBox("Defeat Nergal"),Ui.lastUpdate=A.length);var Ki=Ui,Hi=Ki.title,Ji=Ki.body;l.selection||l.under||n.attack||T||!(nn(l.cell,l.prev)<.001)||bt!==(8===Hi.position[1])&&(Hi.position[0]!==s.size[0]||Ji.position[0]!==s.size[0])?Ui.time=0:Ui.time||(Ui.time=1);if(Ui.time&&(Hi.position[0]===s.size[0]&&(bt?(Hi.position[1]=8,Ji.position[1]=36):(Hi.position[1]=s.size[1]-Hi.image.height-36,Ji.position[1]=s.size[1]-Ji.image.height-8)),150<=++Ui.time&&(Hi.position[0]+=(s.size[0]-Hi.image.width-8-Hi.position[0])/8),154<=Ui.time&&(Ji.position[0]+=(s.size[0]-Ji.image.width-8-Ji.position[0])/8)),Ui.time<150&&(Hi.position[0]<s.size[0]||Ji.position[0]<s.size[0])&&(Hi.position[0]+=Math.min(16,s.size[0]-Hi.position[0]),Ji.position[0]+=Math.min(16,s.size[0]-Ji.position[0]),Ui.time=0),b.ui.push(Hi,Ji),Q){var Vi=0,Wi=m.data,Qi=i.ui.phases[m.target];if("enter"===Wi.state){var Xi=-Qi.width,Yi=s.size[0]/2-Qi.width/2-3;Vi=Wi.text.x*(Yi-Xi)+Xi}else if("pass"===Wi.state){var Zi=s.size[0]/2-Qi.width/2-3;Vi=6*Wi.text.x+Zi}else if("exit"===Wi.state){var $i=s.size[0]/2-Qi.width/2+3,en=s.size[0];Vi=Wi.text.x*(en-$i)+$i}var tn=an(256*(Wi.bg.width-Wi.bg.x),2+10*Wi.bg.height);tn.fillStyle="player"===m.target?xn:zn,tn.fillRect(0,0,tn.canvas.width,tn.canvas.height),tn.canvas.width&&b.ui.push({image:tn.canvas,position:[256*Wi.bg.x,s.size[1]/2-tn.canvas.height/2]}),b.ui.push({image:Qi,position:[Vi,s.size[1]/2-Qi.height/2]})}n.attack&&3===v.power&&1===n.attack.time?(a.fillStyle="white",a.fillRect(0,0,a.canvas.width,a.canvas.height)):("player"!==n.phase.faction||v||T||Q||(R||n.moved)&&!C||function(e,t,a,i){var n=i.state.time,r=(i.cache,a.cell[0]-a.prev[0]),o=a.cell[1]-a.prev[1],l=Math.abs(r)+Math.abs(o);a.prev[0]+=r/4,a.prev[1]+=o/4;var s=0;a.selection&&!i.state.dialogs.length?s=1:l<.001&&(s=Math.floor(n/30)%2);var c=16*a.prev[0],u=16*a.prev[1],f=t[i.cache.phase.faction][s];e.cursor.push({image:f,position:[c,u]})}(b,i.ui.cursor,l,e),function(e,t,a,i){for(var n=a.map,r=(a.phase,i.cache),o=i.state.attacks,l=i.state.anims,s=l[0],c=0;c<r.units.length;c++){var u=r.units[c],f=u.original,h=u.cell,g=16*h[0],p=16*h[1],d=0,m=t[u.faction][Mn[u.type]];if("player"!==u.faction||"player"!==r.phase.faction||!r.phase.pending||r.phase.pending.includes(f)||o.length&&o[0].target===f||s&&s.target===u&&("move"===s.type||"attack"===s.type)||(m=t.done[u.faction][Mn[u.type]]),n.units[c]===f?rn(u.cell,f.cell)||r.moved||(s&&(s.done=!0),s=l[0]=kn("move",u,bn.move(r.path)),r.moved=!0):l.length||(s&&(s.done=!0),s=l[0]=kn("fade",u,bn.fade())),s&&s.target===u){if("lift"===s.type||"drop"===s.type)d=s.data.height;else if("move"===s.type||"attack"===s.type)g=16*s.data.cell[0],p=16*s.data.cell[1];else if("fade"===s.type){if(s.done){r.units.splice(c--,1);continue}if(!s.data.visible)continue}e.selection.push({image:m,position:[g,p-d]})}else{var v=o[0];if(r.attack&&!r.attack.countdown&&v.target===f){var y=r.attack,w=y.connected,b=y.time,k=y.normal;if(w&&(v.damage&&b<45&&b%2&&(m=t.flashing),b<20&&v.power&&("knight"!==u.type||v.damage===u.hp))){var x=b;10<b&&(x=20-b),g+=k[0]*x/2*v.power/2,p+=k[1]*x/2*v.power/2}e.selection.unshift({image:m,position:[g,p]})}(!r.attack||r.attack.countdown||v&&v.target!==f)&&e.pieces.push({image:m,position:[g,p]})}e.shadows.push({image:t.shadow,position:[g+1,p+4]})}}(b,i.pieces,t,e),function(e,t,a,i){var n=!0,r=!1,o=void 0;try{for(var l,s=t[Symbol.iterator]();!(n=(l=s.next()).done);n=!0){var c=l.value,u=e[c];"ui"!==c&&u.sort(function(e,t){return e.position[1]-t.position[1]});var f=!0,h=!1,g=void 0;try{for(var p,d=u[Symbol.iterator]();!(f=(p=d.next()).done);f=!0){var m=p.value,v=Math.round(m.position[0]),y=Math.round(m.position[1]-(m.position[2]||0));"ui"!==c&&(v-=a.position[0]+a.offset[0],y-=a.position[1]+a.offset[1]),i.drawImage(m.image,v,y)}}catch(e){h=!0,g=e}finally{try{!f&&d.return&&d.return()}finally{if(h)throw g}}}}catch(e){r=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw o}}}(b,w,s,a))}var T=15,D=3;function G(t,e,a,i){var n=e.held,r=e.prev,o=a.map,l=a.phase;if(n.confirm&&!r.confirm)if(t.selection){var s=t.selection.unit;if(l.pending.includes(s)&&"player"===l.faction){var c=o.units.indexOf(s),u=i.cache.units[c],f=i.cache.ranges[c];if(f){var h=i.cache.path;if(h&&1<h.length){var g=h[h.length-1].slice(),p=un(o,t.cell);f.move.find(function(e){return rn(e,t.cell)})?O(u,g):p&&f.attack.find(function(e){return rn(e,t.cell)})&&(O(u,g),i.cache.target||(i.cache.target={unit:p,time:0}))}else i.cache.moved=!0}}else K(t)}else t.under&&(t.selection=t.under,t.selection.time=0);if(n.mod&&t.selection&&l.pending.includes(t.selection.unit)){var d=t.selection.unit,m=o.units.indexOf(d),v=i.cache.ranges[m];if(!n.left||r.left||n.right){if(n.right&&!r.right&&!n.left){for(w=t.cell[0];w<o.layout.size[0];w++){for(b=0;b<v.move.length;b++){var y=v.move[b];if(y[0]===w+1&&y[1]===t.cell[1])break}if(b===v.move.length)break}t.cell[0]=w}}else{for(var w=t.cell[0];0<=w;w--){for(var b=0;b<v.move.length;b++){var k=v.move[b];if(k[0]===w-1&&k[1]===t.cell[1])break}if(b===v.move.length)break}t.cell[0]=w}if(!n.up||r.up||n.down){if(n.down&&!r.down&&!n.up){for(z=t.cell[1];z<o.layout.size[1];z++){for(b=0;b<v.move.length;b++){var x=v.move[b];if(x[1]===z+1&&x[0]===t.cell[0])break}if(b===v.move.length)break}t.cell[1]=z}}else{for(var z=t.cell[1];0<=z;z--){for(var b=0;b<v.move.length;b++){var M=v.move[b];if(M[1]===z-1&&M[0]===t.cell[0])break}if(b===v.move.length)break}t.cell[1]=z}}else(n.left&&!r.left||n.left>T&&!(n.left%D))&&!n.right?E(t,"left",o):(n.right&&!r.right||n.right>T&&!(n.right%D))&&!n.left&&E(t,"right",o),(n.up&&!r.up||n.up>T&&!(n.up%D))&&!n.down?E(t,"up",o):(n.down&&!r.down||n.down>T&&!(n.down%D))&&!n.up&&E(t,"down",o);var I=un(o,t.cell);if(I?t.under&&I===t.under.unit?t.under.time++:!t.under&&i.cache.selected&&i.cache.selected.unit===I?t.under=i.cache.selected:t.under={unit:I,time:0}:t.under=null,!t.selection&&n.select&&!r.select){var S=n.mod;!function(e,t,a){var i=t.map,n=t.phase,r=un(i,e.cell);if(!r)return(r=n.pending.find(function(e){return e.faction===n.faction}))&&(e.cell=r.cell.slice());var o=null,l=i.units.filter(function(e){return e.faction===r.faction}),s=r.faction===n.faction?n.pending:l,c=s.indexOf(r);if(s===n.pending&&-1===c){if(c=l.indexOf(r),a){for(var u=c-1;0<=u;u--){var f=l[u];if(n.pending.includes(f))break}if(-1===u)for(var u=l.length-1;c<u;u--){var h=l[u];if(n.pending.includes(h))break}}else{for(var u=c+1;u<l.length;u++){var g=l[u];if(n.pending.includes(g))break}if(u===l.length)for(var u=0;u<c;u++){var p=l[u];if(n.pending.includes(p))break}}o=l[c=u]}else o=a?0<=c-1?s[c-1]:s[s.length-1]:c+1<s.length?s[c+1]:s[0];o&&(e.cell=o.cell.slice())}(t,a,S)}}function K(e){e.selection=null}function E(e,t,a){var i=a.layout.size;"left"===t?--e.cell[0]<0&&(e.cell[0]=0):"right"===t?++e.cell[0]>=i[0]&&(e.cell[0]=i[0]-1):"up"===t?--e.cell[1]<0&&(e.cell[1]=0):"down"===t&&++e.cell[1]>=i[1]&&(e.cell[1]=i[1]-1)}var j,B={left:["KeyA","ArrowLeft"],up:["KeyW","ArrowUp"],right:["KeyD","ArrowRight"],down:["KeyS","ArrowDown"],confirm:["Space"],cancel:["Escape"],select:["Tab"],mod:["ShiftLeft"]};function J(a,e){(e=e.slice()).sort(function(e,t){return e.hp-t.hp});for(var t=1/0,i=0;i<e.length;i++){var n=e[i];if(!(n.hp<=t)){e=e.slice(0,i+1);break}t=n.hp}return e.sort(function(e,t){return pn(a,t)-pn(a,e)}),e[0]}(j="sprites.png",new Promise(function(e,t){var a=new Image;a.src=j,a.onload=function(){e(a)},a.onerror=function(){t(new Error("Failed to load image `"+j+"`"))}})).then(function(e){var _=(a=256,i=240,n=o(e),r=document.createElement("canvas"),r.width=a,r.height=i,{sprites:n,context:r.getContext("2d"),state:{time:0,anims:[kn("phase","player",bn.phase())],cursor:{cell:null,prev:null,selection:null,under:null},viewport:{size:[a,i],position:null,offset:[0,0],target:null,shake:0},ai:{strategy:null,index:0,action:0,moved:!1,attacked:!1},menu:null,paused:!1,attacks:[],dialogs:[],log:[]},cache:{map:null,selection:null,selected:null,target:null,moved:!1,attack:null,phase:{faction:"player",pending:null,done:!1},units:null,ranges:[],squares:[],particles:[],log:null,menu:{box:null,labels:[]},dialogs:{objective:null,selection:null,target:null}}}),t=_.context.canvas;var a,i,n,r;document.querySelector("main").appendChild(t),function e(){F(_,V);!function(e){var t=e.cache,a=e.state;a.time++;var i=a.cursor;i.selection?i.selection.time++:t.selection&&t.selection.time++,t.target&&t.target.time++,t.attack&&t.attack.connected&&t.attack.time++;var n=e.state.anims,r=n[0];r&&(r.done?n.shift():bn[r.type].update(r))}(_);var t=W.held,a=W.prev;var i=_.state.cursor;var n=_.state.anims;var r=_.state.dialogs;var o=r[0];o?(l=o.menu,c=(s=W).held,u=s.prev,c.confirm&&!u.confirm&&(l.done=!0),l.done||(c.select&&!u.select?U(l,c.mod):!c.up||u.up||c.down?!c.down||u.down||c.up||U(l):U(l,!0))):"player"!==V.phase.faction||_.state.attacks.length||_.cache.moved||n.length&&"phase"===n[0].type||G(i,W,V,_);var l,s,c,u;var f=_.state.ai;if("enemy"!==_.cache.phase.faction||_.cache.phase.done)f.strategy=null;else if(f.strategy){var h=f.strategy[f.index],g=f.allies[f.index],p=V.map.units.indexOf(g),d=_.cache.units[p],m=h&&h[f.action];if(m){var v=_slicedToArray(m,2),y=v[0],w=v[1];if("move"===y){if(!n.length)if(f.moved)f.action++,_.cache.moved=!1,d.cell=w.slice();else{f.moved=!0;var b=fn(V.map,g),k=b.move.slice(),x=!0,z=!1,M=void 0;try{for(var I,S=f.allies[Symbol.iterator]();!(x=(I=S.next()).done);x=!0){var O=I.value;k.push(O.cell)}}catch(e){z=!0,M=e}finally{try{!x&&S.return&&S.return()}finally{if(z)throw M}}var q=wn(k,g.cell,w);_.cache.path=q,_.cache.moved=!1,g.cell=w.slice()}}else if("attack"===y){var A=pn(g,w),L=Math.min(w.hp,Number(A));if(!_.state.attacks.length)if(f.attacked)f.action++,i.selection=null,i.under=null;else{if(f.attacked=!0,gn(g,w),_.cache.target={unit:w,time:0},_.state.attacks.push({attacker:g,target:w,power:A,damage:L}),w.hp&&nn(w.cell,g.cell)<=H(w)){var R=pn(w,g),C=Math.min(g.hp,Number(R));gn(w,g),_.state.attacks.push({attacker:w,target:g,power:R,damage:C,counter:!0}),w.hp||f.casualties++}i.selection={unit:g,time:0},i.under=g}}}else if(f.moved=!1,f.attacked=!1,f.index++,f.action=0,g&&mn(V,g),f.index===f.strategy.length){f.index=0,f.strategy=null,_.cache.phase.done=!0;var T=V.map.units.find(function(e){return"player"===e.faction});T&&(i.cell=T.cell.slice(),i.prev=T.cell.slice(),i.selection=null,i.under=null)}}else{var D=V.map.units.filter(function(e){return"enemy"===e.faction}),E=V.map.units.filter(function(e){return"player"===e.faction});E.length&&(f.strategy=function(U,t){for(var F=[],G={tiles:U.tiles,layout:U.layout,units:U.units.map(function(e){return Object.assign({},e)})},K=[],e=_slicedToArray(U.layout.size,2),a=e[0],i=e[1],n=0;n<i;n++)for(var r=0;r<a;r++){var o=n*a+r;U.layout.data[o].solid||K.push([r,n])}var l=G.units.filter(function(e){return e.faction===t}),s=function(t){var e=[];F.push(e);var a=[];if("defend"===t.ai){var i=on(t.cell,H(t)),n=!0,r=!1,o=void 0;try{for(var l,s=i[Symbol.iterator]();!(n=(l=s.next()).done);n=!0){var c=l.value,u=un(G,c);u&&u.hp&&!hn(t,u)&&a.push(u)}}catch(e){r=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw o}}if(a.length){var f=J(t,a);e.push(["attack",U.units[G.units.indexOf(f)]]),gn(t,f)}}else if("wait"===t.ai){var h=fn(G,t),g=!0,p=!1,d=void 0;try{for(var m,v=h.attack[Symbol.iterator]();!(g=(m=v.next()).done);g=!0){var y=m.value,w=un(G,y);w&&w.hp&&!hn(t,w)&&a.push(w)}}catch(e){p=!0,d=e}finally{try{!g&&v.return&&v.return()}finally{if(p)throw d}}if(a.length){var b=J(t,a),k=on(b.cell,H(t)).filter(function(t){return h.move.find(function(e){return rn(e,t)})&&!un(G,t)});if(k.length){k.sort(function(e,t){return nn(b.cell,t)-nn(b.cell,e)});var x=k[0];e.push(["move",x],["attack",U.units[G.units.indexOf(b)]]),t.cell=x,gn(t,b)}}}else if("attack"===t.ai){var z=fn(G,t),M=!0,I=!1,S=void 0;try{for(var O,q=z.attack[Symbol.iterator]();!(M=(O=q.next()).done);M=!0){var A=O.value,L=un(G,A);L&&L.hp&&!hn(t,L)&&a.push(L)}}catch(e){I=!0,S=e}finally{try{!M&&q.return&&q.return()}finally{if(I)throw S}}if(a.length){var R=J(t,a),C=on(R.cell,H(t)).filter(function(t){return z.move.find(function(e){return rn(e,t)})});if(C.length){C.sort(function(e,t){return nn(R.cell,t)-nn(R.cell,e)});var T=C[0];rn(t.cell,T)||e.push(["move",T]),e.push(["attack",U.units[G.units.indexOf(R)]]),t.cell=T,gn(t,R)}}else if((a=G.units.filter(function(e){return!hn(t,e)})).length){var D=a.map(function(e){return wn(K,t.cell,e.cell).slice(0,-1)});a.sort(function(e,t){return D[a.indexOf(e)].length-D[a.indexOf(t)]});for(var E=a[0],j=D.find(function(e){return 1===nn(e[e.length-1],E.cell)}),B=[],N=function(e){var t=z.move[e],a=j.find(function(e){return rn(t,e)});a&&!un(G,t)&&B.push(a)},P=0;P<z.move.length;P++)N(P);if(B.length){B.sort(function(e,t){return j.indexOf(t)-j.indexOf(e)});var _=B[0];e.push(["move",_]),t.cell=_}}}},c=!0,u=!1,f=void 0;try{for(var h,g=l[Symbol.iterator]();!(c=(h=g.next()).done);c=!0)s(h.value)}catch(e){u=!0,f=e}finally{try{!c&&g.return&&g.return()}finally{if(u)throw f}}return F}(V.map,"enemy"),f.allies=D,i.selection=null,i.under=null)}if(t.cancel&&!a.cancel){var j=_.state.anims[0];if(!j||"move"!==j.type)if(o){if("pause"===o.type)_.state.paused=!1;else if("actions"===o.type){var B=_.state.cursor.selection.unit,N=V.map.units.indexOf(B);_.cache.units[N].cell=B.cell,_.cache.moved=null}r.shift(),r.length&&"actions"===(o=r[0]).type&&(o.menu.done=!1)}else i.selection?K(i):_.state.attacks.length||j&&"phase"===j.type||(_.state.paused=!0)}P=W,Object.assign(P.prev,P.held);var P;requestAnimationFrame(e)}()});var N,P,V=(P=(N=e).units.map(function(e){return function(e,t,a,i,n){return{name:e,type:t,faction:a,ai:i,cell:n,hp:3,stats:p[t],equipment:m[t]}}.apply(void 0,_toConsumableArray(e))}),{map:{tiles:N.tiles,layout:N.layout,units:P},phase:{faction:"player",pending:P.filter(function(e){return"player"===e.faction})}}),W={held:function(e,i){var n={},r=!1;function t(e){var t=null;if(i)for(var t in i){for(var a=0;a<i[t].length&&i[t][a]!==e.code;a++);if(a<i[t].length)break;t=null}t||(t=e.code),"keydown"===e.type?n[t]||(n[t]=1):"keyup"===e.type&&(n[t]=0),r||(r=!0,requestAnimationFrame(o))}function o(){for(var e in n)n[e]&&n[e]++;requestAnimationFrame(o)}return e.addEventListener("keydown",t),e.addEventListener("keyup",t),n}(window,B),prev:{}};window.addEventListener("keydown",function(e){"Tab"===e.code&&e.preventDefault()})}();