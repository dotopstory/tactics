"use strict";var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var a=[],i=!0,n=!1,r=void 0;try{for(var l,o=e[Symbol.iterator]();!(i=(l=o.next()).done)&&(a.push(l.value),!t||a.length!==t);i=!0);}catch(e){n=!0,r=e}finally{try{!i&&o.return&&o.return()}finally{if(n)throw r}}return a}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}!function(){var a={piece:{palette:[184,0,3,3],shadow:[160,32,14,14],symbols:{shield:[56,164,8,8],bow:[48,172,8,8],dagger:[64,120,8,8],axe:[0,180,8,8],hat:[128,112,8,8]},base:[128,64,16,16]},tiles:{"shadow-corner":[112,80,16,16],black:[112,64,16,16],"wall-base":[144,48,16,16],floor:[144,32,16,16],"shadow-edge":[32,164,16,16],grass:[112,112,16,16],wall:[170,164,16,16]},ui:{cursor:[144,0,32,32],box:[64,64,48,48],squares:[0,164,32,16],arrows:[0,0,64,128],"enemy-phase":[0,146,170,18],healthbar:[64,112,48,8],symbols:{dragon:[32,180,8,8],shield:[48,164,8,8],bow:[176,0,8,8],boot:[170,180,8,8],dagger:[112,96,8,8],sword:[128,80,8,8],next:[144,64,8,8],eye:[160,48,8,8],clock:[174,32,8,8],axe:[176,8,8,8],hat:[8,180,8,8],enemy:[72,120,8,8],lance:[40,180,8,8]},"player-phase":[0,128,188,18],typeface:[64,0,80,64],swords:[170,146,16,18]}};function h(e,t,a,i,n){var r=document.createElement("canvas"),l=r.getContext("2d");return r.width=i,r.height=n,l.drawImage(e,-t,-a),r}var z={get:function(e,t,a){var i=4*(a*e.width+t),n=e.data[i],r=e.data[i+1],l=e.data[i+2],o=e.data[i+3];return[n,r,l,o]},set:function(e,t,a,i){var n=4*(a*e.width+t);e.data[n+0]=i[0],e.data[n+1]=i[1],e.data[n+2]=i[2],e.data[n+3]=i[3]},replace:function(e,t,a){for(var i=0;i<e.data.length;i+=4){for(var n=0;n<4&&e.data[i+n]===t[n];n++);if(4===n)for(var n=0;n<4;n++)e.data[i+n]=a[n]}}};function vi(e,t){var a=document.createElement("canvas");return a.width=e,a.height=t,a.getContext("2d")}var c={warrior:"axe",knight:"shield",rogue:"dagger",mage:"hat"};function l(e){var t=function e(t,a){var i={};for(var n in a)if(Array.isArray(a[n])){var r=_slicedToArray(a[n],4),l=r[0],o=r[1],s=r[2],c=r[3];i[n]=h(t,l,o,s,c)}else i[n]=e(t,a[n]);return i}(e,a);return{tiles:t.tiles,pieces:function(e){var t={player:{},enemy:{},ally:{},done:{player:{},enemy:{},ally:{}},flashing:null,symbols:e.symbols,shadow:e.shadow},a=e.palette.getContext("2d").getImageData(0,0,3,3),i={black:[0,0,0,255],white:[255,255,255,255],cyan:z.get(a,0,0),blue:z.get(a,1,0),navy:z.get(a,2,0),pink:z.get(a,0,1),red:z.get(a,1,1),purple:z.get(a,2,1),lime:z.get(a,0,2),green:z.get(a,1,2),teal:z.get(a,2,2)},n={player:[i.cyan,i.blue,i.navy],enemy:[i.pink,i.red,i.purple],ally:[i.lime,i.green,i.teal]};for(var r in n){var l=n[r];for(var o in e.symbols){var s=e.symbols[o],c=vi(s.width,s.height);c.drawImage(s,0,0);var u=e.base.getContext("2d").getImageData(0,0,16,16);z.replace(u,i.white,l[1]),z.replace(u,i.black,l[2]);var f=vi(u.width,u.height);f.putImageData(u,0,0);var h=c.getImageData(0,0,s.width,s.height);z.replace(h,i.white,l[0]),c.putImageData(h,0,0),f.drawImage(c.canvas,4,4),z.replace(h,l[0],l[2]),c.putImageData(h,0,0),f.drawImage(c.canvas,4,3),t[r][o]=f.canvas}}for(var p in n){var g=n[p];for(var d in e.symbols){var m=e.symbols[d],v=vi(m.width,m.height);v.drawImage(m,0,0);var w=e.base.getContext("2d").getImageData(0,0,16,16);z.replace(w,i.white,g[2]);var y=vi(w.width,w.height);y.putImageData(w,0,0);var b=v.getImageData(0,0,m.width,m.height);z.replace(b,i.white,g[1]),v.putImageData(b,0,0),y.drawImage(v.canvas,4,4),z.replace(b,g[1],i.black),v.putImageData(b,0,0),y.drawImage(v.canvas,4,3),t.done[p][d]=y.canvas}}var x=e.base.getContext("2d").getImageData(0,0,16,16);z.replace(x,i.black,i.white);var k=vi(x.width,x.height);return k.putImageData(x,0,0),t.flashing=k.canvas,t}(t.piece),ui:function(e){var w={symbols:e.symbols,swords:e.swords,cursor:(t=e.cursor,{player:[h(t,0,0,16,16),h(t,16,0,16,16)],enemy:[h(t,0,16,16,16),h(t,16,16,16,16)]}),typeface:function(e){for(var t=e.width/8,a=e.height/8,i={},n=0,r=0;r<a;r++)for(var l=0;l<t;l++){var o="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,.!?abcdefghijklmnopqrstuvwxyz'\"/\\()        "[n++];i[o]=h(e,8*l,8*r,8,8)}return i}(e.typeface),healthbar:e.healthbar,phases:{player:e["player-phase"],enemy:e["enemy-phase"]},box:{topLeft:h(e.box,0,0,16,16),top:h(e.box,16,0,16,16),topRight:h(e.box,32,0,16,16),left:h(e.box,0,16,16,16),center:h(e.box,16,16,16,16),right:h(e.box,32,16,16,16),bottomLeft:h(e.box,0,32,16,16),bottom:h(e.box,16,32,16,16),bottomRight:h(e.box,32,32,16,16)},squares:{move:h(e.squares,0,0,16,16),attack:h(e.squares,16,0,16,16)},arrows:{player:{left:h(e.arrows,0,0,16,16),right:h(e.arrows,16,0,16,16),up:h(e.arrows,32,0,16,16),down:h(e.arrows,48,0,16,16),leftStub:h(e.arrows,0,16,16,16),rightStub:h(e.arrows,16,16,16,16),upStub:h(e.arrows,32,16,16,16),downStub:h(e.arrows,48,16,16,16),upLeft:h(e.arrows,0,32,16,16),upRight:h(e.arrows,16,32,16,16),downLeft:h(e.arrows,32,32,16,16),downRight:h(e.arrows,48,32,16,16),horiz:h(e.arrows,0,48,16,16),vert:h(e.arrows,16,48,16,16)},enemy:{left:h(e.arrows,0,64,16,16),right:h(e.arrows,16,64,16,16),up:h(e.arrows,32,64,16,16),down:h(e.arrows,48,64,16,16),leftStub:h(e.arrows,0,80,16,16),rightStub:h(e.arrows,16,80,16,16),upStub:h(e.arrows,32,80,16,16),downStub:h(e.arrows,48,80,16,16),upLeft:h(e.arrows,0,96,16,16),upRight:h(e.arrows,16,96,16,16),downLeft:h(e.arrows,32,96,16,16),downRight:h(e.arrows,48,96,16,16),horiz:h(e.arrows,0,112,16,16),vert:h(e.arrows,16,112,16,16)}}};var t;return w.Text=u,w.Box=f,w.TextBox=function(e){var t=0,a=0,i=null;if(Array.isArray(e)){i=e.map(function(e){return u(e)});var n=e.map(function(e){return e.width}),r=Math.max.apply(Math,_toConsumableArray(n));t=r,a=8*e.length}else i=u(e),t=i.width,a=8;var l=f(t+16,a+16),o=vi(t,a);if(Array.isArray(e))for(var s=0;s<i.length;s++){var c=i[s];o.drawImage(c,0,8*s)}else o.drawImage(i,0,0);return o.canvas.width&&l.getContext("2d").drawImage(o.canvas,8,8),l},w.HealthBar=s,w.UnitDetails=function(e){var t=w.symbols[c[e.type]],a=u(e.name),i=f(a.width+t.width+20,24),n=i.getContext("2d");n.drawImage(t,8,8),n.drawImage(a,20,8);var r=f(84,24),l=s(e.hp/3,e.faction),o=u("HP");return(n=r.getContext("2d")).drawImage(o,8,8),n.drawImage(l,28,8),{name:i,hp:r}},w.Arrow=function(e,t){for(var a=[],i=0;i<e.length;i++){var n=_slicedToArray(e[i],2),r=n[0],l=n[1],o=!1,s=!1,c=!1,u=!1,f=e[i-1];if(f){var h=r-f[0],p=l-f[1];1===h?o=!0:-1===h&&(s=!0),1===p?c=!0:-1===p&&(u=!0)}var g=e[i+1];if(g){var d=g[0]-r,m=g[1]-l;-1===d?o=!0:1===d&&(s=!0),-1===m?c=!0:1===m&&(u=!0)}if(o||s||c||u){var v=null;o&&s?v="horiz":c&&u?v="vert":c&&o?v="upLeft":c&&s?v="upRight":u&&o?v="downLeft":u&&s?v="downRight":o&&!i?v="leftStub":s&&!i?v="rightStub":c&&!i?v="upStub":u&&!i?v="downStub":o?v="left":s?v="right":c?v="up":u&&(v="down"),v&&a.push({image:w.arrows[t][v],position:[r,l]})}}return a},w;function u(e){for(var t=0,a=0;a<e.length;a++){var i=e[a];t+=" "===i?4:8}var n=document.createElement("canvas");n.width=t,n.height=8;for(var r=n.getContext("2d"),l=0,o=0;l<e.length;l++){var s=e[l];if(" "===s)o+=4;else{var c=w.typeface[s];r.drawImage(c,o,0),o+=8}}return n}function f(e,t){var a=Math.ceil(e/16),i=Math.ceil(t/16),n=document.createElement("canvas"),r=n.getContext("2d");n.width=e,n.height=t;for(var l=1;l<a-1;l++)r.drawImage(w.box.top,16*l,0),r.drawImage(w.box.bottom,16*l,t-16);for(var o=1;o<i-1;o++)r.drawImage(w.box.left,0,16*o),r.drawImage(w.box.right,e-16,16*o);return r.fillRect(4,4,n.width-8,n.height-8),r.drawImage(w.box.topLeft,0,0),r.drawImage(w.box.topRight,n.width-16,0),r.drawImage(w.box.bottomLeft,0,n.height-16),r.drawImage(w.box.bottomRight,n.width-16,n.height-16),n}function s(e,t){var a=vi(48,8);return a.drawImage(w.healthbar,0,0),a.fillStyle={player:"rgb(144, 224, 232)",enemy:"rgb(248, 192, 224)",ally:"rgb(200, 224, 255)"}[t],a.fillRect(3,3,Math.floor(42*e),2),a.canvas}}(t.ui),effects:function(){var e=vi(1,1);e.fillStyle="white",e.fillRect(0,0,1,1);var t=vi(2,2);return t.fillStyle="white",t.fillRect(0,0,2,2),{small:e.canvas,large:t.canvas}}()}}var t={name:"grass",solid:!1},i={name:"wall",solid:!0},n={name:"floor",solid:!1};"##########################      ##.......##      ##      ##.......##      ##      ##.......##      ##      ####...####      ##      ####...####      ##      ##.......##      ##    ####.......####    ##    ####.......####    ##    ...............    ##    ####.......####    ##    ####.......####    ##      ##.......##      ##      ###########      ##      ###########      ##                       ##                       ##      ##       ##      ##      ##       ##      ##########       ##################       #########                                                                                                    ".split("").map(function(e){switch(e){case" ":return t;case"#":return i;case".":return n}});var r={name:"grass",solid:!1},o={name:"floor",solid:!1},s={name:"wall",solid:!0},e={layout:{size:[20,20],data:["           #########","       ##  #......##"," #     ##  ##......#"," #         ##....###","            ###..###","          #####...##","      ##  ###.#...# ","      ##  #.......# ","          ....##### ","#         #...##### ","#    #    #####     ","     #    #####     ","                    ","                    ","        ##    #     ","        ##    #     "," #               ## "," ##    #         ## "," ##    #            ","                    "].join("").split("").map(function(e){switch(e){case" ":return r;case".":return o;case"#":return s}})},units:[["MAGE","mage","player",!1,[4,13]],["KNIGHT","knight","player",!1,[6,14]],["WARRIOR","warrior","player",!1,[5,16]],["ROGUE","rogue","player",!1,[3,15]],["DARK MAGE","mage","enemy","defend",[15,1]],["TROLL","knight","enemy","defend",[15,4]],["TROLL","knight","enemy","defend",[16,4]],["ORC","warrior","enemy","wait",[16,6]],["TROLL","knight","enemy","defend",[10,8]],["GOBLIN","rogue","enemy","attack",[9,12]],["GOBLIN","rogue","enemy","attack",[8,6]],["ORC","warrior","enemy","attack",[7,12]]]};function wi(e,t){return Math.abs(t[0]-e[0])+Math.abs(t[1]-e[1])}function u(e){return e[0]}function f(e){return e[1]}function yi(e,t){return u(e)===u(t)&&f(e)===f(t)}function bi(e,t){t||(t=1);for(var a=[{steps:0,cell:e}],i=[];a.length;)for(var n=a.shift(),r=[[u(n.cell)-1,f(n.cell)],[u(n.cell)+1,f(n.cell)],[u(n.cell),f(n.cell)-1],[u(n.cell),f(n.cell)+1]],l=0;l<r.length;l++){var o=r[l];if(!yi(e,o)){for(var s=0;s<i.length;s++){if(yi(o,i[s]))break}s<i.length||(i.push(o),n.steps+1<t&&a.push({steps:n.steps+1,cell:o}))}}return i}function xi(e){return e.layout.size[0]}function ki(e){return e.layout.size[1]}function zi(e,t){return e.layout.data[f(t)*xi(e)+u(t)]}function Ii(e,t){for(var a=0;a<e.units.length;a++){var i=e.units[a];if(yi(t,i.cell))return i}}function Mi(e,t){return 0<=u(t)&&u(t)<xi(e)&&0<=f(t)&&f(t)<ki(e)}function Si(e,t){return e.faction===t.faction||"player"===e.faction&&"ally"===t.faction||"ally"===e.faction&&"player"===t.faction}function A(e,t,a){e.cell=t}function Ai(e,t){var a=qi(e,t);return a&&(t.hp-=Math.min(t.hp,a)),a}function qi(e,t){var a,i,n,r;if((r=(n=e).equipment.weapon,n.stats.agi+(r?r.acc:0)-(i=(a=t).equipment.armor,a.stats.agi-(i?i.wt:0)))<0)return null;if("warrior"===e.type)switch(t.type){case"warrior":case"knight":return 2;case"rogue":return 0;case"mage":return 3}else if("knight"===e.type)switch(t.type){case"warrior":return 2;case"knight":return 1;case"rogue":case"mage":return 2}else if("rogue"===e.type)switch(t.type){case"warrior":return 2;case"knight":return 0;case"rogue":return 1;case"mage":return 2}else if("mage"===e.type)switch(t.type){case"warrior":return 2;case"knight":case"rogue":case"mage":return 1}}function Oi(e){if("defend"===e.ai)return 0;var t=e.equipment.armor;return 5-(t?t.wt:0)+Math.floor(e.stats.agi/2)}var p={warrior:{str:2,int:0,agi:1},knight:{str:1,int:0,agi:0},rogue:{str:1,int:1,agi:2},mage:{str:1,int:1,agi:1}},g={axe:{target:"str",atk:2,acc:0,rng:1},lance:{target:"str",atk:3,acc:2,rng:1},dagger:{target:"str",atk:2,acc:1,rng:1},tome:{target:"int",atk:1,acc:1,rng:2}},d={warrior:{weapon:g.axe,armor:null},knight:{weapon:g.lance,armor:{def:2,wt:1}},rogue:{weapon:g.dagger,armor:null},mage:{weapon:g.tome,armor:null}};function Ri(e,t){var a=e.phase.pending;a.splice(a.indexOf(t),1),a.length||Ci(e)}function Ci(e){var t=e.map,a=e.phase;a.faction="player"===a.faction?"enemy":"player",a.pending=t.units.filter(function(e){return e.faction===a.faction}),a.pending.length||Ci(e)}function Li(e,t){return{options:e,index:t||0,done:!1}}function m(e,t){t?--e.index<0&&(e.index=e.options.length-1):++e.index>=e.options.length&&(e.index=0)}function Di(e,t,a){for(var i=[],n=[t],r={},l={},o={},s={},c={},u=0;u<e.length;u++){s[h=e[u]]=1/0,c[h]=1/0}for(s[t]=0,c[t]=wi(t,a);n.length;){var f={score:1/0,index:-1,cell:null};for(u=0;u<n.length;u++){(m=c[h=n[u]])<f.score&&(f.score=m,f.index=u,f.cell=h)}var h;if(yi(h=f.cell,a)){for(;!yi(h,t);)i.unshift(h),h=o[h];return i.unshift(h),i}n.splice(f.index,1),r[h]=!1,l[h]=!0;var p=bi(h);for(u=0;u<p.length;u++){var g=p[u];if(!l[g]){for(var d=0;d<e.length;d++){if(yi(e[d],g))break}var m;if(d!==e.length)r[g]||(r[g]=!0,n.push(g)),(m=s[h]+1)>=s[g]||(o[g]=h,s[g]=m,c[g]=m+wi(g,a))}}}}function v(){return{height:0,time:0,floating:!1}}v.update=function(e){if(!e.done){var t=e.data;if(t.time++,e.floating){var a=t.time%120/120;t.height=4+Math.sin(2*Math.PI*a)}else 4==++t.height&&(e.floating=!0)}};var w=Object.freeze({default:v});function y(e){return{height:Math.round(e||4)}}y.update=function(e){e.done||--e.data.height||(e.done=!0)};var b=Object.freeze({default:y});function x(e){return{path:e,cell:e[0].slice(),time:0}}x.update=function(e){if(e.done)return!1;var t=e.data,a=Math.floor(t.time/4),i=t.time%4*.25,n=t.path[a],r=t.path[a+1];return r?t.cell=[n[0]+(r[0]-n[0])*i,n[1]+(r[1]-n[1])*i]:(t.cell=n.slice(),e.done=!0),t.time++,!0};var k=Object.freeze({default:x});function I(e,t){var a=[t[0]-e[0],t[1]-e[1]],i=Math.sqrt(a[0]*a[0]+a[1]*a[1]);return{src:e,norm:[a[0]/i,a[1]/i],cell:e.slice(),time:0,connected:!1}}I.update=function(e){if(!e.done){var t=e.data,a=t.time<=7?t.time:7-(t.time-7);8<=t.time&&(t.connected=!0),t.cell[0]=t.src[0]+t.norm[0]/8*a,t.cell[1]=t.src[1]+t.norm[1]/8*a,15==++t.time&&(e.done=!0)}};var M=Object.freeze({default:I});function S(){return{time:0,flashing:!1}}S.update=function(e){if(!e.done){var t=e.data;t.flashing=!t.flashing,15==++t.time&&(e.done=!0)}};var q=Object.freeze({default:S});function O(){return{time:0,visible:!0}}O.update=function(e){if(!e.done){var t=e.data;t.visible=!t.visible,30==++t.time&&(e.done=!0)}};var R=Object.freeze({default:O});function C(){return{time:0,state:"enter",text:{x:0},bg:{x:0,width:0,height:0}}}C.update=function(e){if(!e.done){var t=e.data,a=t.time,i=t.text,n=t.bg;if(10<a&&a<=25){t.state="enter";var r=(a-10)/15,l=Math.sin(Math.PI/2*r);i.x=l}else if(25<a&&a<=40)t.state="pass",i.x=(a-25)/15;else if(40<a&&a<=55){t.state="exit";var o=(a-40)/15,s=1-Math.sin(Math.PI/2+Math.PI/2*o);i.x=s}if(a<=40){if(n.width<1)n.width+=1/16;else if(n.height<1){var c=(a-16)/8,u=Math.sin(Math.PI/2*c);n.height=u}}else 0<n.height?n.height-=1/8:n.x<1&&(n.x+=1/16);65==++t.time&&(e.done=!0)}};var L=Object.freeze({default:C}),Ti={lift:w&&v||w,drop:b&&y||b,move:k&&x||k,attack:M&&I||M,flinch:q&&S||q,fade:R&&O||R,phase:L&&C||L};function Ei(e,t,a){return{type:e,target:t,data:a,done:!1}}var ji="rgb(80, 120, 248)",Bi="rgb(208, 0, 88)",Pi={warrior:"axe",knight:"shield",rogue:"dagger",mage:"hat"};function D(e,t){var a=e.context,i=e.sprites,n=e.cache,r=e.state,l=r.time,o=r.cursor,s=r.viewport,c=r.anims,u=r.attacks,f=r.dialogs,h=t.map,p=a.canvas,g=c[0],d=u[0],m=f[0],v=["floors","squares","shadows","walls","pieces","arrows","cursor","selection","effects","ui"],w={},y=!0,b=!1,x=void 0;try{for(var k,z=v[Symbol.iterator]();!(y=(k=z.next()).done);y=!0){w[k.value]=[]}}catch(e){b=!0,x=e}finally{try{!y&&z.return&&z.return()}finally{if(b)throw x}}if(a.beginPath(),a.fillStyle="black",a.fillRect(0,0,p.width,p.height),n.units||(n.units=h.units.map(function(e){return Object.assign({original:e},e)})),n.map||(n.map=function(e,t){for(var a=xi(e),i=ki(e),n=vi(16*a,16*i),r=vi(16*a,16*i),l=0;l<i;l++)for(var o=0;o<a;o++){var s=16*o,c=16*l,u=zi(e,[o,l]),f=null;if("wall"===u.name)f=l+1<i&&"wall"!==zi(e,[o,l+1]).name?t["wall-base"]:t.wall,r.drawImage(f,s,c);else{var h=null;0<=o-1&&"wall"===zi(e,[o-1,l]).name&&0<=l-1&&"wall"!==zi(e,[o-1,l-1]).name?h=t["shadow-corner"]:0<=o-1&&"wall"===zi(e,[o-1,l]).name&&(h=t["shadow-edge"]),f=t[u.name],n.drawImage(f,s,c),h&&n.drawImage(h,s,c)}}return{floors:n.canvas,walls:r.canvas}}(h,i.tiles)),w.floors.push({image:n.map.floors,position:[0,0]}),w.walls.push({image:n.map.walls,position:[0,0]}),!o.cell){var I=h.units.find(function(e){return"player"===e.faction});o.cell=I.cell.slice(),o.prev=o.cell.slice()}var M=m&&"actions"===m.type&&m,S=m&&"forecast"===m.type&&m,A=m&&"pause"===m.type&&m,q=g&&"phase"===g.type,O=null;if(!q||!s.target)if(d)O=d.target.cell;else if(S&&!n.moved){O=m.options[m.index].cell}else o.selection&&t.phase.pending.includes(o.selection.unit)&&!n.moved?o.selection&&t.phase.pending.includes(o.selection.unit)&&(O=o.selection.unit.cell):O=o.cell;if(s.target||(s.target=[]),O){var R=S||d,C=16*xi(h);if(C>s.size[0]||R){if(s.target[0]=16*O[0]+8-s.size[0]/2,!R){var L=C-s.size[0];C>s.size[0]&&(s.target[0]<0?s.target[0]=0:s.target[0]>L&&(s.target[0]=L))}}else s.target[0]=C/2-s.size[0]/2;var D=16*ki(h);if(D>s.size[1]||R){if(s.target[1]=16*O[1]+8-s.size[1]/2,!R){var T=D-s.size[1];D>s.size[1]&&(s.target[1]<0?s.target[1]=0:s.target[1]>T&&(s.target[1]=T))}}else s.target[1]=D/2-s.size[1]/2}if(s.position?(s.position[0]+=(s.target[0]-s.position[0])/16,s.position[1]+=(s.target[1]-s.position[1])/16):s.position=s.target.slice(),n.attack&&n.attack.connected&&1===n.attack.time&&(s.shake=30),s.shake){s.shake--;var E=d.power,j=1-s.shake%5/5,B=d.attacker.cell[1]-d.target.cell[1]?1:0;s.offset[B]=Math.sin(2*j*Math.PI)*E*s.shake/30}else s.offset[0]=0,s.offset[1]=0;var P=o.selection||n.selection;if(P){var U=P.unit,_=P.time,N=h.units.indexOf(U),G=n.units[N],K=n.ranges[N];K||(K=n.ranges[N]=function(e,t){var a={move:[t.cell],attack:[]},i=Oi(t),n=[{steps:0,cell:t.cell}];for(i||(n.length=0);n.length;)for(var r=n.shift(),l=bi(r.cell),o=0;o<l.length;o++)if(Mi(e,c=l[o])&&!zi(e,c).solid){for(var s=0;s<a.move.length&&!yi(c,a.move[s]);s++);if(!(s<a.move.length)){if((u=Ii(e,c))||a.move.push(c),u&&!Si(t,u)){for(s=0;s<a.attack.length&&!yi(a.attack[s],c);s++);s===a.attack.length&&a.attack.push(c)}r.steps<i-1&&(!u||Si(t,u))&&n.push({steps:r.steps+1,cell:c})}}for(o=0;o<a.move.length;o++)for(l=bi(a.move[o],t.equipment.weapon.rng),s=0;s<l.length;s++){var c,u;if(Mi(e,c=l[s])&&!zi(e,c).solid&&!yi(t.cell,c)&&(!(u=Ii(e,c))||!Si(t,u))){for(var f=0;f<a.attack.length&&!yi(a.attack[f],c);f++);f===a.attack.length&&a.attack.push(c)}}return a}(h,U));var F=n.squares[N];if(!F){var H=!0,W=!(n.squares[N]=F=[]),J=void 0;try{for(var V,Q=K.move[Symbol.iterator]();!(H=(V=Q.next()).done);H=!0){var X=V.value;F.push({sprite:i.ui.squares.move,cell:X})}}catch(e){W=!0,J=e}finally{try{!H&&Q.return&&Q.return()}finally{if(W)throw J}}var Y=!0,Z=!1,$=void 0;try{for(var ee,te=K.attack[Symbol.iterator]();!(Y=(ee=te.next()).done);Y=!0){var ae=ee.value,ie=!0,ne=!0,re=!1,le=void 0;try{for(var oe,se=K.move[Symbol.iterator]();!(ne=(oe=se.next()).done);ne=!0){if(yi(ae,oe.value)){ie=!1;break}}}catch(e){re=!0,le=e}finally{try{!ne&&se.return&&se.return()}finally{if(re)throw le}}ie&&F.push({sprite:i.ui.squares.attack,cell:ae})}}catch(e){Z=!0,$=e}finally{try{!Y&&te.return&&te.return()}finally{if(Z)throw $}}}o.selection&&n.selection!==o.selection&&(n.selection=P,n.path=null),o.selection&&!c.find(function(e){return e.target===G})&&c.push(Ei("lift",G,Ti.lift())),n.selection&&n.selection!==o.selection&&(n.moved=!1,g&&"lift"===g.type&&(g.done=!0,c.push(Ei("drop",g.target,Ti.drop(g.data.height))),n.selection.time=0));var ce=g&&"move"===g.type&&g.target===G,ue=g&&"attack"===g.type&&g.target===G;if(!n.moved&&ce&&(n.moved=!0),!n.moved){var fe=0;if(o.selection)fe=P.time;else{var he=0,pe=!0,ge=!1,de=void 0;try{for(var me,ve=F[Symbol.iterator]();!(pe=(me=ve.next()).done);pe=!0){var we=me.value,ye=wi(U.cell,we.cell);he<ye&&(he=ye)}}catch(e){ge=!0,de=e}finally{try{!pe&&ve.return&&ve.return()}finally{if(ge)throw de}}fe=Math.max(0,he-P.time)}fe&&(F=F.filter(function(e){return wi(U.cell,e.cell)<=fe}),function(e,t,a){var i=!0,n=!1,r=void 0;try{for(var l,o=a[Symbol.iterator]();!(i=(l=o.next()).done);i=!0){var s=l.value,c=s.sprite,u=16*s.cell[0],f=16*s.cell[1];e.squares.push({image:c,position:[u,f]})}}catch(e){n=!0,r=e}finally{try{!i&&o.return&&o.return()}finally{if(n)throw r}}}(w,i.ui.squares,F))}var be=n.path,xe=Ii(h,o.cell);if(yi(o.cell,U.cell))be&&(be.length=1);else if(t.phase.pending.includes(U)&&o.selection){var ke=K.move.slice(),ze=h.units.filter(function(e){return Si(U,e)}),Ie=!0,Me=!1,Se=void 0;try{for(var Ae,qe=ze[Symbol.iterator]();!(Ie=(Ae=qe.next()).done);Ie=!0){var Oe=Ae.value;ke.push(Oe.cell)}}catch(e){Me=!0,Se=e}finally{try{!Ie&&qe.return&&qe.return()}finally{if(Me)throw Se}}var Re=U.cell;if(be&&be.length&&(Re=be[be.length-1]),K.move.find(function(e){return yi(o.cell,e)}))if(be){for(var Ce=0;Ce<be.length;Ce++){var Le=be[Ce];if(yi(o.cell,Le))break}if(Ce<be.length-1)be.splice(Ce+1,be.length-Ce-1);else{var De,Te=Di(ke.filter(function(t){return!be.find(function(e){return yi(t,e)})}),be[be.length-1],o.cell);if(Te&&be.length+Te.length-2<=Oi(U))Te.shift(),(De=be).push.apply(De,_toConsumableArray(Te));else be=n.path=Di(ke,U.cell,o.cell)}}else be=n.path=Di(ke,U.cell,o.cell);else if(xe&&!Si(U,xe)&&wi(Re,xe.cell)>U.equipment.weapon.rng){var Ee=bi(xe.cell,U.equipment.weapon.rng);if(be){var je=function(){var t=be[Ce];if(xe&&Ee.find(function(e){return yi(t,e)}))return be.splice(Ce+1,be.length-Ce-1),"break"};for(Ce=be.length;Ce--;){if("break"===je())break}}if(!be||-1===Ce){for(var Be=null,Pe=function(e){var t=K.move[e];if(Ee.find(function(e){return yi(t,e)}))return Be=t,"break"},Ue=0;Ue<K.move.length;Ue++){if("break"===Pe(Ue))break}be=n.path=Di(ke,U.cell,Be)}}}if(be&&(o.selection&&!n.moved||ce&&_%2)){var _e,Ne=i.ui.Arrow(be,n.phase.faction);(_e=w.arrows).push.apply(_e,_toConsumableArray(Ne.map(function(e){return{image:e.image,position:[16*e.position[0],16*e.position[1]]}})))}if(n.moved&&!ce&&!ue&&!f.length){var Ge=null,Ke=bi(G.cell,G.equipment.weapon.rng),Fe=[],He=!0,We=!1,Je=void 0;try{for(var Ve,Qe=Ke[Symbol.iterator]();!(He=(Ve=Qe.next()).done);He=!0){var Xe=Ii(h,Ve.value);Xe&&!Si(U,Xe)&&Fe.push(Xe)}}catch(e){We=!0,Je=e}finally{try{!He&&Qe.return&&Qe.return()}finally{if(We)throw Je}}if(Ge=(n.enemies=Fe).length?["attack","wait"]:["wait"],f.push({type:"actions",menu:Li(Ge)}),n.target){var Ye=n.target.unit,Ze=Fe.indexOf(Ye);f.unshift({type:"forecast",menu:Li(Fe,Ze)}),o.cell=Ye.cell.slice(),o.prev=Ye.cell.slice()}}}if(e.state.paused)if(f.length){var $e=A.menu;if($e.done)"end turn"===$e.options[$e.index]&&Ci(t),e.state.paused=!1,f.shift()}else f.push({type:"pause",menu:Li(["end turn"])});var et=16*o.cell[1]+8-s.target[1]>=s.size[1]/2,tt=o.selection||d&&n.selected||o.under,at=n.dialogs.selection;if(!tt||n.selected&&tt!==n.selected||q||A||S&&at&&8===at.name.position[1]||at&&!S&&!d&&(et&&!S&&at&&8!==at.name.position[1]||!et&&at&&8===at.name.position[1])){if(n.selected){n.selected.unit;var it=n.dialogs.selection;it.name.position[0]>-it.name.image.width||it.hp.position[0]>-it.hp.image.width?(it.name.position[0]-=16,it.hp.position[0]-=16):(n.dialogs.selection=null,n.selected=null),w.ui.push(it.name,it.hp)}}else{n.selected||(n.selected=tt);var nt=tt.unit;if(!n.dialogs.selection){var rt=s.size[1]-68;et&&!S&&(rt=0);var lt=i.ui.UnitDetails(nt);n.dialogs.selection={name:{image:lt.name,position:[-lt.name.width,rt+8]},hp:{image:lt.hp,position:[-lt.hp.width,rt+36]}}}var ot=n.dialogs.selection;tt&&(12<=tt.time&&(ot.name.position[0]+=(8-ot.name.position[0])/8),16<=tt.time&&(ot.hp.position[0]+=(8-ot.hp.position[0])/8)),w.ui.push(ot.name,ot.hp)}var st=null,ct=n.dialogs.target;if(S){var ut=S.menu;st=ut.options[ut.index],st=n.target?n.target.unit!==st?{unit:st,time:0}:n.target:n.target={unit:st,time:0},o.cell=st.unit.cell.slice()}else d?st=n.target:o.selection&&o.under&&o.selection!==o.under&&!Si(o.selection.unit,o.under.unit)&&(st=o.under);if(!st||n.target&&st!==n.target||M||S&&ct&&8===ct.name.position[1]||S&&ct&&8===ct.name.position[1]){if(n.target){n.target.unit;var ft=n.dialogs.target;ft.name.position[0]<s.size[0]||ft.hp.position[0]<s.size[0]?(ft.name.position[0]+=16,ft.hp.position[0]+=16):(n.dialogs.target=null,n.target=null),w.ui.push(ft.name,ft.hp)}}else{n.target||(n.target=st);var ht=st.unit;if(!n.dialogs.target){var pt=s.size[1]-68;et&&!S&&(pt=0);var gt=i.ui.UnitDetails(ht);n.dialogs.target={name:{image:gt.name,position:[s.size[0],pt+8]},hp:{image:gt.hp,position:[s.size[0],pt+36]}}}var dt=n.dialogs.target;if(st){if(12<=st.time){var mt=dt.name;mt.position[0]+=(s.size[0]-mt.image.width-8-mt.position[0])/8}if(16<=st.time){var vt=dt.hp;vt.position[0]+=(s.size[0]-vt.image.width-8-vt.position[0])/8}}w.ui.push(dt.name,dt.hp)}if(d){var wt=d.attacker,yt=d.target,bt=d.power,xt=d.damage;if(n.attack||g)g&&"attack"===g.type&&g.data.connected&&(n.attack.connected=!0);else{var kt=h.units.indexOf(wt),zt=n.units[kt];c.push(Ei("attack",zt,Ti.attack(wt.cell,yt.cell))),n.attack={time:0,connected:!1}}if(n.attack&&n.attack.connected){var It=n.attack.time;if(45<=It||!yt.hp&&30<=It)if(!yt.hp&&h.units.includes(yt)){var Mt=h.units.indexOf(yt);h.units.splice(Mt,1)}else c.length||(u.shift(),n.attack=null,d.counter||(Ri(t,wt),o.cell=wt.cell.slice(),o.prev=o.cell.slice()));else{if(1===It)for(var St=[yt.cell[0]-wt.cell[0],yt.cell[1]-wt.cell[1]],At=Math.sqrt(St[0]*St[0]+St[1]*St[1]),qt=[St[0]/At,St[1]/At],Ot=Math.atan2(St[1],St[0]),Rt=[16*yt.cell[0]+8-4*qt[0],16*yt.cell[1]+8-4*qt[1]],Ct=xt/3*48,Lt=0;Lt<Ct;Lt++){var Dt="small";Math.random()<.25&&(Dt="large");var Tt=i.effects[Dt],Et=Ot+1*Math.random()-.5,jt=[-Math.cos(Et)*Math.random()*2,-Math.sin(Et)*Math.random()*2];n.particles.push({position:Rt.slice(),velocity:jt,image:Tt,time:0})}if(It<45){var Bt,Pt=n.dialogs.target.hp.image.getContext("2d"),Ut=0;It<=15?(Ut=It/15,Pt.fillStyle=Bi):30<=It&&It<=45&&(Ut=(It-30)/15,Pt.fillStyle="black"),Bt=Math.ceil(14*xt*Ut),Pt.fillRect(31+14*(yt.hp+xt)-Bt,11,Bt,2);var _t=n.attack.value;if(_t)_t.offset+=_t.velocity,_t.velocity+=.25,0<_t.offset&&(_t.offset=0,_t.velocity*=-1/3);else{var Nt=null;Nt=null===bt?"MISS":0===bt?"0":3===bt?"3!!":bt.toString(),_t=n.attack.value={offset:0,velocity:-2,image:i.ui.Text(Nt)}}w.effects.push({image:_t.image,position:[16*yt.cell[0]+8-_t.image.width/2,16*yt.cell[1]-12+_t.offset]})}}}}for(var Gt=n.particles,Kt=0;Kt<Gt.length;Kt++){var Ft=Gt[Kt];Ft.time++,Ft.position[0]+=Ft.velocity[0],Ft.position[1]+=Ft.velocity[1],Ft.velocity[0]*=.875,Ft.velocity[1]*=.875;var Ht=Math.random();w.effects.push(Ft),Ht<Ft.time/240&&Gt.splice(Kt--,1)}if(M){var Wt=M.menu;if(Wt.done){var Jt=Wt.options[Wt.index];if("wait"===Jt){var Vt=o.selection.unit,Qt=h.units.indexOf(Vt),Xt=n.units[Qt];Vt.cell=Xt.cell,o.selection=null,n.selection=null,n.squares.length=0,n.ranges.length=0,n.moved=!1,g.done=!0,c.push(Ei("drop",g.target,Ti.drop(g.data.height))),Ri(t,Vt),o.cell=Vt.cell.slice(),o.prev=Vt.cell.slice(),f.shift()}else"attack"===Jt&&f.unshift({type:"forecast",menu:Li(n.enemies)})}}var Yt=e.state.menu;if(A||M||S&&1<S.menu.options.length){var Zt=null;A?Zt=A.menu:S?Zt=S.menu:M&&(Zt=M.menu),Yt||(Yt=e.state.menu={data:Zt,box:{size:[0,0],targetSize:null,element:{image:null,position:[144,48]}},cursor:null});var $t=Yt.box;if(Yt.data!==Zt||!$t.targetSize){n.menu.labels.length=0,Yt.cursor=null;var ea=(Yt.data=Zt).options;S&&(ea=ea.map(function(e){return e.name}));var ta=null,aa=!0,ia=!1,na=void 0;try{for(var ra,la=ea[Symbol.iterator]();!(aa=(ra=la.next()).done);aa=!0){var oa=ra.value,sa=i.ui.Text(oa.toUpperCase());(!ta||sa.width>ta.width)&&(ta=sa),n.menu.labels.push(sa)}}catch(e){ia=!0,na=e}finally{try{!aa&&la.return&&la.return()}finally{if(ia)throw na}}$t.size=[0,0],$t.targetSize=[ta.width+36,16*Yt.data.options.length+16]}$t.size[0]+=($t.targetSize[0]-$t.size[0])/4,$t.size[1]+=($t.targetSize[1]-$t.size[1])/4}else if(Yt){var ca=Yt.box;ca.size[0]&&(ca.size[0]-=Math.min(ca.size[0],ca.targetSize[0]/5),ca.size[1]-=Math.min(ca.size[1],ca.targetSize[1]/5))}if(Yt){var ua=Yt.box;if(ua.size[0]&&ua.size[1]){var fa,ha=ua.targetSize[0]-ua.size[0];if(ua.element.image=(fa=i.ui).Box.apply(fa,_toConsumableArray(ua.size.map(Math.round))),n.menu.box=ua.element.image,ha<4){for(var pa=ua.element.image.getContext("2d"),ga=0;ga<n.menu.labels.length;ga++){var da=n.menu.labels[ga];pa.drawImage(da,24,12+16*ga)}var ma=null,va=Yt.data.options[Yt.data.index];if("attack"===va?ma=i.ui.symbols.sword:"wait"===va?ma=i.ui.symbols.clock:"end turn"===va?ma=i.ui.symbols.next:S&&(ma=i.ui.symbols.sword),ma){var wa=l%180/180,ya=Math.sin(2*Math.PI*wa*2),ba=12+16*Yt.data.index-ya;null===Yt.cursor?Yt.cursor=ba:Yt.cursor+=(ba-Yt.cursor)/2,pa.drawImage(ma,12,Yt.cursor)}}w.ui.push(ua.element)}}if(S){var xa=S.menu,ka=xa.options[xa.index];if(!n.dialogs.forecast){var za=i.ui.Text("COMBAT FORECAST"),Ia=i.ui.Box(za.width+28,24),Ma=Ia.getContext("2d"),Sa=i.ui.symbols.eye;Ma.drawImage(Sa,8,8),Ma.drawImage(za,20,8),n.dialogs.forecast={title:{image:Ia,position:[-Ia.width,8]}}}var Aa=n.dialogs.forecast.title;Aa.position[0]+=(8-Aa.position[0])/8,w.ui.push(Aa);var qa=o.selection.unit,Oa=h.units.indexOf(qa),Ra=e.cache.units[Oa],Ca=bi(Ra.cell,qa.equipment.weapon.rng),La=!0,Da=!1,Ta=void 0;try{for(var Ea,ja=Ca[Symbol.iterator]();!(La=(Ea=ja.next()).done);La=!0){var Ba=Ea.value;w.squares.push({image:i.ui.squares.attack,position:[16*Ba[0],16*Ba[1]]})}}catch(e){Da=!0,Ta=e}finally{try{!La&&ja.return&&ja.return()}finally{if(Da)throw Ta}}void 0===m.time?m.time=0:m.time++;var Pa=Math.floor(14),Ua=255*Math.sin(m.time%60/60*Math.PI),_a=wi(Ra.cell,ka.cell),Na=!1,Ga=n.dialogs.target;if(Ga){var Ka=Math.min(ka.hp,_a<=qa.equipment.weapon.rng?Number(qi(qa,ka)):0);if(Ka){ka.hp-Ka<=0&&(Na=!0);var Fa=vi(Ka*Pa,2);Fa.fillStyle="rgb("+Ua+", "+Ua+", "+Ua+")",Fa.fillRect(0,0,Fa.canvas.width,Fa.canvas.height),w.ui.push({image:Fa.canvas,position:[Ga.hp.position[0]+31+(ka.hp-Ka)*Pa,Ga.hp.position[1]+11]})}}if(!Na){var Ha=n.dialogs.selection;if(Ha){var Wa=Math.min(qa.hp,_a<=ka.equipment.weapon.rng?Number(qi(ka,qa)):0);if(Wa){var Ja=vi(Wa*Pa,2);Ja.fillStyle="rgb("+Ua+", "+Ua+", "+Ua+")",Ja.fillRect(0,0,Ja.canvas.width,Ja.canvas.height),w.ui.push({image:Ja.canvas,position:[Ha.hp.position[0]+31+(qa.hp-Wa)*Pa,Ha.hp.position[1]+11]})}}}if(xa.done){qa.cell=Ra.cell;var Va=qi(qa,ka),Qa=Math.min(ka.hp,Number(Va));if(Ai(qa,ka),u.push({attacker:qa,target:ka,power:Va,damage:Qa,counter:!1}),!Na&&_a<=ka.equipment.weapon.rng){var Xa=qi(ka,qa),Ya=Math.min(qa.hp,Number(Xa));Ai(ka,qa),u.push({attacker:ka,target:qa,power:Xa,damage:Ya,counter:!0})}n.squares.length=0,n.ranges.length=0,n.moved=!1,o.selection=null,n.selection=null,f.length=0,g.done=!0}}else{var Za=n.dialogs.forecast;if(Za){var $a=Za.title;$a.position[0]>-$a.image.width?($a.position[0]-=Math.max(16,-$a.image.width-$a.position[0]),w.ui.push($a)):n.dialogs.forecast=null}}var ei=n.dialogs.objective;if(!ei){var ti=i.ui.TextBox("OBJECTIVE"),ai=i.ui.TextBox("Defeat all enemies");ei=n.dialogs.objective={lastUpdate:null,time:0,title:{image:ti,position:[s.size[0],s.size[1]-ti.height-36]},body:{image:ai,position:[s.size[0],s.size[1]-ai.height-8]}}}if(h.units.length!==ei.lastUpdate){var ii=h.units.filter(function(e){return"enemy"===e.faction}),ni=ii.length;ei.body.image=i.ui.TextBox("Defeat ("+ni+") enem"+(1===ni?"y":"ies")),ei.lastUpdate=ii.length}var ri=ei,li=ri.title,oi=ri.body;o.selection||o.under||n.attack||A||!(wi(o.cell,o.prev)<.001)||et!==(8===li.position[1])&&(li.position[0]!==s.size[0]||oi.position[0]!==s.size[0])?ei.time=0:ei.time||(ei.time=1);if(ei.time&&(li.position[0]===s.size[0]&&(et?(li.position[1]=8,oi.position[1]=36):(li.position[1]=s.size[1]-li.image.height-36,oi.position[1]=s.size[1]-oi.image.height-8)),90<=++ei.time&&(li.position[0]+=(s.size[0]-li.image.width-8-li.position[0])/8),94<=ei.time&&(oi.position[0]+=(s.size[0]-oi.image.width-8-oi.position[0])/8)),ei.time<90&&(li.position[0]<s.size[0]||oi.position[0]<s.size[0])&&(li.position[0]+=Math.min(16,s.size[0]-li.position[0]),oi.position[0]+=Math.min(16,s.size[0]-oi.position[0]),ei.time=0),w.ui.push(li,oi),q){var si=0,ci=g.data,ui=i.ui.phases[g.target];if("enter"===ci.state){var fi=-ui.width,hi=s.size[0]/2-ui.width/2-3;si=ci.text.x*(hi-fi)+fi}else if("pass"===ci.state){var pi=s.size[0]/2-ui.width/2-3;si=6*ci.text.x+pi}else if("exit"===ci.state){var gi=s.size[0]/2-ui.width/2+3,di=s.size[0];si=ci.text.x*(di-gi)+gi}var mi=vi(256*(ci.bg.width-ci.bg.x),2+10*ci.bg.height);mi.fillStyle="player"===g.target?ji:Bi,mi.fillRect(0,0,mi.canvas.width,mi.canvas.height),mi.canvas.width&&w.ui.push({image:mi.canvas,position:[256*ci.bg.x,s.size[1]/2-mi.canvas.height/2]}),w.ui.push({image:ui,position:[si,s.size[1]/2-ui.height/2]})}n.attack&&3===n.attack.power&&7===n.attack.time?(a.fillStyle="white",a.fillRect(0,0,a.canvas.width,a.canvas.height)):(d||A||q||(M||n.moved)&&!S||function(e,t,a,i){var n=i.state.time,r=(i.cache,a.cell[0]-a.prev[0]),l=a.cell[1]-a.prev[1],o=Math.abs(r)+Math.abs(l);a.prev[0]+=r/4,a.prev[1]+=l/4;var s=0;a.selection&&!i.state.dialogs.length?s=1:o<.001&&(s=Math.floor(n/30)%2);var c=16*a.prev[0],u=16*a.prev[1],f=t[i.cache.phase.faction][s];e.cursor.push({image:f,position:[c,u]})}(w,i.ui.cursor,o,e),function(e,t,a,i){for(var n=a.map,r=(a.phase,i.cache),l=i.state.attacks,o=i.state.anims,s=o[0],c=0;c<r.units.length;c++){var u=r.units[c],f=u.original,h=u.cell,p=16*h[0],g=16*h[1],d=0,m=t[u.faction][Pi[u.type]];if(!r.phase.pending||r.phase.pending.includes(f)||r.phase.faction!==u.faction||l.length&&l[0].target===f||s&&s.target===u&&("move"===s.type||"attack"===s.type)||(m=t.done[u.faction][Pi[u.type]]),n.units[c]===f?yi(u.cell,f.cell)||r.moved||(s.done=!0,s=o[0]=Ei("move",u,Ti.move(r.path))):o.length||(s&&(s.done=!0),s=o[0]=Ei("fade",u,Ti.fade())),s&&s.target===u){if("lift"===s.type||"drop"===s.type)d=s.data.height;else if("move"===s.type||"attack"===s.type)p=16*s.data.cell[0],g=16*s.data.cell[1];else if("fade"===s.type){if(s.done){r.units.splice(c--,1);continue}if(!s.data.visible)continue}e.selection.push({image:m,position:[p,g-d]})}else{if(r.attack){var v=l[0];v.target===f&&v.damage&&r.attack.connected&&r.attack.time<30&&r.attack.time%2&&(m=t.flashing)}e.pieces.push({image:m,position:[p,g]})}e.shadows.push({image:t.shadow,position:[p+1,g+4]})}}(w,i.pieces,t,e),function(e,t,a,i){var n=!0,r=!1,l=void 0;try{for(var o,s=t[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var c=o.value,u=e[c];"ui"!==c&&u.sort(function(e,t){return e.position[1]-t.position[1]});var f=!0,h=!1,p=void 0;try{for(var g,d=u[Symbol.iterator]();!(f=(g=d.next()).done);f=!0){var m=g.value,v=Math.round(m.position[0]),w=Math.round(m.position[1]-(m.position[2]||0));"ui"!==c&&(v-=a.position[0]+a.offset[0],w-=a.position[1]+a.offset[1]),i.drawImage(m.image,v,w)}}catch(e){h=!0,p=e}finally{try{!f&&d.return&&d.return()}finally{if(h)throw p}}}}catch(e){r=!0,l=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw l}}}(w,v,s,a)),(c.length||d)&&n.phase.pending||(n.phase.faction!==t.phase.faction&&(o.cell=t.phase.pending[0].cell.slice(),c.push(Ei("phase",t.phase.faction,Ti.phase()))),n.phase={pending:t.phase.pending.slice(),faction:t.phase.faction})}var T=15,E=3;function j(t,e,a,i){var n=e.held,r=e.prev,l=a.map,o=a.phase;if(n.confirm&&!r.confirm)if(t.selection){var s=t.selection.unit;if(o.pending.includes(s)){var c=l.units.indexOf(s),u=i.cache.units[c],f=i.cache.ranges[c];if(f){var h=i.cache.path;if(h&&h.length){var p=h[h.length-1].slice();if(f.move.find(function(e){return yi(e,t.cell)}))A(u,p);else if(f.attack.find(function(e){return yi(e,t.cell)})&&(A(u,p),!i.cache.target)){var g=Ii(l,t.cell);i.cache.target={unit:g,time:0}}}else i.cache.moved=!0}}else B(t)}else t.under&&(t.selection=t.under,t.selection.time=0);if(n.mod&&t.selection&&o.pending.includes(t.selection.unit)){var d=t.selection.unit,m=l.units.indexOf(d),v=i.cache.ranges[m];if(!n.left||r.left||n.right){if(n.right&&!r.right&&!n.left){for(y=t.cell[0];y<l.layout.size[0];y++){for(b=0;b<v.move.length;b++){var w=v.move[b];if(w[0]===y+1&&w[1]===t.cell[1])break}if(b===v.move.length)break}t.cell[0]=y}}else{for(var y=t.cell[0];0<=y;y--){for(var b=0;b<v.move.length;b++){var x=v.move[b];if(x[0]===y-1&&x[1]===t.cell[1])break}if(b===v.move.length)break}t.cell[0]=y}if(!n.up||r.up||n.down){if(n.down&&!r.down&&!n.up){for(z=t.cell[1];z<l.layout.size[1];z++){for(b=0;b<v.move.length;b++){var k=v.move[b];if(k[1]===z+1&&k[0]===t.cell[0])break}if(b===v.move.length)break}t.cell[1]=z}}else{for(var z=t.cell[1];0<=z;z--){for(var b=0;b<v.move.length;b++){var I=v.move[b];if(I[1]===z-1&&I[0]===t.cell[0])break}if(b===v.move.length)break}t.cell[1]=z}}else(n.left&&!r.left||n.left>T&&!(n.left%E))&&!n.right?P(t,"left",l):(n.right&&!r.right||n.right>T&&!(n.right%E))&&!n.left&&P(t,"right",l),(n.up&&!r.up||n.up>T&&!(n.up%E))&&!n.down?P(t,"up",l):(n.down&&!r.down||n.down>T&&!(n.down%E))&&!n.up&&P(t,"down",l);var M=Ii(l,t.cell);if(M?t.under&&M===t.under.unit?t.under.time++:!t.under&&i.cache.selected&&i.cache.selected.unit===M?t.under=i.cache.selected:t.under={unit:M,time:0}:t.under=null,!t.selection&&n.select&&!r.select){var S=n.mod;!function(e,t,a){var i=t.map,n=t.phase,r=Ii(i,e.cell);if(!r)return(r=n.pending.find(function(e){return e.faction===n.faction}))&&(e.cell=r.cell.slice());var l=r.faction===n.faction?n.pending:i.units.filter(function(e){return e.faction===r.faction}),o=l.indexOf(r),s=null;s=a?0<=o-1?l[o-1]:l[l.length-1]:o+1<l.length?l[o+1]:l[0];s&&(e.cell=s.cell.slice())}(t,a,S)}}function B(e){e.selection=null}function P(e,t,a){var i=a.layout.size;"left"===t?--e.cell[0]<0&&(e.cell[0]=0):"right"===t?++e.cell[0]>=i[0]&&(e.cell[0]=i[0]-1):"up"===t?--e.cell[1]<0&&(e.cell[1]=0):"down"===t&&++e.cell[1]>=i[1]&&(e.cell[1]=i[1]-1)}var U,_={left:["KeyA","ArrowLeft"],up:["KeyW","ArrowUp"],right:["KeyD","ArrowRight"],down:["KeyS","ArrowDown"],confirm:["Space"],cancel:["Escape"],select:["Tab"],mod:["ShiftLeft"]};(U="sprites.png",new Promise(function(e,t){var a=new Image;a.src=U,a.onload=function(){e(a)},a.onerror=function(){t(new Error("Failed to load image `"+U+"`"))}})).then(function(e){var d=(a=256,i=240,n=l(e),r=document.createElement("canvas"),r.width=a,r.height=i,{sprites:n,context:r.getContext("2d"),state:{time:0,anims:[Ei("phase","player",Ti.phase())],cursor:{cell:null,prev:null,selection:null,under:null},viewport:{size:[a,i],position:null,offset:[0,0],target:null,shake:0},menu:null,paused:!1,attacks:[],dialogs:[]},cache:{map:null,selection:null,selected:null,target:null,moved:!1,attack:null,phase:{pending:null,faction:"player"},units:null,ranges:[],squares:[],particles:[],menu:{box:null,labels:[]},dialogs:{objective:null,selection:null,target:null}}}),t=d.context.canvas;var a,i,n,r;document.querySelector("main").appendChild(t),function e(){D(d,K);!function(e){var t=e.cache,a=e.state;a.time++;var i=a.cursor;i.selection?i.selection.time++:t.selection&&t.selection.time++,t.target&&t.target.time++,t.attack&&t.attack.connected&&t.attack.time++;var n=e.state.anims,r=n[0];r&&(r.done?n.shift():Ti[r.type].update(r))}(d);var t=F.held,a=F.prev;var i=d.state.cursor;var n=d.state.anims;var r=d.state.dialogs;var l=r[0];l?(o=l.menu,c=(s=F).held,u=s.prev,c.confirm&&!u.confirm&&(o.done=!0),o.done||(c.select&&!u.select?m(o,c.mod):!c.up||u.up||c.down?!c.down||u.down||c.up||m(o):m(o,!0))):d.state.attacks.length||d.cache.moved||n.length&&"phase"===n[0].type||j(i,F,K,d);var o,s,c,u;if(t.cancel&&!a.cancel){var f=d.state.anims[0];if(!f||"move"!==f.type)if(l){if("pause"===l.type)d.state.paused=!1;else if("actions"===l.type){var h=d.state.cursor.selection.unit,p=K.map.units.indexOf(h);d.cache.units[p].cell=h.cell,d.cache.moved=null}r.shift(),r.length&&"actions"===(l=r[0]).type&&(l.menu.done=!1)}else i.selection?B(i):d.state.attacks.length||f&&"phase"===f.type||(d.state.paused=!0)}g=F,Object.assign(g.prev,g.held);var g;requestAnimationFrame(e)}()});var N,G,K=(G=(N=e).units.map(function(e){return function(e,t,a,i,n){return{name:e,type:t,faction:a,ai:i,cell:n,hp:3,stats:p[t],equipment:d[t]}}.apply(void 0,_toConsumableArray(e))}),{map:{layout:N.layout,units:G},phase:{faction:"player",pending:G.filter(function(e){return"player"===e.faction})}}),F={held:function(e,i){var n={},r=!1;function t(e){var t=null;if(i)for(var t in i){for(var a=0;a<i[t].length&&i[t][a]!==e.code;a++);if(a<i[t].length)break;t=null}t||(t=e.code),"keydown"===e.type?n[t]||(n[t]=1):"keyup"===e.type&&(n[t]=0),r||(r=!0,requestAnimationFrame(l))}function l(){for(var e in n)n[e]&&n[e]++;requestAnimationFrame(l)}return e.addEventListener("keydown",t),e.addEventListener("keyup",t),n}(window,_),prev:{}};window.addEventListener("keydown",function(e){"Tab"===e.code&&e.preventDefault()})}();