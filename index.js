"use strict";var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var a=[],i=!0,n=!1,r=void 0;try{for(var o,l=e[Symbol.iterator]();!(i=(o=l.next()).done)&&(a.push(o.value),!t||a.length!==t);i=!0);}catch(e){n=!0,r=e}finally{try{!i&&l.return&&l.return()}finally{if(n)throw r}}return a}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}!function(){var a={piece:{palette:[188,128,3,3],shadow:[160,32,14,14],symbols:{shield:[160,88,8,8],bow:[136,72,8,8],dagger:[112,88,8,8],axe:[112,112,8,8],hat:[176,64,8,8]},base:[16,176,16,16]},tiles:{"shadow-corner":[160,64,16,16],black:[112,72,16,16],"wall-base":[0,176,16,16],floor:[144,48,16,16],"shadow-edge":[144,32,16,16],grass:[176,0,16,16],wall:[96,112,16,16]},effects:{attack:[0,164,192,12]},ui:{cursor:[144,0,32,32],box:[64,64,48,48],squares:[64,112,32,16],arrows:[0,0,64,128],"enemy-phase":[0,146,170,18],healthbar:[112,64,48,8],symbols:{dragon:[128,72,8,8],shield:[160,80,8,8],bow:[176,16,8,8],boot:[32,176,8,8],dagger:[160,48,8,8],sword:[174,32,8,8],next:[176,24,8,8],eye:[184,16,8,8],clock:[112,120,8,8],axe:[120,112,8,8],hat:[112,96,8,8],enemy:[120,88,8,8],lance:[128,80,8,8]},"player-phase":[0,128,188,18],typeface:[64,0,80,64],swords:[170,146,16,18]}};function g(e,t,a,i,n){var r=document.createElement("canvas"),o=r.getContext("2d");return r.width=i,r.height=n,o.drawImage(e,-t,-a),r}var x={get:function(e,t,a){var i=4*(a*e.width+t),n=e.data[i],r=e.data[i+1],o=e.data[i+2],l=e.data[i+3];return[n,r,o,l]},set:function(e,t,a,i){var n=4*(a*e.width+t);e.data[n+0]=i[0],e.data[n+1]=i[1],e.data[n+2]=i[2],e.data[n+3]=i[3]},replace:function(e,t,a){for(var i=0;i<e.data.length;i+=4){for(var n=0;n<4&&e.data[i+n]===t[n];n++);if(4===n)for(var n=0;n<4;n++)e.data[i+n]=a[n]}}};function rn(e,t){var a=document.createElement("canvas");return a.width=e,a.height=t,a.getContext("2d")}var z={black:[0,0,0,255],white:[255,255,255,255]},c={warrior:"axe",knight:"shield",rogue:"dagger",mage:"hat"};function o(e){var t=function e(t,a){var i={};for(var n in a)if(Array.isArray(a[n])){var r=_slicedToArray(a[n],4),o=r[0],l=r[1],s=r[2],c=r[3];i[n]=g(t,o,l,s,c)}else i[n]=e(t,a[n]);return i}(e,a);return{tiles:t.tiles,pieces:function(e){var t={player:{},enemy:{},ally:{},done:{player:{},enemy:{},ally:{}},flashing:null,symbols:e.symbols,shadow:e.shadow},a=e.palette.getContext("2d").getImageData(0,0,3,3);Object.assign(z,{cyan:x.get(a,0,0),blue:x.get(a,1,0),navy:x.get(a,2,0),pink:x.get(a,0,1),red:x.get(a,1,1),purple:x.get(a,2,1),lime:x.get(a,0,2),green:x.get(a,1,2),teal:x.get(a,2,2)});var i={player:[z.cyan,z.blue,z.navy],enemy:[z.pink,z.red,z.purple],ally:[z.lime,z.green,z.teal]};for(var n in i){var r=i[n];for(var o in e.symbols){var l=e.symbols[o],s=rn(l.width,l.height);s.drawImage(l,0,0);var c=e.base.getContext("2d").getImageData(0,0,16,16);x.replace(c,z.white,r[1]),x.replace(c,z.black,r[2]);var u=rn(c.width,c.height);u.putImageData(c,0,0);var f=s.getImageData(0,0,l.width,l.height);x.replace(f,z.white,r[0]),s.putImageData(f,0,0),u.drawImage(s.canvas,4,4),x.replace(f,r[0],r[2]),s.putImageData(f,0,0),u.drawImage(s.canvas,4,3),t[n][o]=u.canvas}}for(var h in i){var g=i[h];for(var p in e.symbols){var d=e.symbols[p],m=rn(d.width,d.height);m.drawImage(d,0,0);var v=e.base.getContext("2d").getImageData(0,0,16,16);x.replace(v,z.white,g[2]);var y=rn(v.width,v.height);y.putImageData(v,0,0);var w=m.getImageData(0,0,d.width,d.height);x.replace(w,z.white,g[1]),m.putImageData(w,0,0),y.drawImage(m.canvas,4,4),x.replace(w,g[1],z.black),m.putImageData(w,0,0),y.drawImage(m.canvas,4,3),t.done[h][p]=y.canvas}}var b=e.base.getContext("2d").getImageData(0,0,16,16);x.replace(b,z.black,z.white);var k=rn(b.width,b.height);return k.putImageData(b,0,0),t.flashing=k.canvas,t}(t.piece),ui:function(o){var y={symbols:o.symbols,swords:o.swords,cursor:(e=o.cursor,{player:[g(e,0,0,16,16),g(e,16,0,16,16)],enemy:[g(e,0,16,16,16),g(e,16,16,16,16)]}),typeface:p(o.typeface),healthbar:o.healthbar,phases:{player:o["player-phase"],enemy:o["enemy-phase"]},box:{topLeft:g(o.box,0,0,16,16),top:g(o.box,16,0,16,16),topRight:g(o.box,32,0,16,16),left:g(o.box,0,16,16,16),center:g(o.box,16,16,16,16),right:g(o.box,32,16,16,16),bottomLeft:g(o.box,0,32,16,16),bottom:g(o.box,16,32,16,16),bottomRight:g(o.box,32,32,16,16)},squares:{move:g(o.squares,0,0,16,16),attack:g(o.squares,16,0,16,16)},arrows:{player:{left:g(o.arrows,0,0,16,16),right:g(o.arrows,16,0,16,16),up:g(o.arrows,32,0,16,16),down:g(o.arrows,48,0,16,16),leftStub:g(o.arrows,0,16,16,16),rightStub:g(o.arrows,16,16,16,16),upStub:g(o.arrows,32,16,16,16),downStub:g(o.arrows,48,16,16,16),upLeft:g(o.arrows,0,32,16,16),upRight:g(o.arrows,16,32,16,16),downLeft:g(o.arrows,32,32,16,16),downRight:g(o.arrows,48,32,16,16),horiz:g(o.arrows,0,48,16,16),vert:g(o.arrows,16,48,16,16)},enemy:{left:g(o.arrows,0,64,16,16),right:g(o.arrows,16,64,16,16),up:g(o.arrows,32,64,16,16),down:g(o.arrows,48,64,16,16),leftStub:g(o.arrows,0,80,16,16),rightStub:g(o.arrows,16,80,16,16),upStub:g(o.arrows,32,80,16,16),downStub:g(o.arrows,48,80,16,16),upLeft:g(o.arrows,0,96,16,16),upRight:g(o.arrows,16,96,16,16),downLeft:g(o.arrows,32,96,16,16),downRight:g(o.arrows,48,96,16,16),horiz:g(o.arrows,0,112,16,16),vert:g(o.arrows,16,112,16,16)}}},l={};var e;return y.Text=u,y.Box=h,y.TextBox=function(e){var t=0,a=0,i=null;if(Array.isArray(e)){i=e.map(function(e){return u(e)});var n=e.map(function(e){return e.width}),r=Math.max.apply(Math,_toConsumableArray(n));t=r,a=8*e.length}else i=u(e),t=i.width,a=8;var o=h(t+16,a+16),l=rn(t,a);if(Array.isArray(e))for(var s=0;s<i.length;s++){var c=i[s];l.drawImage(c,0,8*s)}else l.drawImage(i,0,0);return l.canvas.width&&o.getContext("2d").drawImage(l.canvas,8,8),o},y.HealthBar=s,y.UnitDetails=function(e){var t=y.symbols[c[e.type]],a=u(e.name),i=h(a.width+t.width+20,24),n=i.getContext("2d");n.drawImage(t,8,8),n.drawImage(a,20,8);var r=h(84,24),o=s(e.hp/3,e.faction),l=u("HP");return(n=r.getContext("2d")).drawImage(l,8,8),n.drawImage(o,28,8),{name:i,hp:r}},y.Arrow=function(e,t){for(var a=[],i=0;i<e.length;i++){var n=_slicedToArray(e[i],2),r=n[0],o=n[1],l=!1,s=!1,c=!1,u=!1,f=e[i-1];if(f){var h=r-f[0],g=o-f[1];1===h?l=!0:-1===h&&(s=!0),1===g?c=!0:-1===g&&(u=!0)}var p=e[i+1];if(p){var d=p[0]-r,m=p[1]-o;-1===d?l=!0:1===d&&(s=!0),-1===m?c=!0:1===m&&(u=!0)}if(l||s||c||u){var v=null;l&&s?v="horiz":c&&u?v="vert":c&&l?v="upLeft":c&&s?v="upRight":u&&l?v="downLeft":u&&s?v="downRight":l&&!i?v="leftStub":s&&!i?v="rightStub":c&&!i?v="upStub":u&&!i?v="downStub":l?v="left":s?v="right":c?v="up":u&&(v="down"),v&&a.push({image:y.arrows[t][v],position:[r,o]})}}return a},y;function u(e,t){for(var a=0,i=0;i<e.length;i++){var n=e[i];a+=" "===n?4:8}var r=document.createElement("canvas");r.width=a,r.height=8;for(var o=r.getContext("2d"),l=0,s=0;l<e.length;l++){var c=e[l];if(" "===c)s+=4;else{var u=f(c,t);o.drawImage(u,s,0),s+=8}}return r}function f(e,t){if(!t)return y.typeface[e];if(l[t])return l[t][e];var a=o.typeface,i=a.getContext("2d").getImageData(0,0,a.width,a.height);console.log(t),x.replace(i,z.white,t);var n=rn(a.width,a.height);n.putImageData(i,0,0);var r=p(n.canvas);return(l[t]=r)[e]}function h(e,t){var a=Math.ceil(e/16),i=Math.ceil(t/16),n=document.createElement("canvas"),r=n.getContext("2d");n.width=e,n.height=t;for(var o=1;o<a-1;o++)r.drawImage(y.box.top,16*o,0),r.drawImage(y.box.bottom,16*o,t-16);for(var l=1;l<i-1;l++)r.drawImage(y.box.left,0,16*l),r.drawImage(y.box.right,e-16,16*l);return r.fillRect(4,4,n.width-8,n.height-8),r.drawImage(y.box.topLeft,0,0),r.drawImage(y.box.topRight,n.width-16,0),r.drawImage(y.box.bottomLeft,0,n.height-16),r.drawImage(y.box.bottomRight,n.width-16,n.height-16),n}function s(e,t){var a=rn(48,8);return a.drawImage(y.healthbar,0,0),a.fillStyle={player:"rgb(144, 224, 232)",enemy:"rgb(248, 192, 224)",ally:"rgb(200, 224, 255)"}[t],a.fillRect(3,3,Math.floor(42*e),2),a.canvas}}(t.ui),effects:function(){var e=rn(1,1);e.fillStyle="white",e.fillRect(0,0,1,1);var t=rn(2,2);return t.fillStyle="white",t.fillRect(0,0,2,2),{small:e.canvas,large:t.canvas}}()}}function p(e){for(var t=e.width/8,a=e.height/8,i={},n=0,r=0;r<a;r++)for(var o=0;o<t;o++){i["0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,.!?abcdefghijklmnopqrstuvwxyz;:'\"()/\\-     "[n++]]=g(e,8*o,8*r,8,8)}return i}var t={name:"grass",solid:!1},i={name:"wall",solid:!0},n={name:"floor",solid:!1};"##########################      ##.......##      ##      ##.......##      ##      ##.......##      ##      ####...####      ##      ####...####      ##      ##.......##      ##    ####.......####    ##    ####.......####    ##    ...............    ##    ####.......####    ##    ####.......####    ##      ##.......##      ##      ###########      ##      ###########      ##                       ##                       ##      ##       ##      ##      ##       ##      ##########       ##################       #########                                                                                                    ".split("").map(function(e){switch(e){case" ":return t;case"#":return i;case".":return n}});var r={name:"grass",solid:!1},l={name:"floor",solid:!1},s={name:"wall",solid:!0},e={tiles:{grass:r,floor:l,wall:s},layout:{size:[20,20],data:["           #########","       ##  #......##"," #     ##  ##......#"," #         ##....###","        #   ###..###","        # #####...##","      ##  ###.#...# ","      ##  #.......# ","          ....##### ","#         ##..##### ","#    #    #####     ","     #     ####     ","                    ","                    ","        ##    #     ","        ##    #     "," #               ## "," ##    #         ## "," ##    #            ","                    "].join("").split("").map(function(e){switch(e){case" ":return r;case".":return l;case"#":return s}})},units:[["Hector","warrior","player",!1,[5,16]],["Oswin","knight","player",!1,[6,14]],["Erk","mage","player",!1,[4,13]],["Matthew","rogue","player",!1,[3,15]],["Nergal","mage","enemy","defend",[15,1]],["GOLEM","knight","enemy","wait",[13,2]],["GOLEM","knight","enemy","wait",[17,1]],["TROLL","knight","enemy","defend",[15,4]],["TROLL","knight","enemy","defend",[16,4]],["ORC","warrior","enemy","attack",[17,5]],["TROLL","knight","enemy","defend",[10,8]],["GOBLIN","rogue","enemy","attack",[8,6]],["ORC","warrior","enemy","attack",[5,8]],["TROLL","knight","enemy","attack",[2,6]],["GOBLIN","rogue","enemy","attack",[9,12]],["ORC","warrior","enemy","attack",[7,12]],["TROLL","knight","enemy","attack",[19,6]],["TROLL","knight","enemy","attack",[19,7]],["TROLL","knight","enemy","attack",[0,0]],["TROLL","knight","enemy","attack",[0,1]]]};function on(e,t){return Math.abs(t[0]-e[0])+Math.abs(t[1]-e[1])}function u(e){return e[0]}function f(e){return e[1]}function ln(e,t){return u(e)===u(t)&&f(e)===f(t)}function sn(e,t){t||(t=1);for(var a=[{steps:0,cell:e}],i=[];a.length;)for(var n=a.shift(),r=[[u(n.cell)-1,f(n.cell)],[u(n.cell)+1,f(n.cell)],[u(n.cell),f(n.cell)-1],[u(n.cell),f(n.cell)+1]],o=0;o<r.length;o++){var l=r[o];if(!ln(e,l)){for(var s=0;s<i.length;s++){if(ln(l,i[s]))break}s<i.length||(i.push(l),n.steps+1<t&&a.push({steps:n.steps+1,cell:l}))}}return i}function cn(e){return e.layout.size[0]}function un(e){return e.layout.size[1]}function fn(e,t){return e.layout.data[f(t)*cn(e)+u(t)]}function hn(e,t){for(var a=0;a<e.units.length;a++){var i=e.units[a];if(ln(t,i.cell))return i}}function h(e,t){return 0<=u(t)&&u(t)<cn(e)&&0<=f(t)&&f(t)<un(e)}function gn(e,t){var a={move:[t.cell],attack:[]},i=vn(t),n=[{steps:0,cell:t.cell}];for(i||(n.length=0);n.length;)for(var r=n.shift(),o=sn(r.cell),l=0;l<o.length;l++){if(h(e,c=o[l])&&!fn(e,c).solid){for(var s=0;s<a.move.length&&!ln(c,a.move[s]);s++);if(!(s<a.move.length)){if((u=hn(e,c))||a.move.push(c),u&&!pn(t,u)){for(s=0;s<a.attack.length&&!ln(a.attack[s],c);s++);s===a.attack.length&&a.attack.push(c)}r.steps<i-1&&(!u||pn(t,u))&&n.push({steps:r.steps+1,cell:c})}}}for(l=0;l<a.move.length;l++)for(o=sn(a.move[l],t.equipment.weapon.rng),s=0;s<o.length;s++){var c,u;if(h(e,c=o[s])&&!fn(e,c).solid&&!ln(t.cell,c))if(!(u=hn(e,c))||!pn(t,u)){for(var f=0;f<a.attack.length&&!ln(a.attack[f],c);f++);f===a.attack.length&&a.attack.push(c)}}return a}function pn(e,t){return e.faction===t.faction||"player"===e.faction&&"ally"===t.faction||"ally"===e.faction&&"player"===t.faction}function O(e,t,a){e.cell=t}function dn(e,t){var a=mn(e,t);return a&&(t.hp-=Math.min(t.hp,a)),a}function mn(e,t){var a,i,n,r;if((r=(n=e).equipment.weapon,n.stats.agi+(r?r.acc:0)-(i=(a=t).equipment.armor,a.stats.agi-(i?i.wt:0)))<0)return null;if("warrior"===e.type)switch(t.type){case"warrior":case"knight":return 2;case"rogue":return 0;case"mage":return 3}else if("knight"===e.type)switch(t.type){case"warrior":return 2;case"knight":return 1;case"rogue":case"mage":return 2}else if("rogue"===e.type)switch(t.type){case"warrior":return 2;case"knight":return 0;case"rogue":return 1;case"mage":return 2}else if("mage"===e.type)switch(t.type){case"warrior":return 2;case"knight":case"rogue":case"mage":return 1}}function H(e){return e.equipment.weapon.rng}function vn(e){if("defend"===e.ai)return 0;var t=e.equipment.armor;return 5-(t?t.wt:0)+Math.floor(e.stats.agi/2)}var d={warrior:{str:2,int:0,agi:1},knight:{str:1,int:0,agi:0},rogue:{str:1,int:1,agi:2},mage:{str:1,int:1,agi:1}},m={axe:{target:"str",atk:2,acc:0,rng:1},lance:{target:"str",atk:3,acc:2,rng:1},dagger:{target:"str",atk:2,acc:1,rng:1},tome:{target:"int",atk:1,acc:1,rng:2}},v={warrior:{weapon:m.axe,armor:null},knight:{weapon:m.lance,armor:{def:2,wt:1}},rogue:{weapon:m.dagger,armor:null},mage:{weapon:m.tome,armor:null}};function yn(e,t){var a=e.phase.pending,i=a.indexOf(t);return-1!==i&&(a.splice(i,1),a.length||wn(e),!0)}function wn(e){var t=e.map,a=e.phase;a.faction="player"===a.faction?"enemy":"player",a.pending=t.units.filter(function(e){return e.faction===a.faction}),a.pending.length||wn(e)}function bn(e,t){return{options:e,index:t||0,done:!1}}function K(e,t){t?--e.index<0&&(e.index=e.options.length-1):++e.index>=e.options.length&&(e.index=0)}function kn(e,t,a){for(var i=[],n=[t],r={},o={},l={},s={},c={},u=0;u<e.length;u++){s[h=e[u]]=1/0,c[h]=1/0}for(s[t]=0,c[t]=on(t,a);n.length;){var f={score:1/0,index:-1,cell:null};for(u=0;u<n.length;u++){(m=c[h=n[u]])<f.score&&(f.score=m,f.index=u,f.cell=h)}var h;if(ln(h=f.cell,a)){for(;!ln(h,t);)i.unshift(h),h=l[h];return i.unshift(h),i}n.splice(f.index,1),r[h]=!1,o[h]=!0;var g=sn(h);for(u=0;u<g.length;u++){var p=g[u];if(!o[p]){for(var d=0;d<e.length;d++){if(ln(e[d],p))break}var m;if(d!==e.length)r[p]||(r[p]=!0,n.push(p)),(m=s[h]+1)>=s[p]||(l[p]=h,s[p]=m,c[p]=m+on(p,a))}}}}function y(){return{height:0,time:0,floating:!1}}y.update=function(e){if(!e.done){var t=e.data;if(t.time++,e.floating){var a=t.time%120/120;t.height=4+Math.sin(2*Math.PI*a)}else 4==++t.height&&(e.floating=!0)}};var w=Object.freeze({default:y});function b(e){return{height:Math.round(e||4)}}b.update=function(e){e.done||--e.data.height||(e.done=!0)};var k=Object.freeze({default:b});function I(e){return{path:e,cell:e[0].slice(),time:0}}I.update=function(e){if(e.done)return!1;var t=e.data,a=Math.floor(t.time/4),i=t.time%4*.25,n=t.path[a],r=t.path[a+1];return r?t.cell=[n[0]+(r[0]-n[0])*i,n[1]+(r[1]-n[1])*i]:(t.cell=n.slice(),e.done=!0),t.time++,!0};var M=Object.freeze({default:I});function S(e,t){var a=[t[0]-e[0],t[1]-e[1]],i=Math.sqrt(a[0]*a[0]+a[1]*a[1]);return{src:e,norm:[a[0]/i,a[1]/i],cell:e.slice(),time:0,connected:!1}}S.update=function(e){if(!e.done){var t=e.data,a=t.time<=7?t.time:7-(t.time-7);8<=t.time&&(t.connected=!0),t.cell[0]=t.src[0]+t.norm[0]/8*a,t.cell[1]=t.src[1]+t.norm[1]/8*a,15==++t.time&&(e.done=!0)}};var q=Object.freeze({default:S});function A(){return{time:0,flashing:!1}}A.update=function(e){if(!e.done){var t=e.data;t.flashing=!t.flashing,15==++t.time&&(e.done=!0)}};var L=Object.freeze({default:A});function R(){return{time:0,visible:!0}}R.update=function(e){if(!e.done){var t=e.data;t.visible=!t.visible,30==++t.time&&(e.done=!0)}};var C=Object.freeze({default:R});function T(){return{time:0,state:"enter",text:{x:0},bg:{x:0,width:0,height:0}}}T.update=function(e){if(!e.done){var t=e.data,a=t.time,i=t.text,n=t.bg;if(10<a&&a<=25){t.state="enter";var r=(a-10)/15,o=Math.sin(Math.PI/2*r);i.x=o}else if(25<a&&a<=40)t.state="pass",i.x=(a-25)/15;else if(40<a&&a<=55){t.state="exit";var l=(a-40)/15,s=1-Math.sin(Math.PI/2+Math.PI/2*l);i.x=s}if(a<=40){if(n.width<1)n.width+=1/16;else if(n.height<1){var c=(a-16)/8,u=Math.sin(Math.PI/2*c);n.height=u}}else 0<n.height?n.height-=1/8:n.x<1&&(n.x+=1/16);65==++t.time&&(e.done=!0)}};var D=Object.freeze({default:T}),xn={lift:w&&y||w,drop:k&&b||k,move:M&&I||M,attack:q&&S||q,flinch:L&&A||L,fade:C&&R||C,phase:D&&T||D};function zn(e,t,a){return{type:e,target:t,data:a,done:!1}}var In="rgb(80, 120, 248)",Mn="rgb(208, 0, 88)",Sn=[0,0,0,255],On={warrior:"axe",knight:"shield",rogue:"dagger",mage:"hat"};function J(e,t){var a=e.context,i=e.sprites,n=e.cache,r=e.state,o=r.time,l=r.cursor,s=r.viewport,c=r.anims,u=r.attacks,f=r.dialogs,h=r.log,g=r.ai,p=t.map,d=a.canvas,m=c[0],v=u[0],y=f[0],w=["floors","squares","shadows","walls","pieces","arrows","cursor","selection","effects","ui"],b={},k=!0,x=!1,z=void 0;try{for(var I,M=w[Symbol.iterator]();!(k=(I=M.next()).done);k=!0){b[I.value]=[]}}catch(e){x=!0,z=e}finally{try{!k&&M.return&&M.return()}finally{if(x)throw z}}if(a.beginPath(),a.fillStyle="black",a.fillRect(0,0,d.width,d.height),n.units||(n.units=p.units.map(function(e){return Object.assign({original:e},e)})),n.map||(n.map=function(e,t){for(var a=cn(e),i=un(e),n=rn(16*a,16*i),r=rn(16*a,16*i),o=0;o<i;o++)for(var l=0;l<a;l++){var s=16*l,c=16*o,u=fn(e,[l,o]),f=null;if("wall"===u.name)f=o+1<i&&"wall"!==fn(e,[l,o+1]).name?t["wall-base"]:t.wall,r.drawImage(f,s,c);else{var h=null;0<=l-1&&"wall"===fn(e,[l-1,o]).name&&0<=o-1&&"wall"!==fn(e,[l-1,o-1]).name?h=t["shadow-corner"]:0<=l-1&&"wall"===fn(e,[l-1,o]).name&&(h=t["shadow-edge"]),f=t[u.name],n.drawImage(f,s,c),h&&n.drawImage(h,s,c)}}return{floors:n.canvas,walls:r.canvas}}(p,i.tiles)),b.floors.push({image:n.map.floors,position:[0,0]}),b.walls.push({image:n.map.walls,position:[0,0]}),!l.cell){var S=p.units.find(function(e){return"player"===e.faction});l.cell=S.cell.slice(),l.prev=l.cell.slice()}if(!n.log){var O=i.ui.Box(s.size[0]-16,36),q={image:O,position:[8,s.size[1]]};n.log={row:0,col:0,focus:0,time:0,interrupt:!0,bookmark:0,box:q,texts:[],surface:rn(O.width-16,O.height-16)}}var A=p.units.filter(function(e){return"enemy"===e.faction}),L=g.strategy?g.allies[g.index]:null,R=y&&"actions"===y.type&&y,C=y&&"forecast"===y.type&&y,T=y&&"pause"===y.type&&y,D=!h.length||n.log.row===h.length-1&&n.log.col===h[h.length-1].length-1,E=(!D||!n.log.interrupt&&n.log.time<300)&&(v||!n.log.interrupt&&.001<!on(l.cell,l.prev))&&!T;if(E){var j=n.log,B=j.box,N=j.surface;n.log.interrupt&&(n.log.interrupt=!1,n.log.time=0,B.image.getContext("2d").fillRect(8,8,B.image.width-16,B.image.height-16));var P=s.size[1]-B.image.height-8;if(B.position[1]+=(P-B.position[1])/8,Math.abs(P-B.position[1])<4){n.log.focus<n.log.row&&2<=n.log.row&&n.log.row<h.length&&(n.log.focus+=(n.log.row-n.log.focus)/8);var _=h[n.log.row].slice(0,n.log.col+1),U=i.ui.Text(_);n.log.texts[n.log.row]=U,N.canvas.height=Math.max(0,12*(h.length-n.log.bookmark)-4);n.log.row,n.log.bookmark;for(var F=n.log.bookmark;F<=n.log.row;F++){var G=n.log.texts[F];N.drawImage(G,0,12*(F-n.log.bookmark))}var K=rn(B.image.width-16,B.image.height-16),H=Math.max(0,12*(n.log.focus-n.log.bookmark-1));K.drawImage(n.log.surface.canvas,0,-Math.ceil(H));var J=B.image.getContext("2d");J.fillRect(8,8,B.image.width-16,B.image.height-16),J.drawImage(K.canvas,8,8),n.log.col!==h[n.log.row].length-1?n.log.col++:n.log.row!==h.length-1?(n.log.row++,n.log.col=0):n.log.time++}b.ui.push(B)}else{n.log.interrupt||(n.log.interrupt=!0,n.log.bookmark=n.log.row+1);var V=n.log.box,W=s.size[1]+V.image.height;V.position[1]<W&&(V.position[1]+=Math.min(8,W-V.position[1]),b.ui.push(V))}(c.length||v||!D)&&n.phase.pending||(n.phase.faction!==t.phase.faction&&(l.cell=t.phase.pending[0].cell.slice(),m=c[0]=zn("phase",t.phase.faction,xn.phase())),n.phase={pending:t.phase.pending.slice(),faction:t.phase.faction,done:!1});var Q=m&&"phase"===m.type,X=null;if(!Q||!s.target)if(v)X=v.target.cell;else if("enemy"===t.phase.faction&&L)X=L.cell;else if(C&&!n.moved){X=y.options[y.index].cell}else l.selection&&t.phase.pending.includes(l.selection.unit)&&!n.moved?l.selection&&t.phase.pending.includes(l.selection.unit)&&(X=l.selection.unit.cell):X=l.cell;s.target||(s.target=[]);var Y=16*cn(p);Y>s.size[0]?X&&(s.target[0]=16*X[0]+8-s.size[0]/2):s.target[0]=Y/2-s.size[0]/2;var Z=16*un(p);if(Z>s.size[1]?X&&(s.target[1]=16*X[1]+8-s.size[1]/2):s.target[1]=Z/2-s.size[1]/2,!(!Q&&(C||v||"enemy"===n.phase.faction))){var $=Y-s.size[0];Y>s.size[0]&&(s.target[0]<0?s.target[0]=0:s.target[0]>$&&(s.target[0]=$));var ee=Z-s.size[1];Z>s.size[1]&&(s.target[1]<0?s.target[1]=0:s.target[1]>ee&&(s.target[1]=ee))}if(s.position){var te=[s.target[0]-s.position[0],s.target[1]-s.position[1]];s.velocity[0]+=(te[0]/16-s.velocity[0])/4,s.velocity[1]+=(te[1]/16-s.velocity[1])/4,s.position[0]+=s.velocity[0],s.position[1]+=s.velocity[1]}else s.position=s.target.slice();if(n.attack&&n.attack.connected&&1===n.attack.time&&(s.shake=30),s.shake){s.shake--;var ae=v.power,ie=1-s.shake%5/5,ne=v.attacker.cell[1]-v.target.cell[1]?1:0;s.offset[ne]=Math.sin(2*ie*Math.PI)*ae*s.shake/30}else s.offset[0]=0,s.offset[1]=0;var re=l.selection||n.selection;if(re&&"enemy"!==n.phase.faction){var oe=re.unit,le=re.time,se=p.units.indexOf(oe),ce=n.units[se],ue=n.ranges[se];ue||(ue=n.ranges[se]=gn(p,oe));var fe=n.squares[se];if(!fe){var he=!0,ge=!(n.squares[se]=fe=[]),pe=void 0;try{for(var de,me=ue.move[Symbol.iterator]();!(he=(de=me.next()).done);he=!0){var ve=de.value;fe.push({sprite:i.ui.squares.move,cell:ve})}}catch(e){ge=!0,pe=e}finally{try{!he&&me.return&&me.return()}finally{if(ge)throw pe}}var ye=!0,we=!1,be=void 0;try{for(var ke,xe=ue.attack[Symbol.iterator]();!(ye=(ke=xe.next()).done);ye=!0){var ze=ke.value,Ie=!0,Me=!0,Se=!1,Oe=void 0;try{for(var qe,Ae=ue.move[Symbol.iterator]();!(Me=(qe=Ae.next()).done);Me=!0){if(ln(ze,qe.value)){Ie=!1;break}}}catch(e){Se=!0,Oe=e}finally{try{!Me&&Ae.return&&Ae.return()}finally{if(Se)throw Oe}}Ie&&fe.push({sprite:i.ui.squares.attack,cell:ze})}}catch(e){we=!0,be=e}finally{try{!ye&&xe.return&&xe.return()}finally{if(we)throw be}}}l.selection&&n.selection!==l.selection&&(n.selection=re,n.path=null),l.selection&&!c.find(function(e){return e.target===ce})&&c.push(zn("lift",ce,xn.lift())),n.selection&&n.selection!==l.selection&&(n.moved=!1,m&&"lift"===m.type&&(m.done=!0,c.push(zn("drop",m.target,xn.drop(m.data.height))),n.selection.time=0));var Le=m&&"move"===m.type&&m.target===ce,Re=m&&"attack"===m.type&&m.target===ce;if(!n.moved){var Ce=0;if(l.selection)Ce=re.time;else{var Te=0,De=!0,Ee=!1,je=void 0;try{for(var Be,Ne=fe[Symbol.iterator]();!(De=(Be=Ne.next()).done);De=!0){var Pe=Be.value,_e=on(oe.cell,Pe.cell);Te<_e&&(Te=_e)}}catch(e){Ee=!0,je=e}finally{try{!De&&Ne.return&&Ne.return()}finally{if(Ee)throw je}}Ce=Math.max(0,Te-re.time)}Ce&&(fe=fe.filter(function(e){return on(oe.cell,e.cell)<=Ce}),function(e,t,a){var i=!0,n=!1,r=void 0;try{for(var o,l=a[Symbol.iterator]();!(i=(o=l.next()).done);i=!0){var s=o.value,c=s.sprite,u=16*s.cell[0],f=16*s.cell[1];e.squares.push({image:c,position:[u,f]})}}catch(e){n=!0,r=e}finally{try{!i&&l.return&&l.return()}finally{if(n)throw r}}}(b,i.ui.squares,fe))}var Ue=n.path,Fe=hn(p,l.cell);if(ln(l.cell,oe.cell))Ue&&(Ue.length=1);else if(t.phase.pending.includes(oe)&&l.selection){var Ge=ue.move.slice(),Ke=p.units.filter(function(e){return pn(oe,e)}),He=!0,Je=!1,Ve=void 0;try{for(var We,Qe=Ke[Symbol.iterator]();!(He=(We=Qe.next()).done);He=!0){var Xe=We.value;Ge.push(Xe.cell)}}catch(e){Je=!0,Ve=e}finally{try{!He&&Qe.return&&Qe.return()}finally{if(Je)throw Ve}}var Ye=oe.cell;if(Ue&&Ue.length&&(Ye=Ue[Ue.length-1]),ue.move.find(function(e){return ln(l.cell,e)}))if(Ue){for(var Ze=0;Ze<Ue.length;Ze++){var $e=Ue[Ze];if(ln(l.cell,$e))break}if(Ze<Ue.length-1)Ue.splice(Ze+1,Ue.length-Ze-1);else{var et,tt=kn(Ge.filter(function(t){return!Ue.find(function(e){return ln(t,e)})}),Ue[Ue.length-1],l.cell);if(tt&&Ue.length+tt.length-2<=vn(oe))tt.shift(),(et=Ue).push.apply(et,_toConsumableArray(tt));else Ue=n.path=kn(Ge,oe.cell,l.cell)}}else Ue=n.path=kn(Ge,oe.cell,l.cell);else if(Fe&&!pn(oe,Fe)&&on(Ye,Fe.cell)>oe.equipment.weapon.rng){var at=sn(Fe.cell,oe.equipment.weapon.rng);if(Ue){var it=function(){var t=Ue[Ze];if(Fe&&at.find(function(e){return ln(t,e)}))return Ue.splice(Ze+1,Ue.length-Ze-1),"break"};for(Ze=Ue.length;Ze--;){if("break"===it())break}}if(!Ue||-1===Ze){for(var nt=null,rt=function(e){var t=ue.move[e];if(at.find(function(e){return ln(t,e)}))return nt=t,"break"},ot=0;ot<ue.move.length;ot++){if("break"===rt(ot))break}Ue=n.path=kn(Ge,oe.cell,nt)}}}if(Ue&&(l.selection&&!n.moved||Le&&le%2)){var lt,st=i.ui.Arrow(Ue,n.phase.faction);(lt=b.arrows).push.apply(lt,_toConsumableArray(st.map(function(e){return{image:e.image,position:[16*e.position[0],16*e.position[1]]}})))}if(n.moved&&!Le&&!Re&&!f.length){var ct=null,ut=sn(ce.cell,ce.equipment.weapon.rng),ft=[],ht=!0,gt=!1,pt=void 0;try{for(var dt,mt=ut[Symbol.iterator]();!(ht=(dt=mt.next()).done);ht=!0){var vt=hn(p,dt.value);vt&&!pn(oe,vt)&&ft.push(vt)}}catch(e){gt=!0,pt=e}finally{try{!ht&&mt.return&&mt.return()}finally{if(gt)throw pt}}if(ct=(n.enemies=ft).length?["attack","wait"]:["wait"],f.push({type:"actions",menu:bn(ct)}),n.target){var yt=n.target.unit,wt=ft.indexOf(yt);f.unshift({type:"forecast",menu:bn(ft,wt)}),l.cell=yt.cell.slice(),l.prev=yt.cell.slice()}}}if(e.state.paused)if(f.length){var bt=T.menu;if(bt.done)"end turn"===bt.options[bt.index]&&wn(t),e.state.paused=!1,f.shift()}else f.push({type:"pause",menu:bn(["end turn"])});var kt=16*l.cell[1]+8-s.target[1]>=s.size[1]/2,xt=l.selection||v&&n.selected||l.under,zt=n.dialogs.selection;if(!xt||n.selected&&xt!==n.selected||Q||T||C&&zt&&8===zt.name.position[1]||zt&&!C&&!v&&(kt&&!C&&zt&&8!==zt.name.position[1]||!kt&&zt&&8===zt.name.position[1])){if(n.selected){n.selected.unit;var It=n.dialogs.selection;if(It){var Mt=It.name,St=It.hp;Mt.position[0]>-Mt.image.width||St.position[0]>-St.image.width?(Mt.position[0]-=16,St.position[0]-=16):(n.dialogs.selection=null,n.selected=null),b.ui.push(Mt,St)}}}else{n.selected||(n.selected=xt);var Ot=xt.unit,qt=t.map.units.indexOf(Ot),At=n.units[qt];if(!n.dialogs.selection){var Lt=s.size[1]-68;kt&&!C&&(Lt=0);var Rt=i.ui.UnitDetails(At);n.dialogs.selection={name:{image:Rt.name,position:[-Rt.name.width,Lt+8]},hp:{image:Rt.hp,position:[-Rt.hp.width,Lt+36]}}}var Ct=n.dialogs.selection,Tt=Ct.name,Dt=Ct.hp,Et=0,jt=0;v||E?Et=(jt=s.size[1]-4-36-4-Dt.image.height-4)-4-Tt.image.height:kt&&!C||(Et=(jt=s.size[1]-4-Dt.image.height-4)-4-Tt.image.height),(v||!kt||C)&&(Tt.position[1]+=(Et-Tt.position[1])/8,Dt.position[1]+=(jt-Dt.position[1])/8),xt&&(12<=xt.time&&(Tt.position[0]+=(8-Tt.position[0])/8),16<=xt.time&&(Dt.position[0]+=(8-Dt.position[0])/8)),b.ui.push(Tt,Dt)}var Bt=null,Nt=n.dialogs.target;if(C){var Pt=C.menu;Bt=Pt.options[Pt.index],Bt=n.target?n.target.unit!==Bt?{unit:Bt,time:0}:n.target:n.target={unit:Bt,time:0},l.cell=Bt.unit.cell.slice()}else v?Bt=n.target:l.selection&&"enemy"!==n.phase.faction&&l.under&&l.selection!==l.under&&!pn(l.selection.unit,l.under.unit)&&(Bt=l.under);if(!Bt||n.target&&Bt!==n.target||R||Q||C&&Nt&&8===Nt.name.position[1]){if(n.target){n.target.unit;var _t=n.dialogs.target;if(_t){var Ut=_t.name,Ft=_t.hp;Ut.position[0]<s.size[0]||Ft.position[0]<s.size[0]?(Ut.position[0]+=16,Ft.position[0]+=16):(n.dialogs.target=null,n.target=null),b.ui.push(Ut,Ft)}}}else{n.target||(n.target=Bt);var Gt=Bt.unit;if(!n.dialogs.target){var Kt=s.size[1]-68;kt&&!C&&(Kt=0);var Ht=i.ui.UnitDetails(Gt);n.dialogs.target={name:{image:Ht.name,position:[s.size[0],Kt+8]},hp:{image:Ht.hp,position:[s.size[0],Kt+36]}}}var Jt=n.dialogs.target,Vt=Jt.name,Wt=Jt.hp,Qt=0,Xt=0;if(v||E?Qt=(Xt=s.size[1]-8-36-4-Wt.image.height)-4-Vt.image.height:kt&&!C||(Qt=(Xt=s.size[1]-8-Wt.image.height)-4-Vt.image.height),(v||!kt||C)&&(Vt.position[1]+=(Qt-Vt.position[1])/8,Wt.position[1]+=(Xt-Wt.position[1])/8),Bt){if(12<=Bt.time){var Yt=s.size[0]-8-Vt.image.width;Vt.position[0]+=(Yt-Vt.position[0])/8}if(16<=Bt.time){var Zt=s.size[0]-8-Wt.image.width;Wt.position[0]+=(Zt-Wt.position[0])/8}}b.ui.push(Vt,Wt)}if(v&&!Q){var $t=v.attacker,ea=v.target,ta=v.power,aa=v.damage,ia=p.units.indexOf($t),na=n.units[ia];if(n.attack){if(n.attack.countdown&&!--n.attack.countdown){var ra=zn("attack",na,xn.attack($t.cell,ea.cell));c.push(ra),n.attack.normal=ra.data.norm}}else{if(n.attack={countdown:7,time:0,connected:!1,normal:null},"player"===n.phase.faction&&"player"===$t.faction){var oa=zn("drop",na,xn.drop());c.push(oa)}v.counter?h.push($t.name+" counters -"):h.push($t.name+" attacks")}if(m&&"attack"===m.type&&m.data.connected&&!n.attack.connected)if(n.attack.connected=!0,null===ta){var la="player"===ea.faction?".":"!";h.push(ea.name+" dodges the attack"+la)}else if(0===ta){var sa="player"===ea.faction?".":"!";h.push(ea.name+" blocks the attack"+sa)}else{var ca=3===aa?"!!":".";h.push(ea.name+" suffers "+aa+" damage"+ca)}if(n.attack&&n.attack.connected){var ua=n.attack.time;if(45<=ua&&!ea.hp&&p.units.includes(ea)){var fa=p.units.indexOf(ea);p.units.splice(fa,1),"player"===ea.faction?h.push(ea.name+" is defeated."):"enemy"===ea.faction&&h.push("Defeated "+ea.name+".")}var ha=v.counter?n.dialogs.selection:n.dialogs.target;if(ha){var ga=ha.hp.image.getContext("2d"),pa=0;2*ua<=14*aa?(pa=Math.min(14*aa,2*ua),ga.fillStyle=Mn):(pa=ua-14*aa,ga.fillStyle="black"),0<pa&&pa<=14*aa&&ga.fillRect(31+14*(ea.hp+aa)-pa,11,pa,2)}if(60<=ua&&ea.hp||75<=ua){if(u.shift(),n.attack=null,ea.hp){var da=t.map.units.indexOf(ea);n.units[da].hp=ea.hp}v.counter||"player"!==n.phase.faction||(yn(t,$t),l.cell=$t.cell.slice(),l.prev=$t.cell.slice())}else{if(1===ua)for(var ma=[ea.cell[0]-$t.cell[0],ea.cell[1]-$t.cell[1]],va=Math.sqrt(ma[0]*ma[0]+ma[1]*ma[1]),ya=[ma[0]/va,ma[1]/va],wa=Math.atan2(ma[1],ma[0]),ba=[16*ea.cell[0]+8-4*ya[0],16*ea.cell[1]+8-4*ya[1]],ka=aa/3*48,xa=0;xa<ka;xa++){var za="small";Math.random()<.25&&(za="large");var Ia=i.effects[za],Ma=wa+1*Math.random()-.5,Sa=[-Math.cos(Ma)*Math.random()*2,-Math.sin(Ma)*Math.random()*2];n.particles.push({position:ba.slice(),velocity:Sa,image:Ia,time:0})}if(ua<=45){var Oa=n.attack.value;if(Oa)Oa.offset+=Oa.velocity,Oa.velocity+=.25,0<Oa.offset&&(Oa.offset=0,Oa.velocity*=-1/3);else{var qa=null,Aa=rn(8*(qa=null===ta?"MISS":0===ta?"0":3===ta?"3!!":ta.toString()).length+1,9);Aa.drawImage(i.ui.Text(qa,Sn),1,1),Aa.drawImage(i.ui.Text(qa),0,0),Oa=n.attack.value={offset:0,velocity:-2,image:Aa.canvas}}b.effects.push({image:Oa.image,position:[16*ea.cell[0]+8-Oa.image.width/2,16*ea.cell[1]-12+Oa.offset]})}}}}for(var La=n.particles,Ra=0;Ra<La.length;Ra++){var Ca=La[Ra];Ca.time++,Ca.position[0]+=Ca.velocity[0],Ca.position[1]+=Ca.velocity[1],Ca.velocity[0]*=.875,Ca.velocity[1]*=.875;var Ta=Math.random();b.effects.push(Ca),Ta<Ca.time/240&&La.splice(Ra--,1)}if(R){var Da=R.menu;if(Da.done){var Ea=Da.options[Da.index];if("wait"===Ea){var ja=l.selection.unit,Ba=p.units.indexOf(ja),Na=n.units[Ba];ja.cell=Na.cell,l.selection=null,n.selection=null,n.squares.length=0,n.ranges.length=0,n.moved=!1,m.done=!0,c.push(zn("drop",m.target,xn.drop(m.data.height))),yn(t,ja),l.cell=ja.cell.slice(),l.prev=ja.cell.slice(),f.shift()}else"attack"===Ea&&f.unshift({type:"forecast",menu:bn(n.enemies)})}}var Pa=e.state.menu;if(T||R||C&&1<C.menu.options.length){var _a=null;T?_a=T.menu:C?_a=C.menu:R&&(_a=R.menu),Pa||(Pa=e.state.menu={data:_a,box:{size:[0,0],targetSize:null,element:{image:null,position:[144,48]}},cursor:null});var Ua=Pa.box;if(Pa.data!==_a||!Ua.targetSize){n.menu.labels.length=0,Pa.cursor=null;var Fa=(Pa.data=_a).options;C&&(Fa=Fa.map(function(e){return e.name}));var Ga=null,Ka=!0,Ha=!1,Ja=void 0;try{for(var Va,Wa=Fa[Symbol.iterator]();!(Ka=(Va=Wa.next()).done);Ka=!0){var Qa=Va.value,Xa=C?Qa:Qa.toUpperCase(),Ya=i.ui.Text(Xa);(!Ga||Ya.width>Ga.width)&&(Ga=Ya),n.menu.labels.push(Ya)}}catch(e){Ha=!0,Ja=e}finally{try{!Ka&&Wa.return&&Wa.return()}finally{if(Ha)throw Ja}}Ua.size=[0,0],Ua.targetSize=[Ga.width+36,16*Pa.data.options.length+16]}Ua.size[0]+=(Ua.targetSize[0]-Ua.size[0])/4,Ua.size[1]+=(Ua.targetSize[1]-Ua.size[1])/4}else if(Pa){var Za=Pa.box;Za.size[0]&&(Za.size[0]-=Math.min(Za.size[0],Za.targetSize[0]/5),Za.size[1]-=Math.min(Za.size[1],Za.targetSize[1]/5))}if(Pa){var $a=Pa.box;if($a.size[0]&&$a.size[1]){var ei,ti=$a.targetSize[0]-$a.size[0];if($a.element.image=(ei=i.ui).Box.apply(ei,_toConsumableArray($a.size.map(Math.round))),n.menu.box=$a.element.image,ti<4){for(var ai=$a.element.image.getContext("2d"),ii=0;ii<n.menu.labels.length;ii++){var ni=n.menu.labels[ii];ai.drawImage(ni,24,12+16*ii)}var ri=null,oi=Pa.data.options[Pa.data.index];if("attack"===oi?ri=i.ui.symbols.sword:"wait"===oi?ri=i.ui.symbols.clock:"end turn"===oi?ri=i.ui.symbols.next:C&&(ri=i.ui.symbols.sword),ri){var li=o%180/180,si=Math.sin(2*Math.PI*li*2),ci=12+16*Pa.data.index-si;null===Pa.cursor?Pa.cursor=ci:Pa.cursor+=(ci-Pa.cursor)/2,ai.drawImage(ri,12,Pa.cursor)}}b.ui.push($a.element)}}if(C){var ui=C.menu,fi=ui.options[ui.index];if(!n.dialogs.forecast){var hi=i.ui.Text("COMBAT FORECAST"),gi=i.ui.Box(hi.width+28,24),pi=gi.getContext("2d"),di=i.ui.symbols.eye;pi.drawImage(di,8,8),pi.drawImage(hi,20,8),n.dialogs.forecast={title:{image:gi,position:[-gi.width,8]}}}var mi=n.dialogs.forecast.title;mi.position[0]+=(8-mi.position[0])/8,b.ui.push(mi);var vi=l.selection.unit,yi=p.units.indexOf(vi),wi=e.cache.units[yi],bi=sn(wi.cell,vi.equipment.weapon.rng),ki=!0,xi=!1,zi=void 0;try{for(var Ii,Mi=bi[Symbol.iterator]();!(ki=(Ii=Mi.next()).done);ki=!0){var Si=Ii.value;b.squares.push({image:i.ui.squares.attack,position:[16*Si[0],16*Si[1]]})}}catch(e){xi=!0,zi=e}finally{try{!ki&&Mi.return&&Mi.return()}finally{if(xi)throw zi}}void 0===y.time?y.time=0:y.time++;var Oi=Math.floor(14),qi=255*Math.sin(y.time%60/60*Math.PI),Ai=on(wi.cell,fi.cell),Li=!1,Ri=n.dialogs.target;if(Ri){var Ci=Math.min(fi.hp,Ai<=vi.equipment.weapon.rng?Number(mn(vi,fi)):0);if(Ci){fi.hp-Ci<=0&&(Li=!0);var Ti=rn(Ci*Oi,2);Ti.fillStyle="rgb("+qi+", "+qi+", "+qi+")",Ti.fillRect(0,0,Ti.canvas.width,Ti.canvas.height),b.ui.push({image:Ti.canvas,position:[Ri.hp.position[0]+31+(fi.hp-Ci)*Oi,Ri.hp.position[1]+11]})}}if(!Li){var Di=n.dialogs.selection;if(Di){var Ei=Math.min(vi.hp,Ai<=fi.equipment.weapon.rng?Number(mn(fi,vi)):0);if(Ei){var ji=rn(Ei*Oi,2);ji.fillStyle="rgb("+qi+", "+qi+", "+qi+")",ji.fillRect(0,0,ji.canvas.width,ji.canvas.height),b.ui.push({image:ji.canvas,position:[Di.hp.position[0]+31+(vi.hp-Ei)*Oi,Di.hp.position[1]+11]})}}}if(ui.done){vi.cell=wi.cell;var Bi=mn(vi,fi),Ni=Math.min(fi.hp,Number(Bi));if(dn(vi,fi),u.push({attacker:vi,target:fi,power:Bi,damage:Ni}),!Li&&Ai<=fi.equipment.weapon.rng){var Pi=mn(fi,vi),_i=Math.min(vi.hp,Number(Pi));dn(fi,vi),u.push({attacker:fi,target:vi,power:Pi,damage:_i,counter:!0})}n.squares.length=0,n.ranges.length=0,n.moved=!1,l.selection=null,n.selection=null,f.length=0,m.done=!0}}else{var Ui=n.dialogs.forecast;if(Ui){var Fi=Ui.title;Fi.position[0]>-Fi.image.width?(Fi.position[0]-=Math.max(16,-Fi.image.width-Fi.position[0]),b.ui.push(Fi)):n.dialogs.forecast=null}}var Gi=n.dialogs.objective;if(!Gi){var Ki=i.ui.TextBox("OBJECTIVE"),Hi=i.ui.TextBox("Defeat Nergal");Gi=n.dialogs.objective={lastUpdate:null,time:0,title:{image:Ki,position:[s.size[0],s.size[1]-Ki.height-36]},body:{image:Hi,position:[s.size[0],s.size[1]-Hi.height-8]}}}p.units.length!==Gi.lastUpdate&&(Gi.body.image=i.ui.TextBox("Defeat Nergal"),Gi.lastUpdate=A.length);var Ji=Gi,Vi=Ji.title,Wi=Ji.body;l.selection||l.under||n.attack||T||!(on(l.cell,l.prev)<.001)||kt!==(8===Vi.position[1])&&(Vi.position[0]!==s.size[0]||Wi.position[0]!==s.size[0])?Gi.time=0:Gi.time||(Gi.time=1);if(Gi.time&&(Vi.position[0]===s.size[0]&&(kt?(Vi.position[1]=8,Wi.position[1]=36):(Vi.position[1]=s.size[1]-Vi.image.height-36,Wi.position[1]=s.size[1]-Wi.image.height-8)),150<=++Gi.time&&(Vi.position[0]+=(s.size[0]-Vi.image.width-8-Vi.position[0])/8),154<=Gi.time&&(Wi.position[0]+=(s.size[0]-Wi.image.width-8-Wi.position[0])/8)),Gi.time<150&&(Vi.position[0]<s.size[0]||Wi.position[0]<s.size[0])&&(Vi.position[0]+=Math.min(16,s.size[0]-Vi.position[0]),Wi.position[0]+=Math.min(16,s.size[0]-Wi.position[0]),Gi.time=0),b.ui.push(Vi,Wi),Q){var Qi=0,Xi=m.data,Yi=i.ui.phases[m.target];if("enter"===Xi.state){var Zi=-Yi.width,$i=s.size[0]/2-Yi.width/2-3;Qi=Xi.text.x*($i-Zi)+Zi}else if("pass"===Xi.state){var en=s.size[0]/2-Yi.width/2-3;Qi=6*Xi.text.x+en}else if("exit"===Xi.state){var tn=s.size[0]/2-Yi.width/2+3,an=s.size[0];Qi=Xi.text.x*(an-tn)+tn}var nn=rn(256*(Xi.bg.width-Xi.bg.x),2+10*Xi.bg.height);nn.fillStyle="player"===m.target?In:Mn,nn.fillRect(0,0,nn.canvas.width,nn.canvas.height),nn.canvas.width&&b.ui.push({image:nn.canvas,position:[256*Xi.bg.x,s.size[1]/2-nn.canvas.height/2]}),b.ui.push({image:Yi,position:[Qi,s.size[1]/2-Yi.height/2]})}n.attack&&3===v.power&&1===n.attack.time?(a.fillStyle="white",a.fillRect(0,0,a.canvas.width,a.canvas.height)):("player"!==n.phase.faction||v||T||Q||(R||n.moved)&&!C||function(e,t,a,i){var n=i.state.time,r=(i.cache,a.cell[0]-a.prev[0]),o=a.cell[1]-a.prev[1],l=Math.abs(r)+Math.abs(o);a.prev[0]+=r/4,a.prev[1]+=o/4;var s=0;a.selection&&!i.state.dialogs.length?s=1:l<.001&&(s=Math.floor(n/30)%2);var c=16*a.prev[0],u=16*a.prev[1],f=t[i.cache.phase.faction][s];e.cursor.push({image:f,position:[c,u]})}(b,i.ui.cursor,l,e),function(e,t,a,i){for(var n=a.map,r=(a.phase,i.cache),o=i.state.attacks,l=i.state.anims,s=l[0],c=0;c<r.units.length;c++){var u=r.units[c],f=u.original,h=u.cell,g=16*h[0],p=16*h[1],d=0,m=t[u.faction][On[u.type]];if("player"!==u.faction||"player"!==r.phase.faction||!r.phase.pending||r.phase.pending.includes(f)||o.length&&o[0].target===f||s&&s.target===u&&("move"===s.type||"attack"===s.type)||(m=t.done[u.faction][On[u.type]]),n.units[c]===f?ln(u.cell,f.cell)||r.moved||(s&&(s.done=!0),s=l[0]=zn("move",u,xn.move(r.path)),r.moved=!0):l.length||(s&&(s.done=!0),s=l[0]=zn("fade",u,xn.fade())),s&&s.target===u){if("lift"===s.type||"drop"===s.type)d=s.data.height;else if("move"===s.type||"attack"===s.type)g=16*s.data.cell[0],p=16*s.data.cell[1];else if("fade"===s.type){if(s.done){r.units.splice(c--,1);continue}if(!s.data.visible)continue}e.selection.push({image:m,position:[g,p-d]})}else{var v=o[0];if(r.attack&&!r.attack.countdown&&v.target===f){var y=r.attack,w=y.connected,b=y.time,k=y.normal;if(w&&(v.damage&&b<45&&b%2&&(m=t.flashing),b<20&&v.power&&("knight"!==u.type||v.damage===u.hp))){var x=b;10<b&&(x=20-b),g+=k[0]*x/2*v.power/2,p+=k[1]*x/2*v.power/2}e.selection.unshift({image:m,position:[g,p]})}(!r.attack||r.attack.countdown||v&&v.target!==f)&&e.pieces.push({image:m,position:[g,p]})}e.shadows.push({image:t.shadow,position:[g+1,p+4]})}}(b,i.pieces,t,e),function(e,t,a,i){var n=!0,r=!1,o=void 0;try{for(var l,s=t[Symbol.iterator]();!(n=(l=s.next()).done);n=!0){var c=l.value,u=e[c];"ui"!==c&&u.sort(function(e,t){return e.position[1]-t.position[1]});var f=!0,h=!1,g=void 0;try{for(var p,d=u[Symbol.iterator]();!(f=(p=d.next()).done);f=!0){var m=p.value,v=Math.round(m.position[0]),y=Math.round(m.position[1]-(m.position[2]||0));"ui"!==c&&(v-=a.position[0]+a.offset[0],y-=a.position[1]+a.offset[1]),i.drawImage(m.image,v,y)}}catch(e){h=!0,g=e}finally{try{!f&&d.return&&d.return()}finally{if(h)throw g}}}}catch(e){r=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw o}}}(b,w,s,a))}var E=15,j=3;function V(t,e,a,i){var n=e.held,r=e.prev,o=a.map,l=a.phase;if(n.confirm&&!r.confirm)if(t.selection){var s=t.selection.unit;if(l.pending.includes(s)&&"player"===l.faction){var c=o.units.indexOf(s),u=i.cache.units[c],f=i.cache.ranges[c];if(f){var h=i.cache.path;if(h&&1<h.length){var g=h[h.length-1].slice(),p=hn(o,t.cell);f.move.find(function(e){return ln(e,t.cell)})?O(u,g):p&&f.attack.find(function(e){return ln(e,t.cell)})&&(O(u,g),i.cache.target||(i.cache.target={unit:p,time:0}))}else i.cache.moved=!0}}else W(t)}else t.under&&(t.selection=t.under,t.selection.time=0);if(n.mod&&t.selection&&l.pending.includes(t.selection.unit)){var d=t.selection.unit,m=o.units.indexOf(d),v=i.cache.ranges[m];if(!n.left||r.left||n.right){if(n.right&&!r.right&&!n.left){for(w=t.cell[0];w<o.layout.size[0];w++){for(b=0;b<v.move.length;b++){var y=v.move[b];if(y[0]===w+1&&y[1]===t.cell[1])break}if(b===v.move.length)break}t.cell[0]=w}}else{for(var w=t.cell[0];0<=w;w--){for(var b=0;b<v.move.length;b++){var k=v.move[b];if(k[0]===w-1&&k[1]===t.cell[1])break}if(b===v.move.length)break}t.cell[0]=w}if(!n.up||r.up||n.down){if(n.down&&!r.down&&!n.up){for(z=t.cell[1];z<o.layout.size[1];z++){for(b=0;b<v.move.length;b++){var x=v.move[b];if(x[1]===z+1&&x[0]===t.cell[0])break}if(b===v.move.length)break}t.cell[1]=z}}else{for(var z=t.cell[1];0<=z;z--){for(var b=0;b<v.move.length;b++){var I=v.move[b];if(I[1]===z-1&&I[0]===t.cell[0])break}if(b===v.move.length)break}t.cell[1]=z}}else(n.left&&!r.left||n.left>E&&!(n.left%j))&&!n.right?B(t,"left",o):(n.right&&!r.right||n.right>E&&!(n.right%j))&&!n.left&&B(t,"right",o),(n.up&&!r.up||n.up>E&&!(n.up%j))&&!n.down?B(t,"up",o):(n.down&&!r.down||n.down>E&&!(n.down%j))&&!n.up&&B(t,"down",o);var M=hn(o,t.cell);if(M?t.under&&M===t.under.unit?t.under.time++:!t.under&&i.cache.selected&&i.cache.selected.unit===M?t.under=i.cache.selected:t.under={unit:M,time:0}:t.under=null,!t.selection&&n.select&&!r.select){var S=n.mod;!function(e,t,a){var i=t.map,n=t.phase,r=hn(i,e.cell);if(!r)return(r=n.pending.find(function(e){return e.faction===n.faction}))&&(e.cell=r.cell.slice());var o=null,l=i.units.filter(function(e){return e.faction===r.faction}),s=r.faction===n.faction?n.pending:l,c=s.indexOf(r);if(s===n.pending&&-1===c){if(c=l.indexOf(r),a){for(var u=c-1;0<=u;u--){var f=l[u];if(n.pending.includes(f))break}if(-1===u)for(var u=l.length-1;c<u;u--){var h=l[u];if(n.pending.includes(h))break}}else{for(var u=c+1;u<l.length;u++){var g=l[u];if(n.pending.includes(g))break}if(u===l.length)for(var u=0;u<c;u++){var p=l[u];if(n.pending.includes(p))break}}o=l[c=u]}else o=a?0<=c-1?s[c-1]:s[s.length-1]:c+1<s.length?s[c+1]:s[0];o&&(e.cell=o.cell.slice())}(t,a,S)}}function W(e){e.selection=null}function B(e,t,a){var i=a.layout.size;"left"===t?--e.cell[0]<0&&(e.cell[0]=0):"right"===t?++e.cell[0]>=i[0]&&(e.cell[0]=i[0]-1):"up"===t?--e.cell[1]<0&&(e.cell[1]=0):"down"===t&&++e.cell[1]>=i[1]&&(e.cell[1]=i[1]-1)}var N,P={left:["KeyA","ArrowLeft"],up:["KeyW","ArrowUp"],right:["KeyD","ArrowRight"],down:["KeyS","ArrowDown"],confirm:["Space"],cancel:["Escape"],select:["Tab"],mod:["ShiftLeft"]};function Q(a,e){(e=e.slice()).sort(function(e,t){return e.hp-t.hp});for(var t=1/0,i=0;i<e.length;i++){var n=e[i];if(!(n.hp<=t)){e=e.slice(0,i+1);break}t=n.hp}return e.sort(function(e,t){return mn(a,t)-mn(a,e)}),e[0]}(N="sprites.png",new Promise(function(e,t){var a=new Image;a.src=N,a.onload=function(){e(a)},a.onerror=function(){t(new Error("Failed to load image `"+N+"`"))}})).then(function(e){var G=(a=256,i=240,n=o(e),r=document.createElement("canvas"),r.width=a,r.height=i,{sprites:n,context:r.getContext("2d"),state:{time:0,anims:[zn("phase","player",xn.phase())],cursor:{cell:null,prev:null,selection:null,under:null},viewport:{size:[a,i],position:null,target:null,velocity:[0,0],offset:[0,0],shake:0},ai:{strategy:null,index:0,action:0,moved:!1,attacked:!1},menu:null,paused:!1,attacks:[],dialogs:[],log:[]},cache:{map:null,selection:null,selected:null,target:null,moved:!1,attack:null,phase:{faction:"player",pending:null,done:!1},units:null,ranges:[],squares:[],particles:[],log:null,menu:{box:null,labels:[]},dialogs:{objective:null,selection:null,target:null}}}),t=G.context.canvas;var a,i,n,r;document.querySelector("main").appendChild(t),function e(){J(G,X);!function(e){var t=e.cache,a=e.state;a.time++;var i=a.cursor;i.selection?i.selection.time++:t.selection&&t.selection.time++,t.target&&t.target.time++,t.attack&&t.attack.connected&&t.attack.time++;var n=e.state.anims,r=n[0];r&&(r.done?n.shift():xn[r.type].update(r))}(G);var t=Y.held,a=Y.prev;var i=G.state.cursor;var n=G.state.anims;var r=G.state.dialogs;var o=r[0];o?(l=o.menu,c=(s=Y).held,u=s.prev,c.confirm&&!u.confirm&&(l.done=!0),l.done||(c.select&&!u.select?K(l,c.mod):!c.up||u.up||c.down?!c.down||u.down||c.up||K(l):K(l,!0))):"player"!==X.phase.faction||G.state.attacks.length||G.cache.moved||n.length&&"phase"===n[0].type||V(i,Y,X,G);var l,s,c,u;var f=G.state.ai;if("enemy"!==G.cache.phase.faction||G.cache.phase.done)f.strategy=null;else if(f.strategy){var h=f.strategy[f.index],g=f.allies[f.index],p=X.map.units.indexOf(g),d=G.cache.units[p],m=h&&h[f.action];if(m){var v=_slicedToArray(m,2),y=v[0],w=v[1],b=G.state.viewport,k=on(b.position,b.target),x=k<96;if("move"===y){if(!n.length)if(f.moved)f.action++,G.cache.moved=!1,d.cell=w.slice();else if(x){f.moved=!0;var z=gn(X.map,g),I=z.move.slice(),M=!0,S=!1,O=void 0;try{for(var q,A=f.allies[Symbol.iterator]();!(M=(q=A.next()).done);M=!0){var L=q.value;I.push(L.cell)}}catch(e){S=!0,O=e}finally{try{!M&&A.return&&A.return()}finally{if(S)throw O}}var R=kn(I,g.cell,w);G.cache.path=R,G.cache.moved=!1,g.cell=w.slice()}}else if("attack"===y){var C=mn(g,w),T=Math.min(w.hp,Number(C));if(!G.state.attacks.length)if(f.attacked)f.action++,i.selection=null,i.under=null;else if(x){if(f.attacked=!0,dn(g,w),G.cache.target={unit:w,time:0},G.state.attacks.push({attacker:g,target:w,power:C,damage:T}),w.hp&&on(w.cell,g.cell)<=H(w)){var D=mn(w,g),E=Math.min(g.hp,Number(D));dn(w,g),G.state.attacks.push({attacker:w,target:g,power:D,damage:E,counter:!0})}i.selection={unit:g,time:0},i.under=g}}}else if(f.moved=!1,f.attacked=!1,f.index++,f.action=0,g&&yn(X,g),f.index===f.strategy.length){f.index=0,f.strategy=null,G.cache.phase.done=!0;var j=X.map.units.find(function(e){return"player"===e.faction});j&&(i.cell=j.cell.slice(),i.prev=j.cell.slice(),i.selection=null,i.under=null)}}else{var B=X.map.units.filter(function(e){return"enemy"===e.faction}),N=X.map.units.filter(function(e){return"player"===e.faction});N.length&&(f.strategy=function(U,t){for(var F=[],G={tiles:U.tiles,layout:U.layout,units:U.units.map(function(e){return Object.assign({},e)})},K=[],e=_slicedToArray(U.layout.size,2),a=e[0],i=e[1],n=0;n<i;n++)for(var r=0;r<a;r++){var o=n*a+r;U.layout.data[o].solid||K.push([r,n])}var l=G.units.filter(function(e){return e.faction===t}),s=function(t){var e=[];F.push(e);var a=[];if("defend"===t.ai){var i=sn(t.cell,H(t)),n=!0,r=!1,o=void 0;try{for(var l,s=i[Symbol.iterator]();!(n=(l=s.next()).done);n=!0){var c=l.value,u=hn(G,c);u&&u.hp&&!pn(t,u)&&a.push(u)}}catch(e){r=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw o}}if(a.length){var f=Q(t,a);e.push(["attack",U.units[G.units.indexOf(f)]]),dn(t,f)}}else if("wait"===t.ai){var h=gn(G,t),g=!0,p=!1,d=void 0;try{for(var m,v=h.attack[Symbol.iterator]();!(g=(m=v.next()).done);g=!0){var y=m.value,w=hn(G,y);w&&w.hp&&!pn(t,w)&&a.push(w)}}catch(e){p=!0,d=e}finally{try{!g&&v.return&&v.return()}finally{if(p)throw d}}if(a.length){var b=Q(t,a),k=sn(b.cell,H(t)).filter(function(t){return h.move.find(function(e){return ln(e,t)})&&!hn(G,t)});if(k.length){k.sort(function(e,t){return on(b.cell,t)-on(b.cell,e)});var x=k[0];e.push(["move",x],["attack",U.units[G.units.indexOf(b)]]),t.cell=x,dn(t,b)}}}else if("attack"===t.ai){var z=gn(G,t),I=!0,M=!1,S=void 0;try{for(var O,q=z.attack[Symbol.iterator]();!(I=(O=q.next()).done);I=!0){var A=O.value,L=hn(G,A);L&&L.hp&&!pn(t,L)&&a.push(L)}}catch(e){M=!0,S=e}finally{try{!I&&q.return&&q.return()}finally{if(M)throw S}}if(a.length){var R=Q(t,a),C=sn(R.cell,H(t)).filter(function(t){return z.move.find(function(e){return ln(e,t)})});if(C.length){C.sort(function(e,t){return on(R.cell,t)-on(R.cell,e)});var T=C[0];ln(t.cell,T)||e.push(["move",T]),e.push(["attack",U.units[G.units.indexOf(R)]]),t.cell=T,dn(t,R)}}else if((a=G.units.filter(function(e){return!pn(t,e)})).length){var D=a.map(function(e){return kn(K,t.cell,e.cell).slice(0,-1)});a.sort(function(e,t){return D[a.indexOf(e)].length-D[a.indexOf(t)]});for(var E=a[0],j=D.find(function(e){return 1===on(e[e.length-1],E.cell)}),B=[],N=function(e){var t=z.move[e],a=j.find(function(e){return ln(t,e)});a&&!hn(G,t)&&B.push(a)},P=0;P<z.move.length;P++)N(P);if(B.length){B.sort(function(e,t){return j.indexOf(t)-j.indexOf(e)});var _=B[0];e.push(["move",_]),t.cell=_}}}},c=!0,u=!1,f=void 0;try{for(var h,g=l[Symbol.iterator]();!(c=(h=g.next()).done);c=!0)s(h.value)}catch(e){u=!0,f=e}finally{try{!c&&g.return&&g.return()}finally{if(u)throw f}}return F}(X.map,"enemy"),f.allies=B,i.selection=null,i.under=null)}if(t.cancel&&!a.cancel){var P=G.state.anims[0];if(!P||"move"!==P.type)if(o){if("pause"===o.type)G.state.paused=!1;else if("actions"===o.type){var _=G.state.cursor.selection.unit,U=X.map.units.indexOf(_);G.cache.units[U].cell=_.cell,G.cache.moved=null}r.shift(),r.length&&"actions"===(o=r[0]).type&&(o.menu.done=!1)}else i.selection?W(i):G.state.attacks.length||P&&"phase"===P.type||(G.state.paused=!0)}F=Y,Object.assign(F.prev,F.held);var F;requestAnimationFrame(e)}()});var _,U,X=(U=(_=e).units.map(function(e){return function(e,t,a,i,n){return{name:e,type:t,faction:a,ai:i,cell:n,hp:3,stats:d[t],equipment:v[t]}}.apply(void 0,_toConsumableArray(e))}),{map:{tiles:_.tiles,layout:_.layout,units:U},phase:{faction:"player",pending:U.filter(function(e){return"player"===e.faction})}}),Y={held:function(e,i){var n={},r=!1;function t(e){var t=null;if(i)for(var t in i){for(var a=0;a<i[t].length&&i[t][a]!==e.code;a++);if(a<i[t].length)break;t=null}t||(t=e.code),"keydown"===e.type?n[t]||(n[t]=1):"keyup"===e.type&&(n[t]=0),r||(r=!0,requestAnimationFrame(o))}function o(){for(var e in n)n[e]&&n[e]++;requestAnimationFrame(o)}return e.addEventListener("keydown",t),e.addEventListener("keyup",t),n}(window,P),prev:{}};window.addEventListener("keydown",function(e){"Tab"===e.code&&e.preventDefault()})}();