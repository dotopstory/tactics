"use strict";var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var a=[],i=!0,n=!1,r=void 0;try{for(var o,l=e[Symbol.iterator]();!(i=(o=l.next()).done)&&(a.push(o.value),!t||a.length!==t);i=!0);}catch(e){n=!0,r=e}finally{try{!i&&l.return&&l.return()}finally{if(n)throw r}}return a}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}!function(){var a={piece:{palette:[184,0,3,3],shadow:[160,32,14,14],symbols:{shield:[56,164,8,8],bow:[48,172,8,8],dagger:[64,120,8,8],axe:[0,180,8,8],hat:[128,112,8,8]},base:[128,64,16,16]},tiles:{"shadow-corner":[112,80,16,16],black:[112,64,16,16],"wall-base":[144,48,16,16],floor:[144,32,16,16],"shadow-edge":[32,164,16,16],grass:[112,112,16,16],wall:[170,164,16,16]},ui:{cursor:[144,0,32,32],box:[64,64,48,48],squares:[0,164,32,16],arrows:[0,0,64,128],"enemy-phase":[0,146,170,18],healthbar:[64,112,48,8],symbols:{dragon:[32,180,8,8],shield:[48,164,8,8],bow:[176,0,8,8],boot:[170,180,8,8],dagger:[112,96,8,8],sword:[128,80,8,8],next:[144,64,8,8],eye:[160,48,8,8],clock:[174,32,8,8],axe:[176,8,8,8],hat:[8,180,8,8],enemy:[72,120,8,8],lance:[40,180,8,8]},"player-phase":[0,128,188,18],typeface:[64,0,80,64],swords:[170,146,16,18]}};function f(e,t,a,i,n){var r=document.createElement("canvas"),o=r.getContext("2d");return r.width=i,r.height=n,o.drawImage(e,-t,-a),r}var z={get:function(e,t,a){var i=4*(a*e.width+t),n=e.data[i],r=e.data[i+1],o=e.data[i+2],l=e.data[i+3];return[n,r,o,l]},set:function(e,t,a,i){var n=4*(a*e.width+t);e.data[n+0]=i[0],e.data[n+1]=i[1],e.data[n+2]=i[2],e.data[n+3]=i[3]},replace:function(e,t,a){for(var i=0;i<e.data.length;i+=4){for(var n=0;n<4&&e.data[i+n]===t[n];n++);if(4===n)for(var n=0;n<4;n++)e.data[i+n]=a[n]}}};function Hi(e,t){var a=document.createElement("canvas");return a.width=e,a.height=t,a.getContext("2d")}var c={warrior:"axe",knight:"shield",rogue:"dagger",mage:"hat"};function o(e){var t=function e(t,a){var i={};for(var n in a)if(Array.isArray(a[n])){var r=_slicedToArray(a[n],4),o=r[0],l=r[1],s=r[2],c=r[3];i[n]=f(t,o,l,s,c)}else i[n]=e(t,a[n]);return i}(e,a);return{tiles:t.tiles,pieces:function(e){var t={player:{},enemy:{},ally:{},done:{player:{},enemy:{},ally:{}},flashing:null,symbols:e.symbols,shadow:e.shadow},a=e.palette.getContext("2d").getImageData(0,0,3,3),i={black:[0,0,0,255],white:[255,255,255,255],cyan:z.get(a,0,0),blue:z.get(a,1,0),navy:z.get(a,2,0),pink:z.get(a,0,1),red:z.get(a,1,1),purple:z.get(a,2,1),lime:z.get(a,0,2),green:z.get(a,1,2),teal:z.get(a,2,2)},n={player:[i.cyan,i.blue,i.navy],enemy:[i.pink,i.red,i.purple],ally:[i.lime,i.green,i.teal]};for(var r in n){var o=n[r];for(var l in e.symbols){var s=e.symbols[l],c=Hi(s.width,s.height);c.drawImage(s,0,0);var u=e.base.getContext("2d").getImageData(0,0,16,16);z.replace(u,i.white,o[1]),z.replace(u,i.black,o[2]);var h=Hi(u.width,u.height);h.putImageData(u,0,0);var f=c.getImageData(0,0,s.width,s.height);z.replace(f,i.white,o[0]),c.putImageData(f,0,0),h.drawImage(c.canvas,4,4),z.replace(f,o[0],o[2]),c.putImageData(f,0,0),h.drawImage(c.canvas,4,3),t[r][l]=h.canvas}}for(var g in n){var p=n[g];for(var d in e.symbols){var m=e.symbols[d],v=Hi(m.width,m.height);v.drawImage(m,0,0);var w=e.base.getContext("2d").getImageData(0,0,16,16);z.replace(w,i.white,p[2]);var y=Hi(w.width,w.height);y.putImageData(w,0,0);var b=v.getImageData(0,0,m.width,m.height);z.replace(b,i.white,p[1]),v.putImageData(b,0,0),y.drawImage(v.canvas,4,4),z.replace(b,p[1],i.black),v.putImageData(b,0,0),y.drawImage(v.canvas,4,3),t.done[g][d]=y.canvas}}var x=e.base.getContext("2d").getImageData(0,0,16,16);z.replace(x,i.black,i.white);var k=Hi(x.width,x.height);return k.putImageData(x,0,0),t.flashing=k.canvas,t}(t.piece),ui:function(e){var w={symbols:e.symbols,swords:e.swords,cursor:(t=e.cursor,{player:[f(t,0,0,16,16),f(t,16,0,16,16)],enemy:[f(t,0,16,16,16),f(t,16,16,16,16)]}),typeface:function(e){for(var t=e.width/8,a=e.height/8,i={},n=0,r=0;r<a;r++)for(var o=0;o<t;o++){var l="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,.!?abcdefghijklmnopqrstuvwxyz;:'\"()/\\-     "[n++];i[l]=f(e,8*o,8*r,8,8)}return i}(e.typeface),healthbar:e.healthbar,phases:{player:e["player-phase"],enemy:e["enemy-phase"]},box:{topLeft:f(e.box,0,0,16,16),top:f(e.box,16,0,16,16),topRight:f(e.box,32,0,16,16),left:f(e.box,0,16,16,16),center:f(e.box,16,16,16,16),right:f(e.box,32,16,16,16),bottomLeft:f(e.box,0,32,16,16),bottom:f(e.box,16,32,16,16),bottomRight:f(e.box,32,32,16,16)},squares:{move:f(e.squares,0,0,16,16),attack:f(e.squares,16,0,16,16)},arrows:{player:{left:f(e.arrows,0,0,16,16),right:f(e.arrows,16,0,16,16),up:f(e.arrows,32,0,16,16),down:f(e.arrows,48,0,16,16),leftStub:f(e.arrows,0,16,16,16),rightStub:f(e.arrows,16,16,16,16),upStub:f(e.arrows,32,16,16,16),downStub:f(e.arrows,48,16,16,16),upLeft:f(e.arrows,0,32,16,16),upRight:f(e.arrows,16,32,16,16),downLeft:f(e.arrows,32,32,16,16),downRight:f(e.arrows,48,32,16,16),horiz:f(e.arrows,0,48,16,16),vert:f(e.arrows,16,48,16,16)},enemy:{left:f(e.arrows,0,64,16,16),right:f(e.arrows,16,64,16,16),up:f(e.arrows,32,64,16,16),down:f(e.arrows,48,64,16,16),leftStub:f(e.arrows,0,80,16,16),rightStub:f(e.arrows,16,80,16,16),upStub:f(e.arrows,32,80,16,16),downStub:f(e.arrows,48,80,16,16),upLeft:f(e.arrows,0,96,16,16),upRight:f(e.arrows,16,96,16,16),downLeft:f(e.arrows,32,96,16,16),downRight:f(e.arrows,48,96,16,16),horiz:f(e.arrows,0,112,16,16),vert:f(e.arrows,16,112,16,16)}}};var t;return w.Text=u,w.Box=h,w.TextBox=function(e){var t=0,a=0,i=null;if(Array.isArray(e)){i=e.map(function(e){return u(e)});var n=e.map(function(e){return e.width}),r=Math.max.apply(Math,_toConsumableArray(n));t=r,a=8*e.length}else i=u(e),t=i.width,a=8;var o=h(t+16,a+16),l=Hi(t,a);if(Array.isArray(e))for(var s=0;s<i.length;s++){var c=i[s];l.drawImage(c,0,8*s)}else l.drawImage(i,0,0);return l.canvas.width&&o.getContext("2d").drawImage(l.canvas,8,8),o},w.HealthBar=s,w.UnitDetails=function(e){var t=w.symbols[c[e.type]],a=u(e.name),i=h(a.width+t.width+20,24),n=i.getContext("2d");n.drawImage(t,8,8),n.drawImage(a,20,8);var r=h(84,24),o=s(e.hp/3,e.faction),l=u("HP");return(n=r.getContext("2d")).drawImage(l,8,8),n.drawImage(o,28,8),{name:i,hp:r}},w.Arrow=function(e,t){for(var a=[],i=0;i<e.length;i++){var n=_slicedToArray(e[i],2),r=n[0],o=n[1],l=!1,s=!1,c=!1,u=!1,h=e[i-1];if(h){var f=r-h[0],g=o-h[1];1===f?l=!0:-1===f&&(s=!0),1===g?c=!0:-1===g&&(u=!0)}var p=e[i+1];if(p){var d=p[0]-r,m=p[1]-o;-1===d?l=!0:1===d&&(s=!0),-1===m?c=!0:1===m&&(u=!0)}if(l||s||c||u){var v=null;l&&s?v="horiz":c&&u?v="vert":c&&l?v="upLeft":c&&s?v="upRight":u&&l?v="downLeft":u&&s?v="downRight":l&&!i?v="leftStub":s&&!i?v="rightStub":c&&!i?v="upStub":u&&!i?v="downStub":l?v="left":s?v="right":c?v="up":u&&(v="down"),v&&a.push({image:w.arrows[t][v],position:[r,o]})}}return a},w;function u(e){for(var t=0,a=0;a<e.length;a++){var i=e[a];t+=" "===i?4:8}var n=document.createElement("canvas");n.width=t,n.height=8;for(var r=n.getContext("2d"),o=0,l=0;o<e.length;o++){var s=e[o];if(" "===s)l+=4;else{var c=w.typeface[s];r.drawImage(c,l,0),l+=8}}return n}function h(e,t){var a=Math.ceil(e/16),i=Math.ceil(t/16),n=document.createElement("canvas"),r=n.getContext("2d");n.width=e,n.height=t;for(var o=1;o<a-1;o++)r.drawImage(w.box.top,16*o,0),r.drawImage(w.box.bottom,16*o,t-16);for(var l=1;l<i-1;l++)r.drawImage(w.box.left,0,16*l),r.drawImage(w.box.right,e-16,16*l);return r.fillRect(4,4,n.width-8,n.height-8),r.drawImage(w.box.topLeft,0,0),r.drawImage(w.box.topRight,n.width-16,0),r.drawImage(w.box.bottomLeft,0,n.height-16),r.drawImage(w.box.bottomRight,n.width-16,n.height-16),n}function s(e,t){var a=Hi(48,8);return a.drawImage(w.healthbar,0,0),a.fillStyle={player:"rgb(144, 224, 232)",enemy:"rgb(248, 192, 224)",ally:"rgb(200, 224, 255)"}[t],a.fillRect(3,3,Math.floor(42*e),2),a.canvas}}(t.ui),effects:function(){var e=Hi(1,1);e.fillStyle="white",e.fillRect(0,0,1,1);var t=Hi(2,2);return t.fillStyle="white",t.fillRect(0,0,2,2),{small:e.canvas,large:t.canvas}}()}}var t={name:"grass",solid:!1},i={name:"wall",solid:!0},n={name:"floor",solid:!1};"##########################      ##.......##      ##      ##.......##      ##      ##.......##      ##      ####...####      ##      ####...####      ##      ##.......##      ##    ####.......####    ##    ####.......####    ##    ...............    ##    ####.......####    ##    ####.......####    ##      ##.......##      ##      ###########      ##      ###########      ##                       ##                       ##      ##       ##      ##      ##       ##      ##########       ##################       #########                                                                                                    ".split("").map(function(e){switch(e){case" ":return t;case"#":return i;case".":return n}});var r={name:"grass",solid:!1},l={name:"floor",solid:!1},s={name:"wall",solid:!0},e={layout:{size:[20,20],data:["           #########","       ##  #......##"," #     ##  ##......#"," #         ##....###","            ###..###","          #####...##","      ##  ###.#...# ","      ##  #.......# ","          ....##### ","#         #...##### ","#    #    #####     ","     #    #####     ","                    ","                    ","        ##    #     ","        ##    #     "," #               ## "," ##    #         ## "," ##    #            ","                    "].join("").split("").map(function(e){switch(e){case" ":return r;case".":return l;case"#":return s}})},units:[["MAGE","mage","player",!1,[4,13]],["KNIGHT","knight","player",!1,[6,14]],["WARRIOR","warrior","player",!1,[5,16]],["ROGUE","rogue","player",!1,[3,15]],["DARK MAGE","mage","enemy","defend",[15,1]],["TROLL","knight","enemy","defend",[15,4]],["TROLL","knight","enemy","defend",[16,4]],["ORC","warrior","enemy","wait",[16,6]],["TROLL","knight","enemy","defend",[10,8]],["GOBLIN","rogue","enemy","attack",[9,12]],["GOBLIN","rogue","enemy","attack",[8,6]],["ORC","warrior","enemy","attack",[7,12]]]};function Wi(e,t){return Math.abs(t[0]-e[0])+Math.abs(t[1]-e[1])}function u(e){return e[0]}function h(e){return e[1]}function Ji(e,t){return u(e)===u(t)&&h(e)===h(t)}function Vi(e,t){t||(t=1);for(var a=[{steps:0,cell:e}],i=[];a.length;)for(var n=a.shift(),r=[[u(n.cell)-1,h(n.cell)],[u(n.cell)+1,h(n.cell)],[u(n.cell),h(n.cell)-1],[u(n.cell),h(n.cell)+1]],o=0;o<r.length;o++){var l=r[o];if(!Ji(e,l)){for(var s=0;s<i.length;s++){if(Ji(l,i[s]))break}s<i.length||(i.push(l),n.steps+1<t&&a.push({steps:n.steps+1,cell:l}))}}return i}function Qi(e){return e.layout.size[0]}function Xi(e){return e.layout.size[1]}function Yi(e,t){return e.layout.data[h(t)*Qi(e)+u(t)]}function Zi(e,t){for(var a=0;a<e.units.length;a++){var i=e.units[a];if(Ji(t,i.cell))return i}}function $i(e,t){return 0<=u(t)&&u(t)<Qi(e)&&0<=h(t)&&h(t)<Xi(e)}function en(e,t){return e.faction===t.faction||"player"===e.faction&&"ally"===t.faction||"ally"===e.faction&&"player"===t.faction}function A(e,t,a){e.cell=t}function tn(e,t){var a=an(e,t);return a&&(t.hp-=Math.min(t.hp,a)),a}function an(e,t){var a,i,n,r;if((r=(n=e).equipment.weapon,n.stats.agi+(r?r.acc:0)-(i=(a=t).equipment.armor,a.stats.agi-(i?i.wt:0)))<0)return null;if("warrior"===e.type)switch(t.type){case"warrior":case"knight":return 2;case"rogue":return 0;case"mage":return 3}else if("knight"===e.type)switch(t.type){case"warrior":return 2;case"knight":return 1;case"rogue":case"mage":return 2}else if("rogue"===e.type)switch(t.type){case"warrior":return 2;case"knight":return 0;case"rogue":return 1;case"mage":return 2}else if("mage"===e.type)switch(t.type){case"warrior":return 2;case"knight":case"rogue":case"mage":return 1}}function nn(e){if("defend"===e.ai)return 0;var t=e.equipment.armor;return 5-(t?t.wt:0)+Math.floor(e.stats.agi/2)}var g={warrior:{str:2,int:0,agi:1},knight:{str:1,int:0,agi:0},rogue:{str:1,int:1,agi:2},mage:{str:1,int:1,agi:1}},p={axe:{target:"str",atk:2,acc:0,rng:1},lance:{target:"str",atk:3,acc:2,rng:1},dagger:{target:"str",atk:2,acc:1,rng:1},tome:{target:"int",atk:1,acc:1,rng:2}},d={warrior:{weapon:p.axe,armor:null},knight:{weapon:p.lance,armor:{def:2,wt:1}},rogue:{weapon:p.dagger,armor:null},mage:{weapon:p.tome,armor:null}};function rn(e,t){var a=e.phase.pending;a.splice(a.indexOf(t),1),a.length||on(e)}function on(e){var t=e.map,a=e.phase;a.faction="player"===a.faction?"enemy":"player",a.pending=t.units.filter(function(e){return e.faction===a.faction}),a.pending.length||on(e)}function ln(e,t){return{options:e,index:t||0,done:!1}}function m(e,t){t?--e.index<0&&(e.index=e.options.length-1):++e.index>=e.options.length&&(e.index=0)}function sn(e,t,a){for(var i=[],n=[t],r={},o={},l={},s={},c={},u=0;u<e.length;u++){s[f=e[u]]=1/0,c[f]=1/0}for(s[t]=0,c[t]=Wi(t,a);n.length;){var h={score:1/0,index:-1,cell:null};for(u=0;u<n.length;u++){(m=c[f=n[u]])<h.score&&(h.score=m,h.index=u,h.cell=f)}var f;if(Ji(f=h.cell,a)){for(;!Ji(f,t);)i.unshift(f),f=l[f];return i.unshift(f),i}n.splice(h.index,1),r[f]=!1,o[f]=!0;var g=Vi(f);for(u=0;u<g.length;u++){var p=g[u];if(!o[p]){for(var d=0;d<e.length;d++){if(Ji(e[d],p))break}var m;if(d!==e.length)r[p]||(r[p]=!0,n.push(p)),(m=s[f]+1)>=s[p]||(l[p]=f,s[p]=m,c[p]=m+Wi(p,a))}}}}function v(){return{height:0,time:0,floating:!1}}v.update=function(e){if(!e.done){var t=e.data;if(t.time++,e.floating){var a=t.time%120/120;t.height=4+Math.sin(2*Math.PI*a)}else 4==++t.height&&(e.floating=!0)}};var w=Object.freeze({default:v});function y(e){return{height:Math.round(e||4)}}y.update=function(e){e.done||--e.data.height||(e.done=!0)};var b=Object.freeze({default:y});function x(e){return{path:e,cell:e[0].slice(),time:0}}x.update=function(e){if(e.done)return!1;var t=e.data,a=Math.floor(t.time/4),i=t.time%4*.25,n=t.path[a],r=t.path[a+1];return r?t.cell=[n[0]+(r[0]-n[0])*i,n[1]+(r[1]-n[1])*i]:(t.cell=n.slice(),e.done=!0),t.time++,!0};var k=Object.freeze({default:x});function I(e,t){var a=[t[0]-e[0],t[1]-e[1]],i=Math.sqrt(a[0]*a[0]+a[1]*a[1]);return{src:e,norm:[a[0]/i,a[1]/i],cell:e.slice(),time:0,connected:!1}}I.update=function(e){if(!e.done){var t=e.data,a=t.time<=7?t.time:7-(t.time-7);8<=t.time&&(t.connected=!0),t.cell[0]=t.src[0]+t.norm[0]/8*a,t.cell[1]=t.src[1]+t.norm[1]/8*a,15==++t.time&&(e.done=!0)}};var M=Object.freeze({default:I});function S(){return{time:0,flashing:!1}}S.update=function(e){if(!e.done){var t=e.data;t.flashing=!t.flashing,15==++t.time&&(e.done=!0)}};var q=Object.freeze({default:S});function R(){return{time:0,visible:!0}}R.update=function(e){if(!e.done){var t=e.data;t.visible=!t.visible,30==++t.time&&(e.done=!0)}};var O=Object.freeze({default:R});function C(){return{time:0,state:"enter",text:{x:0},bg:{x:0,width:0,height:0}}}C.update=function(e){if(!e.done){var t=e.data,a=t.time,i=t.text,n=t.bg;if(10<a&&a<=25){t.state="enter";var r=(a-10)/15,o=Math.sin(Math.PI/2*r);i.x=o}else if(25<a&&a<=40)t.state="pass",i.x=(a-25)/15;else if(40<a&&a<=55){t.state="exit";var l=(a-40)/15,s=1-Math.sin(Math.PI/2+Math.PI/2*l);i.x=s}if(a<=40){if(n.width<1)n.width+=1/16;else if(n.height<1){var c=(a-16)/8,u=Math.sin(Math.PI/2*c);n.height=u}}else 0<n.height?n.height-=1/8:n.x<1&&(n.x+=1/16);65==++t.time&&(e.done=!0)}};var D=Object.freeze({default:C}),cn={lift:w&&v||w,drop:b&&y||b,move:k&&x||k,attack:M&&I||M,flinch:q&&S||q,fade:O&&R||O,phase:D&&C||D};function un(e,t,a){return{type:e,target:t,data:a,done:!1}}var hn="rgb(80, 120, 248)",fn="rgb(208, 0, 88)",gn={warrior:"axe",knight:"shield",rogue:"dagger",mage:"hat"};function L(e,t){var a=e.context,i=e.sprites,n=e.cache,r=e.state,o=r.time,l=r.cursor,s=r.viewport,c=r.anims,u=r.attacks,h=r.dialogs,f=r.log,g=t.map,p=a.canvas,d=c[0],m=u[0],v=h[0],w=["floors","squares","shadows","walls","pieces","arrows","cursor","selection","effects","ui"],y={},b=!0,x=!1,k=void 0;try{for(var z,I=w[Symbol.iterator]();!(b=(z=I.next()).done);b=!0){y[z.value]=[]}}catch(e){x=!0,k=e}finally{try{!b&&I.return&&I.return()}finally{if(x)throw k}}if(a.beginPath(),a.fillStyle="black",a.fillRect(0,0,p.width,p.height),n.units||(n.units=g.units.map(function(e){return Object.assign({original:e},e)})),n.map||(n.map=function(e,t){for(var a=Qi(e),i=Xi(e),n=Hi(16*a,16*i),r=Hi(16*a,16*i),o=0;o<i;o++)for(var l=0;l<a;l++){var s=16*l,c=16*o,u=Yi(e,[l,o]),h=null;if("wall"===u.name)h=o+1<i&&"wall"!==Yi(e,[l,o+1]).name?t["wall-base"]:t.wall,r.drawImage(h,s,c);else{var f=null;0<=l-1&&"wall"===Yi(e,[l-1,o]).name&&0<=o-1&&"wall"!==Yi(e,[l-1,o-1]).name?f=t["shadow-corner"]:0<=l-1&&"wall"===Yi(e,[l-1,o]).name&&(f=t["shadow-edge"]),h=t[u.name],n.drawImage(h,s,c),f&&n.drawImage(f,s,c)}}return{floors:n.canvas,walls:r.canvas}}(g,i.tiles)),y.floors.push({image:n.map.floors,position:[0,0]}),y.walls.push({image:n.map.walls,position:[0,0]}),!l.cell){var M=g.units.find(function(e){return"player"===e.faction});l.cell=M.cell.slice(),l.prev=l.cell.slice()}var S=v&&"actions"===v.type&&v,A=v&&"forecast"===v.type&&v,q=v&&"pause"===v.type&&v,R=d&&"phase"===d.type,O=null;if(!R||!s.target)if(m)O=m.target.cell;else if(A&&!n.moved){O=v.options[v.index].cell}else l.selection&&t.phase.pending.includes(l.selection.unit)&&!n.moved?l.selection&&t.phase.pending.includes(l.selection.unit)&&(O=l.selection.unit.cell):O=l.cell;if(s.target||(s.target=[]),O){var C=A||m,D=16*Qi(g);if(D>s.size[0]||C){if(s.target[0]=16*O[0]+8-s.size[0]/2,!C){var L=D-s.size[0];D>s.size[0]&&(s.target[0]<0?s.target[0]=0:s.target[0]>L&&(s.target[0]=L))}}else s.target[0]=D/2-s.size[0]/2;var T=16*Xi(g);if(T>s.size[1]||C){if(s.target[1]=16*O[1]+8-s.size[1]/2,!C){var E=T-s.size[1];T>s.size[1]&&(s.target[1]<0?s.target[1]=0:s.target[1]>E&&(s.target[1]=E))}}else s.target[1]=T/2-s.size[1]/2}if(s.position?(s.position[0]+=(s.target[0]-s.position[0])/16,s.position[1]+=(s.target[1]-s.position[1])/16):s.position=s.target.slice(),n.attack&&n.attack.connected&&1===n.attack.time&&(s.shake=30),s.shake){s.shake--;var j=m.power,B=1-s.shake%5/5,P=m.attacker.cell[1]-m.target.cell[1]?1:0;s.offset[P]=Math.sin(2*B*Math.PI)*j*s.shake/30}else s.offset[0]=0,s.offset[1]=0;if(!n.log){var U=i.ui.Box(s.size[0]-16,36),_={image:U,position:[8,s.size[1]]};n.log={row:0,col:0,focus:0,time:0,interrupt:!0,bookmark:0,box:_,texts:[],surface:Hi(U.width-16,U.height-16)}}var N=!f.length||n.log.row===f.length-1&&n.log.col===f[f.length-1].length-1,G=(!N||!n.log.interrupt&&n.log.time<300)&&(m||!n.log.interrupt&&.001<!Wi(l.cell,l.prev))&&!q;if(G){var K=n.log,F=K.box,H=K.surface;n.log.interrupt&&(n.log.interrupt=!1,n.log.time=0,F.image.getContext("2d").fillRect(8,8,F.image.width-16,F.image.height-16));var W=s.size[1]-F.image.height-8;if(F.position[1]+=(W-F.position[1])/8,Math.abs(W-F.position[1])<4){n.log.focus<n.log.row&&2<=n.log.row&&n.log.row<f.length&&(n.log.focus+=(n.log.row-n.log.focus)/8);var J=f[n.log.row].slice(0,n.log.col+1),V=i.ui.Text(J);n.log.texts[n.log.row]=V,H.canvas.height=Math.max(0,12*(f.length-n.log.bookmark)-4);n.log.row,n.log.bookmark;for(var Q=n.log.bookmark;Q<=n.log.row;Q++){var X=n.log.texts[Q];H.drawImage(X,0,12*(Q-n.log.bookmark))}var Y=Hi(F.image.width-16,F.image.height-16),Z=Math.max(0,12*(n.log.focus-n.log.bookmark-1));Y.drawImage(n.log.surface.canvas,0,-Math.ceil(Z));var $=F.image.getContext("2d");$.fillRect(8,8,F.image.width-16,F.image.height-16),$.drawImage(Y.canvas,8,8),n.log.col!==f[n.log.row].length-1?n.log.col++:n.log.row!==f.length-1?(n.log.row++,n.log.col=0):n.log.time++}y.ui.push(F)}else{n.log.interrupt||(n.log.interrupt=!0,n.log.bookmark=n.log.row+1);var ee=n.log.box,te=s.size[1]+ee.image.height;ee.position[1]<te&&(ee.position[1]+=Math.min(8,te-ee.position[1]),y.ui.push(ee))}var ae=l.selection||n.selection;if(ae){var ie=ae.unit,ne=ae.time,re=g.units.indexOf(ie),oe=n.units[re],le=n.ranges[re];le||(le=n.ranges[re]=function(e,t){var a={move:[t.cell],attack:[]},i=nn(t),n=[{steps:0,cell:t.cell}];for(i||(n.length=0);n.length;)for(var r=n.shift(),o=Vi(r.cell),l=0;l<o.length;l++)if($i(e,c=o[l])&&!Yi(e,c).solid){for(var s=0;s<a.move.length&&!Ji(c,a.move[s]);s++);if(!(s<a.move.length)){if((u=Zi(e,c))||a.move.push(c),u&&!en(t,u)){for(s=0;s<a.attack.length&&!Ji(a.attack[s],c);s++);s===a.attack.length&&a.attack.push(c)}r.steps<i-1&&(!u||en(t,u))&&n.push({steps:r.steps+1,cell:c})}}for(l=0;l<a.move.length;l++)for(o=Vi(a.move[l],t.equipment.weapon.rng),s=0;s<o.length;s++){var c,u;if($i(e,c=o[s])&&!Yi(e,c).solid&&!Ji(t.cell,c)&&(!(u=Zi(e,c))||!en(t,u))){for(var h=0;h<a.attack.length&&!Ji(a.attack[h],c);h++);h===a.attack.length&&a.attack.push(c)}}return a}(g,ie));var se=n.squares[re];if(!se){var ce=!0,ue=!(n.squares[re]=se=[]),he=void 0;try{for(var fe,ge=le.move[Symbol.iterator]();!(ce=(fe=ge.next()).done);ce=!0){var pe=fe.value;se.push({sprite:i.ui.squares.move,cell:pe})}}catch(e){ue=!0,he=e}finally{try{!ce&&ge.return&&ge.return()}finally{if(ue)throw he}}var de=!0,me=!1,ve=void 0;try{for(var we,ye=le.attack[Symbol.iterator]();!(de=(we=ye.next()).done);de=!0){var be=we.value,xe=!0,ke=!0,ze=!1,Ie=void 0;try{for(var Me,Se=le.move[Symbol.iterator]();!(ke=(Me=Se.next()).done);ke=!0){if(Ji(be,Me.value)){xe=!1;break}}}catch(e){ze=!0,Ie=e}finally{try{!ke&&Se.return&&Se.return()}finally{if(ze)throw Ie}}xe&&se.push({sprite:i.ui.squares.attack,cell:be})}}catch(e){me=!0,ve=e}finally{try{!de&&ye.return&&ye.return()}finally{if(me)throw ve}}}l.selection&&n.selection!==l.selection&&(n.selection=ae,n.path=null),l.selection&&!c.find(function(e){return e.target===oe})&&c.push(un("lift",oe,cn.lift())),n.selection&&n.selection!==l.selection&&(n.moved=!1,d&&"lift"===d.type&&(d.done=!0,c.push(un("drop",d.target,cn.drop(d.data.height))),n.selection.time=0));var Ae=d&&"move"===d.type&&d.target===oe,qe=d&&"attack"===d.type&&d.target===oe;if(!n.moved&&Ae&&(n.moved=!0),!n.moved){var Re=0;if(l.selection)Re=ae.time;else{var Oe=0,Ce=!0,De=!1,Le=void 0;try{for(var Te,Ee=se[Symbol.iterator]();!(Ce=(Te=Ee.next()).done);Ce=!0){var je=Te.value,Be=Wi(ie.cell,je.cell);Oe<Be&&(Oe=Be)}}catch(e){De=!0,Le=e}finally{try{!Ce&&Ee.return&&Ee.return()}finally{if(De)throw Le}}Re=Math.max(0,Oe-ae.time)}Re&&(se=se.filter(function(e){return Wi(ie.cell,e.cell)<=Re}),function(e,t,a){var i=!0,n=!1,r=void 0;try{for(var o,l=a[Symbol.iterator]();!(i=(o=l.next()).done);i=!0){var s=o.value,c=s.sprite,u=16*s.cell[0],h=16*s.cell[1];e.squares.push({image:c,position:[u,h]})}}catch(e){n=!0,r=e}finally{try{!i&&l.return&&l.return()}finally{if(n)throw r}}}(y,i.ui.squares,se))}var Pe=n.path,Ue=Zi(g,l.cell);if(Ji(l.cell,ie.cell))Pe&&(Pe.length=1);else if(t.phase.pending.includes(ie)&&l.selection){var _e=le.move.slice(),Ne=g.units.filter(function(e){return en(ie,e)}),Ge=!0,Ke=!1,Fe=void 0;try{for(var He,We=Ne[Symbol.iterator]();!(Ge=(He=We.next()).done);Ge=!0){var Je=He.value;_e.push(Je.cell)}}catch(e){Ke=!0,Fe=e}finally{try{!Ge&&We.return&&We.return()}finally{if(Ke)throw Fe}}var Ve=ie.cell;if(Pe&&Pe.length&&(Ve=Pe[Pe.length-1]),le.move.find(function(e){return Ji(l.cell,e)}))if(Pe){for(var Qe=0;Qe<Pe.length;Qe++){var Xe=Pe[Qe];if(Ji(l.cell,Xe))break}if(Qe<Pe.length-1)Pe.splice(Qe+1,Pe.length-Qe-1);else{var Ye,Ze=sn(_e.filter(function(t){return!Pe.find(function(e){return Ji(t,e)})}),Pe[Pe.length-1],l.cell);if(Ze&&Pe.length+Ze.length-2<=nn(ie))Ze.shift(),(Ye=Pe).push.apply(Ye,_toConsumableArray(Ze));else Pe=n.path=sn(_e,ie.cell,l.cell)}}else Pe=n.path=sn(_e,ie.cell,l.cell);else if(Ue&&!en(ie,Ue)&&Wi(Ve,Ue.cell)>ie.equipment.weapon.rng){var $e=Vi(Ue.cell,ie.equipment.weapon.rng);if(Pe){var et=function(){var t=Pe[Qe];if(Ue&&$e.find(function(e){return Ji(t,e)}))return Pe.splice(Qe+1,Pe.length-Qe-1),"break"};for(Qe=Pe.length;Qe--;){if("break"===et())break}}if(!Pe||-1===Qe){for(var tt=null,at=function(e){var t=le.move[e];if($e.find(function(e){return Ji(t,e)}))return tt=t,"break"},it=0;it<le.move.length;it++){if("break"===at(it))break}Pe=n.path=sn(_e,ie.cell,tt)}}}if(Pe&&(l.selection&&!n.moved||Ae&&ne%2)){var nt,rt=i.ui.Arrow(Pe,n.phase.faction);(nt=y.arrows).push.apply(nt,_toConsumableArray(rt.map(function(e){return{image:e.image,position:[16*e.position[0],16*e.position[1]]}})))}if(n.moved&&!Ae&&!qe&&!h.length){var ot=null,lt=Vi(oe.cell,oe.equipment.weapon.rng),st=[],ct=!0,ut=!1,ht=void 0;try{for(var ft,gt=lt[Symbol.iterator]();!(ct=(ft=gt.next()).done);ct=!0){var pt=Zi(g,ft.value);pt&&!en(ie,pt)&&st.push(pt)}}catch(e){ut=!0,ht=e}finally{try{!ct&&gt.return&&gt.return()}finally{if(ut)throw ht}}if(ot=(n.enemies=st).length?["attack","wait"]:["wait"],h.push({type:"actions",menu:ln(ot)}),n.target){var dt=n.target.unit,mt=st.indexOf(dt);h.unshift({type:"forecast",menu:ln(st,mt)}),l.cell=dt.cell.slice(),l.prev=dt.cell.slice()}}}if(e.state.paused)if(h.length){var vt=q.menu;if(vt.done)"end turn"===vt.options[vt.index]&&on(t),e.state.paused=!1,h.shift()}else h.push({type:"pause",menu:ln(["end turn"])});var wt=16*l.cell[1]+8-s.target[1]>=s.size[1]/2,yt=l.selection||m&&n.selected||l.under,bt=n.dialogs.selection;if(!yt||n.selected&&yt!==n.selected||R||q||A&&bt&&8===bt.name.position[1]||bt&&!A&&!m&&(wt&&!A&&bt&&8!==bt.name.position[1]||!wt&&bt&&8===bt.name.position[1])){if(n.selected){n.selected.unit;var xt=n.dialogs.selection;xt.name.position[0]>-xt.name.image.width||xt.hp.position[0]>-xt.hp.image.width?(xt.name.position[0]-=16,xt.hp.position[0]-=16):(n.dialogs.selection=null,n.selected=null),y.ui.push(xt.name,xt.hp)}}else{n.selected||(n.selected=yt);var kt=yt.unit;if(!n.dialogs.selection){var zt=s.size[1]-68;wt&&!A&&(zt=0);var It=i.ui.UnitDetails(kt);n.dialogs.selection={name:{image:It.name,position:[-It.name.width,zt+8]},hp:{image:It.hp,position:[-It.hp.width,zt+36]}}}var Mt=n.dialogs.selection,St=Mt.name,At=Mt.hp,qt=0,Rt=0;m||G?qt=(Rt=s.size[1]-4-36-4-At.image.height-4)-4-St.image.height:wt&&!A||(qt=(Rt=s.size[1]-4-At.image.height-4)-4-St.image.height),(m||!wt||A)&&(St.position[1]+=(qt-St.position[1])/8,At.position[1]+=(Rt-At.position[1])/8),yt&&(12<=yt.time&&(St.position[0]+=(8-St.position[0])/8),16<=yt.time&&(At.position[0]+=(8-At.position[0])/8)),y.ui.push(St,At)}var Ot=null,Ct=n.dialogs.target;if(A){var Dt=A.menu;Ot=Dt.options[Dt.index],Ot=n.target?n.target.unit!==Ot?{unit:Ot,time:0}:n.target:n.target={unit:Ot,time:0},l.cell=Ot.unit.cell.slice()}else m?Ot=n.target:l.selection&&l.under&&l.selection!==l.under&&!en(l.selection.unit,l.under.unit)&&(Ot=l.under);if(!Ot||n.target&&Ot!==n.target||S||A&&Ct&&8===Ct.name.position[1]){if(n.target){n.target.unit;var Lt=n.dialogs.target;Lt.name.position[0]<s.size[0]||Lt.hp.position[0]<s.size[0]?(Lt.name.position[0]+=16,Lt.hp.position[0]+=16):(n.dialogs.target=null,n.target=null),y.ui.push(Lt.name,Lt.hp)}}else{n.target||(n.target=Ot);var Tt=Ot.unit;if(!n.dialogs.target){var Et=s.size[1]-68;wt&&!A&&(Et=0);var jt=i.ui.UnitDetails(Tt);n.dialogs.target={name:{image:jt.name,position:[s.size[0],Et+8]},hp:{image:jt.hp,position:[s.size[0],Et+36]}}}var Bt=n.dialogs.target,Pt=Bt.name,Ut=Bt.hp,_t=0,Nt=0;if(m||G?_t=(Nt=s.size[1]-8-36-4-Ut.image.height)-4-Pt.image.height:wt&&!A||(_t=(Nt=s.size[1]-8-Ut.image.height)-4-Pt.image.height),(m||!wt||A)&&(Pt.position[1]+=(_t-Pt.position[1])/8,Ut.position[1]+=(Nt-Ut.position[1])/8),Ot){if(12<=Ot.time){var Gt=s.size[0]-8-Pt.image.width;Pt.position[0]+=(Gt-Pt.position[0])/8}if(16<=Ot.time){var Kt=s.size[0]-8-Ut.image.width;Ut.position[0]+=(Kt-Ut.position[0])/8}}y.ui.push(Pt,Ut)}if(m){var Ft=m.attacker,Ht=m.target,Wt=m.power,Jt=m.damage;if(n.attack||d){if(d&&"attack"===d.type&&d.data.connected&&!n.attack.connected)if(n.attack.connected=!0,null===Wt){var Vt="player"===Ht.faction?".":"!";f.push(Ht.name+" dodges the blow"+Vt)}else if(0===Wt){var Qt="player"===Ht.faction?".":"!";f.push(Ht.name+" blocks the attack"+Qt)}else{var Xt=3===Jt?"!!":".";f.push(Ht.name+" suffers "+Jt+" damage"+Xt)}}else{var Yt=g.units.indexOf(Ft),Zt=n.units[Yt];c.push(un("attack",Zt,cn.attack(Ft.cell,Ht.cell))),n.attack={time:0,connected:!1},m.counter?f.push(Ft.name+" counters -"):f.push(Ft.name+" attacks")}if(n.attack&&n.attack.connected){var $t=n.attack.time;if(45<=$t&&!Ht.hp&&g.units.includes(Ht)){var ea=g.units.indexOf(Ht);g.units.splice(ea,1),"player"===Ht.faction?f.push(Ht.name+" is defeated."):"enemy"===Ht.faction&&f.push("Defeated "+Ht.name+".")}if(60<=$t&&Ht.hp||90<=$t)u.shift(),n.attack=null,m.counter||(rn(t,Ft),l.cell=Ft.cell.slice(),l.prev=l.cell.slice());else{if(1===$t)for(var ta=[Ht.cell[0]-Ft.cell[0],Ht.cell[1]-Ft.cell[1]],aa=Math.sqrt(ta[0]*ta[0]+ta[1]*ta[1]),ia=[ta[0]/aa,ta[1]/aa],na=Math.atan2(ta[1],ta[0]),ra=[16*Ht.cell[0]+8-4*ia[0],16*Ht.cell[1]+8-4*ia[1]],oa=Jt/3*48,la=0;la<oa;la++){var sa="small";Math.random()<.25&&(sa="large");var ca=i.effects[sa],ua=na+1*Math.random()-.5,ha=[-Math.cos(ua)*Math.random()*2,-Math.sin(ua)*Math.random()*2];n.particles.push({position:ra.slice(),velocity:ha,image:ca,time:0})}var fa=(m.counter?n.dialogs.selection:n.dialogs.target).hp.image.getContext("2d"),ga=0;if(2*$t<=14*Jt?(ga=Math.min(14*Jt,2*$t),fa.fillStyle=fn):(ga=$t-14*Jt,fa.fillStyle="black"),0<ga&&ga<=14*Jt&&fa.fillRect(31+14*(Ht.hp+Jt)-ga,11,ga,2),$t<=45){var pa=n.attack.value;if(pa)pa.offset+=pa.velocity,pa.velocity+=.25,0<pa.offset&&(pa.offset=0,pa.velocity*=-1/3);else{var da=null;da=null===Wt?"MISS":0===Wt?"0":3===Wt?"3!!":Wt.toString(),pa=n.attack.value={offset:0,velocity:-2,image:i.ui.Text(da)}}y.effects.push({image:pa.image,position:[16*Ht.cell[0]+8-pa.image.width/2,16*Ht.cell[1]-12+pa.offset]})}}}}for(var ma=n.particles,va=0;va<ma.length;va++){var wa=ma[va];wa.time++,wa.position[0]+=wa.velocity[0],wa.position[1]+=wa.velocity[1],wa.velocity[0]*=.875,wa.velocity[1]*=.875;var ya=Math.random();y.effects.push(wa),ya<wa.time/240&&ma.splice(va--,1)}if(S){var ba=S.menu;if(ba.done){var xa=ba.options[ba.index];if("wait"===xa){var ka=l.selection.unit,za=g.units.indexOf(ka),Ia=n.units[za];ka.cell=Ia.cell,l.selection=null,n.selection=null,n.squares.length=0,n.ranges.length=0,n.moved=!1,d.done=!0,c.push(un("drop",d.target,cn.drop(d.data.height))),rn(t,ka),l.cell=ka.cell.slice(),l.prev=ka.cell.slice(),h.shift()}else"attack"===xa&&h.unshift({type:"forecast",menu:ln(n.enemies)})}}var Ma=e.state.menu;if(q||S||A&&1<A.menu.options.length){var Sa=null;q?Sa=q.menu:A?Sa=A.menu:S&&(Sa=S.menu),Ma||(Ma=e.state.menu={data:Sa,box:{size:[0,0],targetSize:null,element:{image:null,position:[144,48]}},cursor:null});var Aa=Ma.box;if(Ma.data!==Sa||!Aa.targetSize){n.menu.labels.length=0,Ma.cursor=null;var qa=(Ma.data=Sa).options;A&&(qa=qa.map(function(e){return e.name}));var Ra=null,Oa=!0,Ca=!1,Da=void 0;try{for(var La,Ta=qa[Symbol.iterator]();!(Oa=(La=Ta.next()).done);Oa=!0){var Ea=La.value,ja=i.ui.Text(Ea.toUpperCase());(!Ra||ja.width>Ra.width)&&(Ra=ja),n.menu.labels.push(ja)}}catch(e){Ca=!0,Da=e}finally{try{!Oa&&Ta.return&&Ta.return()}finally{if(Ca)throw Da}}Aa.size=[0,0],Aa.targetSize=[Ra.width+36,16*Ma.data.options.length+16]}Aa.size[0]+=(Aa.targetSize[0]-Aa.size[0])/4,Aa.size[1]+=(Aa.targetSize[1]-Aa.size[1])/4}else if(Ma){var Ba=Ma.box;Ba.size[0]&&(Ba.size[0]-=Math.min(Ba.size[0],Ba.targetSize[0]/5),Ba.size[1]-=Math.min(Ba.size[1],Ba.targetSize[1]/5))}if(Ma){var Pa=Ma.box;if(Pa.size[0]&&Pa.size[1]){var Ua,_a=Pa.targetSize[0]-Pa.size[0];if(Pa.element.image=(Ua=i.ui).Box.apply(Ua,_toConsumableArray(Pa.size.map(Math.round))),n.menu.box=Pa.element.image,_a<4){for(var Na=Pa.element.image.getContext("2d"),Ga=0;Ga<n.menu.labels.length;Ga++){var Ka=n.menu.labels[Ga];Na.drawImage(Ka,24,12+16*Ga)}var Fa=null,Ha=Ma.data.options[Ma.data.index];if("attack"===Ha?Fa=i.ui.symbols.sword:"wait"===Ha?Fa=i.ui.symbols.clock:"end turn"===Ha?Fa=i.ui.symbols.next:A&&(Fa=i.ui.symbols.sword),Fa){var Wa=o%180/180,Ja=Math.sin(2*Math.PI*Wa*2),Va=12+16*Ma.data.index-Ja;null===Ma.cursor?Ma.cursor=Va:Ma.cursor+=(Va-Ma.cursor)/2,Na.drawImage(Fa,12,Ma.cursor)}}y.ui.push(Pa.element)}}if(A){var Qa=A.menu,Xa=Qa.options[Qa.index];if(!n.dialogs.forecast){var Ya=i.ui.Text("COMBAT FORECAST"),Za=i.ui.Box(Ya.width+28,24),$a=Za.getContext("2d"),ei=i.ui.symbols.eye;$a.drawImage(ei,8,8),$a.drawImage(Ya,20,8),n.dialogs.forecast={title:{image:Za,position:[-Za.width,8]}}}var ti=n.dialogs.forecast.title;ti.position[0]+=(8-ti.position[0])/8,y.ui.push(ti);var ai=l.selection.unit,ii=g.units.indexOf(ai),ni=e.cache.units[ii],ri=Vi(ni.cell,ai.equipment.weapon.rng),oi=!0,li=!1,si=void 0;try{for(var ci,ui=ri[Symbol.iterator]();!(oi=(ci=ui.next()).done);oi=!0){var hi=ci.value;y.squares.push({image:i.ui.squares.attack,position:[16*hi[0],16*hi[1]]})}}catch(e){li=!0,si=e}finally{try{!oi&&ui.return&&ui.return()}finally{if(li)throw si}}void 0===v.time?v.time=0:v.time++;var fi=Math.floor(14),gi=255*Math.sin(v.time%60/60*Math.PI),pi=Wi(ni.cell,Xa.cell),di=!1,mi=n.dialogs.target;if(mi){var vi=Math.min(Xa.hp,pi<=ai.equipment.weapon.rng?Number(an(ai,Xa)):0);if(vi){Xa.hp-vi<=0&&(di=!0);var wi=Hi(vi*fi,2);wi.fillStyle="rgb("+gi+", "+gi+", "+gi+")",wi.fillRect(0,0,wi.canvas.width,wi.canvas.height),y.ui.push({image:wi.canvas,position:[mi.hp.position[0]+31+(Xa.hp-vi)*fi,mi.hp.position[1]+11]})}}if(!di){var yi=n.dialogs.selection;if(yi){var bi=Math.min(ai.hp,pi<=Xa.equipment.weapon.rng?Number(an(Xa,ai)):0);if(bi){var xi=Hi(bi*fi,2);xi.fillStyle="rgb("+gi+", "+gi+", "+gi+")",xi.fillRect(0,0,xi.canvas.width,xi.canvas.height),y.ui.push({image:xi.canvas,position:[yi.hp.position[0]+31+(ai.hp-bi)*fi,yi.hp.position[1]+11]})}}}if(Qa.done){ai.cell=ni.cell;var ki=an(ai,Xa),zi=Math.min(Xa.hp,Number(ki));if(tn(ai,Xa),u.push({attacker:ai,target:Xa,power:ki,damage:zi,counter:!1}),!di&&pi<=Xa.equipment.weapon.rng){var Ii=an(Xa,ai),Mi=Math.min(ai.hp,Number(Ii));tn(Xa,ai),u.push({attacker:Xa,target:ai,power:Ii,damage:Mi,counter:!0})}n.squares.length=0,n.ranges.length=0,n.moved=!1,l.selection=null,n.selection=null,h.length=0,d.done=!0}}else{var Si=n.dialogs.forecast;if(Si){var Ai=Si.title;Ai.position[0]>-Ai.image.width?(Ai.position[0]-=Math.max(16,-Ai.image.width-Ai.position[0]),y.ui.push(Ai)):n.dialogs.forecast=null}}var qi=n.dialogs.objective;if(!qi){var Ri=i.ui.TextBox("OBJECTIVE"),Oi=i.ui.TextBox("Defeat all enemies");qi=n.dialogs.objective={lastUpdate:null,time:0,title:{image:Ri,position:[s.size[0],s.size[1]-Ri.height-36]},body:{image:Oi,position:[s.size[0],s.size[1]-Oi.height-8]}}}if(g.units.length!==qi.lastUpdate){var Ci=g.units.filter(function(e){return"enemy"===e.faction}),Di=Ci.length;qi.body.image=i.ui.TextBox("Defeat ("+Di+") enem"+(1===Di?"y":"ies")),qi.lastUpdate=Ci.length}var Li=qi,Ti=Li.title,Ei=Li.body;l.selection||l.under||n.attack||q||!(Wi(l.cell,l.prev)<.001)||wt!==(8===Ti.position[1])&&(Ti.position[0]!==s.size[0]||Ei.position[0]!==s.size[0])?qi.time=0:qi.time||(qi.time=1);if(qi.time&&(Ti.position[0]===s.size[0]&&(wt?(Ti.position[1]=8,Ei.position[1]=36):(Ti.position[1]=s.size[1]-Ti.image.height-36,Ei.position[1]=s.size[1]-Ei.image.height-8)),90<=++qi.time&&(Ti.position[0]+=(s.size[0]-Ti.image.width-8-Ti.position[0])/8),94<=qi.time&&(Ei.position[0]+=(s.size[0]-Ei.image.width-8-Ei.position[0])/8)),qi.time<90&&(Ti.position[0]<s.size[0]||Ei.position[0]<s.size[0])&&(Ti.position[0]+=Math.min(16,s.size[0]-Ti.position[0]),Ei.position[0]+=Math.min(16,s.size[0]-Ei.position[0]),qi.time=0),y.ui.push(Ti,Ei),R){var ji=0,Bi=d.data,Pi=i.ui.phases[d.target];if("enter"===Bi.state){var Ui=-Pi.width,_i=s.size[0]/2-Pi.width/2-3;ji=Bi.text.x*(_i-Ui)+Ui}else if("pass"===Bi.state){var Ni=s.size[0]/2-Pi.width/2-3;ji=6*Bi.text.x+Ni}else if("exit"===Bi.state){var Gi=s.size[0]/2-Pi.width/2+3,Ki=s.size[0];ji=Bi.text.x*(Ki-Gi)+Gi}var Fi=Hi(256*(Bi.bg.width-Bi.bg.x),2+10*Bi.bg.height);Fi.fillStyle="player"===d.target?hn:fn,Fi.fillRect(0,0,Fi.canvas.width,Fi.canvas.height),Fi.canvas.width&&y.ui.push({image:Fi.canvas,position:[256*Bi.bg.x,s.size[1]/2-Fi.canvas.height/2]}),y.ui.push({image:Pi,position:[ji,s.size[1]/2-Pi.height/2]})}n.attack&&3===n.attack.power&&7===n.attack.time?(a.fillStyle="white",a.fillRect(0,0,a.canvas.width,a.canvas.height)):(m||q||R||(S||n.moved)&&!A||function(e,t,a,i){var n=i.state.time,r=(i.cache,a.cell[0]-a.prev[0]),o=a.cell[1]-a.prev[1],l=Math.abs(r)+Math.abs(o);a.prev[0]+=r/4,a.prev[1]+=o/4;var s=0;a.selection&&!i.state.dialogs.length?s=1:l<.001&&(s=Math.floor(n/30)%2);var c=16*a.prev[0],u=16*a.prev[1],h=t[i.cache.phase.faction][s];e.cursor.push({image:h,position:[c,u]})}(y,i.ui.cursor,l,e),function(e,t,a,i){for(var n=a.map,r=(a.phase,i.cache),o=i.state.attacks,l=i.state.anims,s=l[0],c=0;c<r.units.length;c++){var u=r.units[c],h=u.original,f=u.cell,g=16*f[0],p=16*f[1],d=0,m=t[u.faction][gn[u.type]];if(!r.phase.pending||r.phase.pending.includes(h)||r.phase.faction!==u.faction||o.length&&o[0].target===h||s&&s.target===u&&("move"===s.type||"attack"===s.type)||(m=t.done[u.faction][gn[u.type]]),n.units[c]===h?Ji(u.cell,h.cell)||r.moved||(s.done=!0,s=l[0]=un("move",u,cn.move(r.path))):l.length||(s&&(s.done=!0),s=l[0]=un("fade",u,cn.fade())),s&&s.target===u){if("lift"===s.type||"drop"===s.type)d=s.data.height;else if("move"===s.type||"attack"===s.type)g=16*s.data.cell[0],p=16*s.data.cell[1];else if("fade"===s.type){if(s.done){r.units.splice(c--,1);continue}if(!s.data.visible)continue}e.selection.push({image:m,position:[g,p-d]})}else{if(r.attack){var v=o[0];v.target===h&&v.damage&&r.attack.connected&&r.attack.time<30&&r.attack.time%2&&(m=t.flashing)}e.pieces.push({image:m,position:[g,p]})}e.shadows.push({image:t.shadow,position:[g+1,p+4]})}}(y,i.pieces,t,e),function(e,t,a,i){var n=!0,r=!1,o=void 0;try{for(var l,s=t[Symbol.iterator]();!(n=(l=s.next()).done);n=!0){var c=l.value,u=e[c];"ui"!==c&&u.sort(function(e,t){return e.position[1]-t.position[1]});var h=!0,f=!1,g=void 0;try{for(var p,d=u[Symbol.iterator]();!(h=(p=d.next()).done);h=!0){var m=p.value,v=Math.round(m.position[0]),w=Math.round(m.position[1]-(m.position[2]||0));"ui"!==c&&(v-=a.position[0]+a.offset[0],w-=a.position[1]+a.offset[1]),i.drawImage(m.image,v,w)}}catch(e){f=!0,g=e}finally{try{!h&&d.return&&d.return()}finally{if(f)throw g}}}}catch(e){r=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw o}}}(y,w,s,a)),(c.length||m||!N)&&n.phase.pending||(n.phase.faction!==t.phase.faction&&(l.cell=t.phase.pending[0].cell.slice(),c.push(un("phase",t.phase.faction,cn.phase()))),n.phase={pending:t.phase.pending.slice(),faction:t.phase.faction})}var T=15,E=3;function j(t,e,a,i){var n=e.held,r=e.prev,o=a.map,l=a.phase;if(n.confirm&&!r.confirm)if(t.selection){var s=t.selection.unit;if(l.pending.includes(s)){var c=o.units.indexOf(s),u=i.cache.units[c],h=i.cache.ranges[c];if(h){var f=i.cache.path;if(f&&f.length){var g=f[f.length-1].slice(),p=Zi(o,t.cell);h.move.find(function(e){return Ji(e,t.cell)})?A(u,g):p&&h.attack.find(function(e){return Ji(e,t.cell)})&&(A(u,g),i.cache.target||(i.cache.target={unit:p,time:0}))}else i.cache.moved=!0}}else B(t)}else t.under&&(t.selection=t.under,t.selection.time=0);if(n.mod&&t.selection&&l.pending.includes(t.selection.unit)){var d=t.selection.unit,m=o.units.indexOf(d),v=i.cache.ranges[m];if(!n.left||r.left||n.right){if(n.right&&!r.right&&!n.left){for(y=t.cell[0];y<o.layout.size[0];y++){for(b=0;b<v.move.length;b++){var w=v.move[b];if(w[0]===y+1&&w[1]===t.cell[1])break}if(b===v.move.length)break}t.cell[0]=y}}else{for(var y=t.cell[0];0<=y;y--){for(var b=0;b<v.move.length;b++){var x=v.move[b];if(x[0]===y-1&&x[1]===t.cell[1])break}if(b===v.move.length)break}t.cell[0]=y}if(!n.up||r.up||n.down){if(n.down&&!r.down&&!n.up){for(z=t.cell[1];z<o.layout.size[1];z++){for(b=0;b<v.move.length;b++){var k=v.move[b];if(k[1]===z+1&&k[0]===t.cell[0])break}if(b===v.move.length)break}t.cell[1]=z}}else{for(var z=t.cell[1];0<=z;z--){for(var b=0;b<v.move.length;b++){var I=v.move[b];if(I[1]===z-1&&I[0]===t.cell[0])break}if(b===v.move.length)break}t.cell[1]=z}}else(n.left&&!r.left||n.left>T&&!(n.left%E))&&!n.right?P(t,"left",o):(n.right&&!r.right||n.right>T&&!(n.right%E))&&!n.left&&P(t,"right",o),(n.up&&!r.up||n.up>T&&!(n.up%E))&&!n.down?P(t,"up",o):(n.down&&!r.down||n.down>T&&!(n.down%E))&&!n.up&&P(t,"down",o);var M=Zi(o,t.cell);if(M?t.under&&M===t.under.unit?t.under.time++:!t.under&&i.cache.selected&&i.cache.selected.unit===M?t.under=i.cache.selected:t.under={unit:M,time:0}:t.under=null,!t.selection&&n.select&&!r.select){var S=n.mod;!function(e,t,a){var i=t.map,n=t.phase,r=Zi(i,e.cell);if(!r)return(r=n.pending.find(function(e){return e.faction===n.faction}))&&(e.cell=r.cell.slice());var o=r.faction===n.faction?n.pending:i.units.filter(function(e){return e.faction===r.faction}),l=o.indexOf(r),s=null;s=a?0<=l-1?o[l-1]:o[o.length-1]:l+1<o.length?o[l+1]:o[0];s&&(e.cell=s.cell.slice())}(t,a,S)}}function B(e){e.selection=null}function P(e,t,a){var i=a.layout.size;"left"===t?--e.cell[0]<0&&(e.cell[0]=0):"right"===t?++e.cell[0]>=i[0]&&(e.cell[0]=i[0]-1):"up"===t?--e.cell[1]<0&&(e.cell[1]=0):"down"===t&&++e.cell[1]>=i[1]&&(e.cell[1]=i[1]-1)}var U,_={left:["KeyA","ArrowLeft"],up:["KeyW","ArrowUp"],right:["KeyD","ArrowRight"],down:["KeyS","ArrowDown"],confirm:["Space"],cancel:["Escape"],select:["Tab"],mod:["ShiftLeft"]};(U="sprites.png",new Promise(function(e,t){var a=new Image;a.src=U,a.onload=function(){e(a)},a.onerror=function(){t(new Error("Failed to load image `"+U+"`"))}})).then(function(e){var d=(a=256,i=240,n=o(e),r=document.createElement("canvas"),r.width=a,r.height=i,{sprites:n,context:r.getContext("2d"),state:{time:0,anims:[un("phase","player",cn.phase())],cursor:{cell:null,prev:null,selection:null,under:null},viewport:{size:[a,i],position:null,offset:[0,0],target:null,shake:0},menu:null,paused:!1,attacks:[],dialogs:[],log:[]},cache:{map:null,selection:null,selected:null,target:null,moved:!1,attack:null,phase:{pending:null,faction:"player"},units:null,ranges:[],squares:[],particles:[],log:null,menu:{box:null,labels:[]},dialogs:{objective:null,selection:null,target:null}}}),t=d.context.canvas;var a,i,n,r;document.querySelector("main").appendChild(t),function e(){L(d,K);!function(e){var t=e.cache,a=e.state;a.time++;var i=a.cursor;i.selection?i.selection.time++:t.selection&&t.selection.time++,t.target&&t.target.time++,t.attack&&t.attack.connected&&t.attack.time++;var n=e.state.anims,r=n[0];r&&(r.done?n.shift():cn[r.type].update(r))}(d);var t=F.held,a=F.prev;var i=d.state.cursor;var n=d.state.anims;var r=d.state.dialogs;var o=r[0];o?(l=o.menu,c=(s=F).held,u=s.prev,c.confirm&&!u.confirm&&(l.done=!0),l.done||(c.select&&!u.select?m(l,c.mod):!c.up||u.up||c.down?!c.down||u.down||c.up||m(l):m(l,!0))):d.state.attacks.length||d.cache.moved||n.length&&"phase"===n[0].type||j(i,F,K,d);var l,s,c,u;if(t.cancel&&!a.cancel){var h=d.state.anims[0];if(!h||"move"!==h.type)if(o){if("pause"===o.type)d.state.paused=!1;else if("actions"===o.type){var f=d.state.cursor.selection.unit,g=K.map.units.indexOf(f);d.cache.units[g].cell=f.cell,d.cache.moved=null}r.shift(),r.length&&"actions"===(o=r[0]).type&&(o.menu.done=!1)}else i.selection?B(i):d.state.attacks.length||h&&"phase"===h.type||(d.state.paused=!0)}p=F,Object.assign(p.prev,p.held);var p;requestAnimationFrame(e)}()});var N,G,K=(G=(N=e).units.map(function(e){return function(e,t,a,i,n){return{name:e,type:t,faction:a,ai:i,cell:n,hp:3,stats:g[t],equipment:d[t]}}.apply(void 0,_toConsumableArray(e))}),{map:{layout:N.layout,units:G},phase:{faction:"player",pending:G.filter(function(e){return"player"===e.faction})}}),F={held:function(e,i){var n={},r=!1;function t(e){var t=null;if(i)for(var t in i){for(var a=0;a<i[t].length&&i[t][a]!==e.code;a++);if(a<i[t].length)break;t=null}t||(t=e.code),"keydown"===e.type?n[t]||(n[t]=1):"keyup"===e.type&&(n[t]=0),r||(r=!0,requestAnimationFrame(o))}function o(){for(var e in n)n[e]&&n[e]++;requestAnimationFrame(o)}return e.addEventListener("keydown",t),e.addEventListener("keyup",t),n}(window,_),prev:{}};window.addEventListener("keydown",function(e){"Tab"===e.code&&e.preventDefault()})}();