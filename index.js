"use strict";var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],a=!0,n=!1,i=void 0;try{for(var o,l=e[Symbol.iterator]();!(a=(o=l.next()).done)&&(r.push(o.value),!t||r.length!==t);a=!0);}catch(e){n=!0,i=e}finally{try{!a&&l.return&&l.return()}finally{if(n)throw i}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toArray(e){return Array.isArray(e)?e:Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}!function(){function _(e,t,r){return{type:e,target:t,data:r,done:!1}}function e(){return{height:0}}e.update=function(e){e.done||4==++e.data.height&&(e.done=!0)};var t=Object.freeze({default:e});function r(e){return{height:4,time:0}}r.update=function(e){if(!e.done){var t=e.data;t.time++;var r=t.time%120/120;t.height=4+Math.sin(2*Math.PI*r)}};var a=Object.freeze({default:r});function n(e){return{height:Math.round(e||4)}}n.update=function(e){e.done||--e.data.height||(e.done=!0)};var i=Object.freeze({default:n});function o(e){return{path:e,cell:e[0].slice(),time:0}}o.update=function(e){if(e.done)return!1;var t=e.data,r=Math.floor(t.time/4),a=t.time%4*.25,n=t.path[r],i=t.path[r+1];return i?t.cell=[n[0]+(i[0]-n[0])*a,n[1]+(i[1]-n[1])*a]:(t.cell=n.slice(),e.done=!0),t.time++,!0};var l=Object.freeze({default:o});function s(e,t){var r=[t[0]-e[0],t[1]-e[1]],a=Math.sqrt(r[0]*r[0]+r[1]*r[1]);return{src:e,norm:[r[0]/a,r[1]/a],cell:e.slice(),time:0}}s.update=function(e){if(!e.done){var t=e.data,r=t.time<=4?t.time:4-(t.time-4);t.cell[0]=t.src[0]+t.norm[0]/8*r,t.cell[1]=t.src[1]+t.norm[1]/8*r,9==++t.time&&(e.done=!0)}};var u=Object.freeze({default:s});function c(){return{time:0,flashing:!1}}c.update=function(e){if(!e.done){var t=e.data;t.flashing=!t.flashing,15==++t.time&&(e.done=!0)}};var f=Object.freeze({default:c});function h(){return{time:0,visible:!0}}h.update=function(e){if(!e.done){var t=e.data;t.visible=!t.visible,30==++t.time&&(e.done=!0)}};var g=Object.freeze({default:h}),z={lift:t&&e||t,float:a&&r||a,drop:i&&n||i,move:l&&o||l,attack:u&&s||u,flinch:f&&c||f,fade:g&&h||g};function R(e,t){return Math.abs(t[0]-e[0])+Math.abs(t[1]-e[1])}function p(e){return e[0]}function d(e){return e[1]}function De(e,t){return p(e)===p(t)&&d(e)===d(t)}function D(e,t){t||(t=1);for(var r=[{steps:0,cell:e}],a=[];r.length;)for(var n=r.shift(),i=[[p(n.cell)-1,d(n.cell)],[p(n.cell)+1,d(n.cell)],[p(n.cell),d(n.cell)-1],[p(n.cell),d(n.cell)+1]],o=0;o<i.length;o++){var l=i[o];if(!De(e,l)){for(var s=0;s<a.length;s++){if(De(l,a[s]))break}s<a.length||(a.push(l),n.steps+1<t&&r.push({steps:n.steps+1,cell:l}))}}return a}function v(e){return e.layout.size[0]}function Ee(e,t){return e.tiles[e.layout.data[d(t)*v(e)+p(t)]]}function E(e,t){for(var r=0;r<e.units.length;r++){var a=e.units[r];if(De(t,a.cell))return a}}function m(e,t){return 0<=p(t)&&p(t)<v(e)&&0<=d(t)&&d(t)<e.layout.size[1]}function y(e,t,r){return{type:e,faction:t,cell:r,hp:3}}function L(e,t){if("warrior"===e.type)if("warrior"===t.type)t.hp-=2;else if("knight"===t.type)t.hp-=2;else{if("rogue"===t.type)return;"mage"===t.type&&(t.hp-=3)}else if("knight"===e.type)"warrior"===t.type?t.hp-=2:"knight"===t.type?t.hp-=1:"rogue"===t.type?t.hp-=2:"mage"===t.type&&(t.hp-=2);else if("rogue"===e.type)if("warrior"===t.type)t.hp-=2;else{if("knight"===t.type)return;"rogue"===t.type?t.hp-=1:"mage"===t.type&&(t.hp-=2)}else"mage"===e.type&&("warrior"===t.type?t.hp-=2:"knight"===t.type?t.hp-=1:"rogue"===t.type?t.hp-=2:"mage"===t.type&&(t.hp-=1));t.hp<0&&(t.hp=0)}function Le(e){switch(e.type){case"warrior":return 4;case"knight":return 3;case"rogue":return 7;case"mage":return 4}}function j(e){switch(e.type){case"warrior":case"knight":case"rogue":return 1;case"mage":return 2}}function je(e,t){return e.faction===t.faction||"player"===e.faction&&"ally"===t.faction||"ally"===e.faction&&"player"===t.faction}function qe(e,t){var r=j(t),a=Le(t);if(!a)return[];for(var n=[{steps:0,cell:t.cell}],i=[t.cell];n.length;)for(var o=n.shift(),l=D(o.cell),s=0;s<l.length;s++){var u=l[s];if(m(e,u))if(!Ee(e,u).solid){for(var c=0;c<i.length&&!De(u,i[c]);c++);if(!(c<i.length)){for(c=0;c<e.units.length;c++){if(De(u,(p=e.units[c]).cell))break;p=null}if((!p||p&&!je(t,p))&&i.push(u),(!p||p&&je(t,p))&&o.steps<a-1)n.push({steps:o.steps+1,cell:u});else{var f=D(u,r);for(c=0;c<f.length;c++){var h=f[c];if(m(e,h)&&!De(h,t.cell)){for(var g=0;g<i.length&&!De(h,i[g]);g++);if(!(g<i.length)){for(g=0;g<e.units.length;g++){var p;if(De(h,(p=e.units[g]).cell))break;p=null}p&&i.push(h)}}}}}}}return i}function I(e,t){var r=document.createElement("canvas");return r.width=e,r.height=t,r.getContext("2d")}var Pe={warrior:"axe",knight:"shield",rogue:"dagger",mage:"hat"};function q(e,t){var r=e.phase.pending;r.splice(r.indexOf(t),1),r.length||function e(t){var r=t.map,a=t.phase;a.faction="player"===a.faction?"enemy":"player";a.pending=r.units.filter(function(e){return e.faction===a.faction});a.pending.length||e(t)}(e)}var Be=I(16,16);function P(e){return{sprites:e,context:document.createElement("canvas").getContext("2d"),anims:[],path:[],cursor:null,target:null,selection:null,hover:{time:0,target:null,dialog:null,entering:!1},cache:{time:0,phase:{faction:"player",next:"player",pending:[]},units:[],hover:{target:null,last:null},range:null,selection:null}}}Be.fillStyle="lime",Be.fillRect(0,0,16,16),Be=Be.canvas,P.render=function(c,e){var f=c.sprites,t=c.context,h=c.anims,r=c.cursor,g=c.cache,a=e.map,p=e.phase,n=_slicedToArray(a.layout.size,2),i=n[0],o=n[1],l=t.canvas,d=h[0],s=["tiles","shadows","walls","pieces","squares","arrows","cursor","selection","dialogs"],v={},u=!0,m=!1,y=void 0;try{for(var w,b=s[Symbol.iterator]();!(u=(w=b.next()).done);u=!0){var x=w.value;v[x]=[]}}catch(e){m=!0,y=e}finally{try{!u&&b.return&&b.return()}finally{if(m)throw y}}if(g.units.length||(g.units=a.units.map(function(e){return Object.assign({original:e},e)})),g.phase.pending.length<p.pending.length&&!h.find(function(e){return e.target.faction===g.phase.faction})&&(g.phase.pending=p.pending.slice()),g.phase.faction!==g.phase.next){var k=h.find(function(e){return e.target.faction===g.phase.faction});(!k||0<h.indexOf(k))&&(g.phase.faction=g.phase.next)}g.phase.next!==p.faction&&g.phase.faction===g.phase.next&&(g.phase.next=p.faction),l.width=16*i,l.height=16*o,t.beginPath(),t.fillStyle="black",t.fillRect(0,0,l.width,l.height);var I=c.hover.dialog;if(g.hover.target!==c.hover.target){g.hover.target=c.hover.target;var A=c.hover.target;if(c.hover.entering!==!!A&&(c.hover.entering=!!A),A){g.hover.last=A;var S=f.pieces.symbols[Pe[A.type]];(I=c.hover.dialog=f.ui.TextBox(["  "+A.type.toUpperCase(),"","HP  "+A.hp+"/3","STR "+function(e){switch(e.type){case"warrior":return 3;case"knight":return 2;case"rogue":return 1;case"mage":return 0}}(A),"INT "+function(e){switch(e.type){case"warrior":return 0;case"knight":return 2;case"rogue":return 1;case"mage":return 3}}(A),"AGI "+function(e){switch(e.type){case"warrior":return 2;case"knight":return 0;case"rogue":return 3;case"mage":return 1}}(A),"MOV "+Le(A)])).getContext("2d").drawImage(S,16,16)}}var M=c.hover.target||g.hover.last;if(M){var O=8<=M.cell[0]?-I.width:t.canvas.width,C=O+((8<=M.cell[0]?8:t.canvas.width-I.width-8)-O)/8*c.hover.time,T=t.canvas.height-I.height-8;c.hover.entering&&8<++c.hover.time?c.hover.time=8:!c.hover.entering&&--c.hover.time<0&&(c.hover.time=0),v.dialogs.push({image:I,position:[C,T]})}if(M=c.selection){g.selection!==M&&(g.range=qe(a,M),g.selection=M);var _=!0,z=!1,R=void 0;try{for(var D,E=g.range[Symbol.iterator]();!(_=(D=E.next()).done);_=!0){var L=D.value,j=_slicedToArray(L,2),q=j[0],P=j[1],B="move",X=!0,Y=!1,F=void 0;try{for(var G,H=a.units[Symbol.iterator]();!(X=(G=H.next()).done);X=!0){var N=G.value;if(De(L,N.cell)){B=je(M,N)?"ally":"attack";break}}}catch(e){Y=!0,F=e}finally{try{!X&&H.return&&H.return()}finally{if(Y)throw F}}"move"!==B&&"attack"!==B||("move"===B?t.fillStyle="blue":"attack"===B&&(t.fillStyle="red"),t.fillRect(16*q+1,16*P+1,15,15))}}catch(e){z=!0,R=e}finally{try{!_&&E.return&&E.return()}finally{if(z)throw R}}}else g.range=null,g.selection=null;for(var U=0;U<o;U++)for(var V=0;V<i;V++)t.strokeStyle="player"===g.phase.faction?"green":"maroon",t.beginPath(),t.strokeRect(16*V-7.5,16*U-7.5,16,16),t.beginPath(),t.strokeRect(16*V+8.5,16*U+8.5,16,16);for(var J=0;J<o;J++)for(var K=0;K<i;K++)"wall"===Ee(a,[K,J]).name&&v.walls.push({image:Be,position:[16*K,16*J]});for(var Q=function(e){var t=g.units[e],r={warrior:"axe",knight:"shield",rogue:"dagger",mage:"hat"}[t.type],a=f.pieces[t.faction][r],n=t.cell,i=0;if(d&&t.original===d.target){if("lift"===d.type||"float"===d.type||"drop"===d.type)i=-d.data.height;else if("move"===d.type)n=d.data.cell,d.done&&(t.cell=d.data.cell);else if("attack"===d.type)n=d.data.cell;else if("flinch"===d.type)d.data.flashing&&(a=f.pieces.flashing);else if("fade"===d.type){if(d.done)return g.units.splice(e--,1),"continue";if(!d.data.visible)return"continue"}}else!g.phase.pending.includes(t.original)||p.pending.includes(t.original)||h.length||g.phase.pending.splice(g.phase.pending.indexOf(t.original),1);var o=_slicedToArray(n,2),l=o[0],s=o[1];t.faction!==g.phase.faction||g.phase.pending.includes(t.original)||h.find(function(e){return e.target===t.original})||(a=f.pieces.done[t.faction][r]);var u="pieces";(t.original===c.selection||h.find(function(e){return["lift","float","drop","attack"].includes(e.type)&&e.target===t.original}))&&(u="selection"),v[u].push({image:a,position:[16*l,16*s+i]}),v.shadows.push({image:f.pieces.shadow,position:[16*l+1,16*s+4]}),W=e},W=0;W<g.units.length;W++)Q(W);if(c.path.length){var Z=c.path;for(W=0;W<Z.length;W++){var $=_slicedToArray(Z[W],2),ee=$[0],te=$[1],re=!1,ae=!1,ne=!1,ie=!1,oe=Z[W-1];if(oe){var le=ee-oe[0],se=te-oe[1];1===le?re=!0:-1===le&&(ae=!0),1===se?ne=!0:-1===se&&(ie=!0)}var ue=Z[W+1];if(ue){var ce=ue[0]-ee,fe=ue[1]-te;-1===ce?re=!0:1===ce&&(ae=!0),-1===fe?ne=!0:1===fe&&(ie=!0)}if(re||ae||ne||ie){var he=null;re&&ae?he="horiz":ne&&ie?he="vert":ne&&re?he="upLeft":ne&&ae?he="upRight":ie&&re?he="downLeft":ie&&ae?he="downRight":re&&!W?he="leftStub":ae&&!W?he="rightStub":ne&&!W?he="upStub":ie&&!W?he="downStub":re?he="left":ae?he="right":ne?he="up":ie&&(he="down"),he&&v.arrows.push({image:f.ui.arrows[he],position:[16*ee,16*te]})}}}if(r){var ge=_slicedToArray(r,2),pe=ge[0],de=ge[1],ve=Math.floor(g.time/30)%f.ui.cursor.length;v.cursor.push({image:f.ui.cursor[ve],position:[16*pe,16*de]})}var me=!0,ye=!1,we=void 0;try{for(var be,xe=s[Symbol.iterator]();!(me=(be=xe.next()).done);me=!0){var ke=be.value,Ie=v[ke];Ie.sort(function(e,t){return e.position[1]-t.position[1]});var Ae=!0,Se=!1,Me=void 0;try{for(var Oe,Ce=Ie[Symbol.iterator]();!(Ae=(Oe=Ce.next()).done);Ae=!0){var Te=Oe.value,_e=_slicedToArray(Te.position,3),ze=_e[0],Re=_e[1];_e[2],t.drawImage(Te.image,Math.round(ze),Math.round(Re))}}catch(e){Se=!0,Me=e}finally{try{!Ae&&Ce.return&&Ce.return()}finally{if(Se)throw Me}}}}catch(e){ye=!0,we=e}finally{try{!me&&xe.return&&xe.return()}finally{if(ye)throw we}}},P.update=function(e){e.cache.time++;var t=e.anims,r=t[0];r&&(r.done?t.shift():z[r.type].update(r))};var w={piece:{palette:[80,50,3,3],shadow:[16,120,14,14],symbols:{shield:[128,88,8,8],bow:[128,72,8,8],dagger:[128,34,8,8],sword:[128,16,8,8],axe:[128,104,8,8],hat:[128,0,8,8],lance:[128,56,8,8]},base:[96,34,16,16]},tiles:{"stairs-base":[112,56,16,16],"grass-edge":[112,0,16,16],"wall-base":[112,104,16,16],water:[112,16,16,16],floor:[112,34,16,16],bridge:[96,104,16,16],"bridge-left":[112,88,16,16],"grass-hang":[0,120,16,16],stairs:[64,120,16,16],grass:[96,120,16,16],wall:[112,120,16,16],"grass-rock":[112,72,16,16],"wall-reflection":[96,16,16,16],"bridge-right":[80,34,16,16]},ui:{cursor:[64,104,32,16],box:[64,56,48,48],squares:[80,0,32,16],arrows:[0,56,64,64],typeface:[0,0,80,56],swords:[80,16,16,18]}};function b(e,t,r,a,n){var i=document.createElement("canvas"),o=i.getContext("2d");return i.width=a,i.height=n,o.drawImage(e,-t,-r),i}var A={get:function(e,t,r){var a=4*(r*e.width+t),n=e.data[a],i=e.data[a+1],o=e.data[a+2],l=e.data[a+3];return[n,i,o,l]},replace:function(e,t,r){for(var a=0;a<e.data.length;a+=4){for(var n=0;n<4&&e.data[a+n]===t[n];n++);if(4===n)for(var n=0;n<4;n++)e.data[a+n]=r[n]}}};function x(e){var t=function e(t,r){var a={};for(var n in r)if(Array.isArray(r[n])){var i=_slicedToArray(r[n],4),o=i[0],l=i[1],s=i[2],u=i[3];a[n]=b(t,o,l,s,u)}else a[n]=e(t,r[n]);return a}(e,w);return{tiles:t.tiles,pieces:function(e){var t={player:{},enemy:{},ally:{},done:{player:{},enemy:{},ally:{}},flashing:null,symbols:e.symbols,shadow:e.shadow},r=e.palette.getContext("2d").getImageData(0,0,3,3),a={black:[0,0,0,255],white:[255,255,255,255],cyan:A.get(r,0,0),blue:A.get(r,1,0),navy:A.get(r,2,0),pink:A.get(r,0,1),red:A.get(r,1,1),purple:A.get(r,2,1),lime:A.get(r,0,2),green:A.get(r,1,2),teal:A.get(r,2,2)},n={player:[a.cyan,a.blue,a.navy],enemy:[a.pink,a.red,a.purple],ally:[a.lime,a.green,a.teal]};for(var i in n){var o=n[i];for(var l in e.symbols){var s=e.symbols[l],u=I(s.width,s.height);u.drawImage(s,0,0);var c=e.base.getContext("2d").getImageData(0,0,16,16);A.replace(c,a.white,o[1]),A.replace(c,a.black,o[2]);var f=I(c.width,c.height);f.putImageData(c,0,0);var h=u.getImageData(0,0,s.width,s.height);A.replace(h,a.white,o[0]),u.putImageData(h,0,0),f.drawImage(u.canvas,4,4),A.replace(h,o[0],o[2]),u.putImageData(h,0,0),f.drawImage(u.canvas,4,3),t[i][l]=f.canvas}}for(var g in n){var p=n[g];for(var d in e.symbols){var v=e.symbols[d],m=I(v.width,v.height);m.drawImage(v,0,0);var y=e.base.getContext("2d").getImageData(0,0,16,16);A.replace(y,a.white,p[2]);var w=I(y.width,y.height);w.putImageData(y,0,0);var b=m.getImageData(0,0,v.width,v.height);A.replace(b,a.white,p[1]),m.putImageData(b,0,0),w.drawImage(m.canvas,4,4),A.replace(b,p[1],a.black),m.putImageData(b,0,0),w.drawImage(m.canvas,4,3),t.done[g][d]=w.canvas}}var x=e.base.getContext("2d").getImageData(0,0,16,16);A.replace(x,a.blue,a.white),A.replace(x,a.navy,a.white);var k=I(x.width,x.height);return k.putImageData(x,0,0),t.flashing=k.canvas,t}(t.piece),ui:function(e){var u={swords:e.swords,cursor:function(e){for(var t=e.width/16,r=new Array(t),a=0;a<t;a++)r[a]=b(e,16*a,0,16,16);return r}(e.cursor),typeface:function(e){for(var t={},r=0,a=0;a<7;a++)for(var n=0;n<10;n++){var i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,.!?abcdefghijklmnopqrstuvwxyz'\"/ "[r++];t[i]=b(e,8*n,8*a,8,8)}return t}(e.typeface),box:{topLeft:b(e.box,0,0,16,16),top:b(e.box,16,0,16,16),topRight:b(e.box,32,0,16,16),left:b(e.box,0,16,16,16),center:b(e.box,16,16,16,16),right:b(e.box,32,16,16,16),bottomLeft:b(e.box,0,32,16,16),bottom:b(e.box,16,32,16,16),bottomRight:b(e.box,32,32,16,16)},squares:{move:b(e.squares,0,0,16,16),attack:b(e.squares,16,0,16,16)},arrows:{left:b(e.arrows,0,0,16,16),right:b(e.arrows,16,0,16,16),up:b(e.arrows,32,0,16,16),down:b(e.arrows,48,0,16,16),leftStub:b(e.arrows,0,16,16,16),rightStub:b(e.arrows,16,16,16,16),upStub:b(e.arrows,32,16,16,16),downStub:b(e.arrows,48,16,16,16),upLeft:b(e.arrows,0,32,16,16),upRight:b(e.arrows,16,32,16,16),downLeft:b(e.arrows,32,32,16,16),downRight:b(e.arrows,48,32,16,16),horiz:b(e.arrows,0,48,16,16),vert:b(e.arrows,16,48,16,16)}};return u.Text=c,u.Box=f,u.TextBox=function(e){var t=e.map(function(e){return e.length}),r=8*Math.max.apply(Math,_toConsumableArray(t)),a=8*e.length,n=f(r+32,a+32),i=document.createElement("canvas"),o=i.getContext("2d");i.width=r,i.height=a;for(var l=0;l<e.length;l++){var s=e[l];o.drawImage(c(s),0,8*l)}return n.getContext("2d").drawImage(i,16,16),n},u;function c(e){var t=document.createElement("canvas");t.width=8*e.length,t.height=8;for(var r=t.getContext("2d"),a=0;a<e.length;a++){var n=e[a],i=u.typeface[n];r.drawImage(i,8*a,0)}return t}function f(e,t){var r=Math.ceil(e/16),a=Math.ceil(t/16),n=document.createElement("canvas"),i=n.getContext("2d");n.width=e,n.height=t;for(var o=1;o<r-1;o++)i.drawImage(u.box.top,16*o,0),i.drawImage(u.box.bottom,16*o,t-16);for(var l=1;l<a-1;l++){i.drawImage(u.box.left,0,16*l),i.drawImage(u.box.right,e-16,16*l);for(var s=1;s<r-1;s++)i.drawImage(u.box.center,16*s,16*l)}return i.drawImage(u.box.topLeft,0,0),i.drawImage(u.box.topRight,n.width-16,0),i.drawImage(u.box.bottomLeft,0,n.height-16),i.drawImage(u.box.bottomRight,n.width-16,n.height-16),n}}(t.ui)}}function B(e,t,r){for(var a=[],n=[t],i={},o={},l={},s={},u={},c=0;c<e.length;c++){s[h=e[c]]=1/0,u[h]=1/0}for(s[t]=0,u[t]=R(t,r);n.length;){var f={score:1/0,index:-1,cell:null};for(c=0;c<n.length;c++){(v=u[h=n[c]])<f.score&&(f.score=v,f.index=c,f.cell=h)}var h;if(De(h=f.cell,r)){for(;!De(h,t);)a.unshift(h),h=l[h];return a.unshift(h),a}n.splice(f.index,1),i[h]=!1,o[h]=!0;var g=D(h);for(c=0;c<g.length;c++){var p=g[c];if(!o[p]){for(var d=0;d<e.length;d++){if(De(e[d],p))break}var v;if(d!==e.length)i[p]||(i[p]=!0,n.push(p)),(v=s[h]+1)>=s[p]||(l[p]=h,s[p]=v,u[p]=v+R(p,r))}}}}var k,S=document.querySelector("main");(k="sprites.png",new Promise(function(e,t){var r=new Image;r.src=k,r.onload=function(){e(r)},r.onerror=function(){t(new Error("Failed to load image `"+k+"`"))}})).then(function(e){var C=P(x(e)),T=C.context.canvas,c=!1,O=null;S.appendChild(T),function e(){P.render(C,F);P.update(C);if("enemy"===Y.faction){if(!O){var t=X.units.filter(function(e){return"enemy"===e.faction});O=function(x,t){for(var k=[],I={tiles:x.tiles,layout:x.layout,units:x.units.map(function(e){return Object.assign({},e)})},A=[],e=_slicedToArray(x.layout.size,2),r=e[0],a=e[1],n=0;n<a;n++)for(var i=0;i<r;i++){var o=n*r+i,l=x.layout.data[o];x.tiles[l].solid||A.push([i,n])}var s=I.units.filter(function(e){return e.faction===t}),u=function(r){var e=[],a=[],n=qe(I,r),t=!0,i=!1,o=void 0;try{for(var l,s=n[Symbol.iterator]();!(t=(l=s.next()).done);t=!0){var u=l.value,c=E(I,u);c&&!je(r,c)&&a.push(c)}}catch(e){i=!0,o=e}finally{try{!t&&s.return&&s.return()}finally{if(i)throw o}}if(a.length){a.sort(function(e,t){return e.hp-t.hp}),3===a[0].hp&&a.sort(function(e,t){return R(r.cell,e.cell)-R(r.cell,t.cell)});var f=a[0],h=D(f.cell,j(r)).filter(function(t){return n.find(function(e){return De(e,t)})&&!E(I,t)});if(h.length){h.sort(function(e,t){return R(f.cell,t)-R(f.cell,e)});var g=h[0];e.push(["move",g],["attack",x.units[I.units.indexOf(f)]]),r.cell=g,L(r,f)}}else if((a=I.units.filter(function(e){return!je(r,e)})).length){var p=a.map(function(e){return B(A,r.cell,e.cell).slice(0,-1)});a.sort(function(e,t){return p[a.indexOf(e)].length-p[a.indexOf(t)]});for(var d=a[0],v=p.find(function(e){return 1===R(e[e.length-1],d.cell)}),m=[],y=function(e){var t=n[e],r=v.find(function(e){return De(t,e)});r&&!E(I,t)&&m.push(r)},w=0;w<n.length;w++)y(w);if(m.length){m.sort(function(e,t){return v.indexOf(t)-v.indexOf(e)});var b=m[0];e.push(["move",b]),r.cell=b}}k.push(e)},c=!0,f=!1,h=void 0;try{for(var g,p=s[Symbol.iterator]();!(c=(g=p.next()).done);c=!0)u(g.value)}catch(e){f=!0,h=e}finally{try{!c&&p.return&&p.return()}finally{if(f)throw h}}return k}(X,"enemy");for(var r=0;r<O.length;r++){var a=O[r],n=t[r],i=!0,o=!1,l=void 0;try{for(var s,u=a[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var c=s.value,f=_toArray(c),h=f[0],g=f.slice(1);if("move"===h){var p=_slicedToArray(g,1),d=p[0],v=qe(X,n),m=!0,y=!1,w=void 0;try{for(var b,x=t[Symbol.iterator]();!(m=(b=x.next()).done);m=!0){var k=b.value;v.push(k.cell)}}catch(e){y=!0,w=e}finally{try{!m&&x.return&&x.return()}finally{if(y)throw w}}var I=B(v,n.cell,d);C.anims.push(_("move",n,z.move(I))),n.cell=d}else if("attack"===h){var A=_slicedToArray(g,1),S=A[0];if(!X.units.includes(S))continue;var M=S.hp;L(n,S),C.anims.push(_("attack",n,z.attack(n.cell,S.cell))),S.hp<M&&C.anims.push(_("flinch",S,z.flinch())),S.hp||(X.units.splice(X.units.indexOf(S),1),C.anims.push(_("fade",S,z.fade())))}}}catch(e){o=!0,l=e}finally{try{!i&&u.return&&u.return()}finally{if(o)throw l}}q(F,n)}}}else O=null;requestAnimationFrame(e)}(),window.addEventListener("mousemove",function(e){var t=[Math.floor(e.offsetX/16),Math.floor(e.offsetY/16)];if(e.target===T){C.cursor=t;var r=E(X,t);C.hover.target=r||null;var a=C.selection;if(a){var n=C.path[C.path.length-1],i=E(X,t);if(De(t,a.cell))C.path=[a.cell];else if(!De(n,t)&&!(i&&R(n,t)<=j(a))&&C.cache.range.find(function(e){return De(e,t)})){for(var o=0;o<C.path.length;o++){var l=C.path[o];if(De(l,t))break}if(o<C.path.length)return void C.path.splice(o+1,C.path.length-o-1);for(var s=C.cache.range.slice(),u=0;u<s.length;u++){var c=s[u];if(c){var f=E(X,c);f&&!je(a,f)&&s.splice(u--,1)}}var h=X.units.filter(function(e){return je(a,e)}),g=!0,p=!1,d=void 0;try{for(var v,m=h[Symbol.iterator]();!(g=(v=m.next()).done);g=!0){var y=v.value;s.push(y.cell)}}catch(e){p=!0,d=e}finally{try{!g&&m.return&&m.return()}finally{if(p)throw d}}for(var w=s.slice(),b=0;b<w.length;b++)for(var x=w[b],k=0;k<C.path.length;k++){var I=C.path[k];if(De(x,I)){w.splice(b--,1);break}}var A=t;if(i){var S=D(i.cell,j(a)).filter(function(t){return s.find(function(e){return De(e,t)})});S.length&&(A=S[0])}if(h.find(function(e){return De(A,e.cell)}))return;var M,O=B(w,n,A);if(O&&C.path.length+O.length-2<=Le(a))O.shift(),(M=C.path).push.apply(M,_toConsumableArray(O));else C.path=B(s,a.cell,A)}}}else C.cursor=null}),T.addEventListener("mousedown",function(e){if(C.cursor||(C.cursor=[Math.floor(e.offsetX/16),Math.floor(e.offsetY/16)]),!C.selection){var t=E(X,C.cursor);t&&"player"===t.faction&&"player"===Y.faction&&Y.pending.includes(t)&&(c=!0,C.selection=t,C.path=[t.cell],C.anims.push(_("lift",t,z.lift()),_("float",t,z.float())))}}),T.addEventListener("mouseup",function(e){C.cursor||(C.cursor=[Math.floor(e.offsetX/16),Math.floor(e.offsetY/16)]);var t=C.selection;if(t){if(De(C.cursor,t.cell)){if(c)c=!1;else{C.selection=null,C.path=[],q(F,t);var r=null,a=C.anims[0];!a||"lift"!==a.type&&"float"!==a.type||(r=a.data.height,C.anims.shift()),C.anims.push(_("drop",t,z.drop(r)))}return}if(C.cache.range.find(function(e){return De(e,C.cursor)})){c=!1;var n=C.selection,i=E(X,C.cursor);if(i&&je(n,i))return;"float"===C.anims[0].type&&C.anims.shift();var o=_("move",n,z.move(C.path));if(C.anims.push(o),n.cell=C.path[C.path.length-1],i){var l=i.hp;L(n,i),C.anims.push(_("attack",n,z.attack(n.cell,i.cell))),i.hp<l&&C.anims.push(_("flinch",i,z.flinch())),i.hp||(X.units.splice(X.units.indexOf(i),1),C.anims.push(_("fade",i,z.fade())))}q(F,n)}else{var s=null,u=C.anims[0];!u||"lift"!==u.type&&"float"!==u.type||(s=u.data.height,C.anims.shift()),C.anims.push(_("drop",t,z.drop(s)))}c||(C.selection=null,C.path=[])}})});for(var X={tiles:[{name:"null",solid:!1},{name:"wall",solid:!0}],layout:{size:[16,16],data:[1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,0,0,0,0,0,0,1,0,0,0,0,1,1,0,1,0,0,0,0,0,0,0,1,0,0,0,0,1,1,0,1,0,0,0,0,0,0,0,1,0,0,0,0,1,1,0,1,1,1,0,0,0,1,1,1,1,1,1,0,1,1,0,1,1,1,0,0,0,1,1,1,1,1,1,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,1,1,1,1,1,0,0,0,1,1,1,1,1,0,0,0,1,1,1,1,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},units:[y("warrior","player",[14,10]),y("rogue","player",[1,0]),y("mage","player",[8,11]),y("knight","enemy",[6,1]),y("warrior","enemy",[4,2]),y("warrior","enemy",[8,2]),y("mage","enemy",[13,1]),y("warrior","enemy",[12,3]),y("knight","enemy",[14,5]),y("mage","enemy",[11,8])]},Y={faction:"player",pending:[]},F={phase:Y,map:X},M=0;M<X.units.length;M++){var O=X.units[M];O.faction===Y.faction&&Y.pending.push(O)}}();