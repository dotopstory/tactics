"use strict";var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var a=[],i=!0,n=!1,r=void 0;try{for(var o,l=e[Symbol.iterator]();!(i=(o=l.next()).done)&&(a.push(o.value),!t||a.length!==t);i=!0);}catch(e){n=!0,r=e}finally{try{!i&&l.return&&l.return()}finally{if(n)throw r}}return a}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}!function(){var a={piece:{palette:[188,128,3,3],shadow:[160,32,14,14],symbols:{shield:[160,88,8,8],bow:[136,72,8,8],dagger:[112,88,8,8],axe:[112,112,8,8],hat:[176,64,8,8]},base:[16,176,16,16]},tiles:{"shadow-corner":[160,64,16,16],black:[112,72,16,16],"wall-base":[0,176,16,16],floor:[144,48,16,16],"shadow-edge":[144,32,16,16],grass:[176,0,16,16],wall:[96,112,16,16]},effects:{attack:[0,164,192,12]},ui:{cursor:[144,0,32,32],box:[64,64,48,48],squares:[64,112,32,16],arrows:[0,0,64,128],"enemy-phase":[0,146,170,18],healthbar:[112,64,48,8],symbols:{dragon:[128,72,8,8],shield:[160,80,8,8],bow:[176,16,8,8],boot:[32,176,8,8],dagger:[160,48,8,8],sword:[174,32,8,8],next:[176,24,8,8],eye:[184,16,8,8],clock:[112,120,8,8],axe:[120,112,8,8],hat:[112,96,8,8],enemy:[120,88,8,8],lance:[128,80,8,8]},"player-phase":[0,128,188,18],typeface:[64,0,80,64],swords:[170,146,16,18]}};function g(e,t,a,i,n){var r=document.createElement("canvas"),o=r.getContext("2d");return r.width=i,r.height=n,o.drawImage(e,-t,-a),r}var k={get:function(e,t,a){var i=4*(a*e.width+t),n=e.data[i],r=e.data[i+1],o=e.data[i+2],l=e.data[i+3];return[n,r,o,l]},set:function(e,t,a,i){var n=4*(a*e.width+t);e.data[n+0]=i[0],e.data[n+1]=i[1],e.data[n+2]=i[2],e.data[n+3]=i[3]},replace:function(e,t,a){for(var i=0;i<e.data.length;i+=4){for(var n=0;n<4&&e.data[i+n]===t[n];n++);if(4===n)for(var n=0;n<4;n++)e.data[i+n]=a[n]}}};function pn(e,t){var a=document.createElement("canvas");return a.width=e,a.height=t,a.getContext("2d")}var dn={black:[0,0,0,255],gray:[168,168,168,255],white:[255,255,255,255],cyan:[144,224,232,255],blue:[80,120,248,255],navy:[88,24,216,255],pink:[248,192,224,255],red:[208,0,88,255],purple:[56,0,80,255],lime:[200,224,144,255],green:[40,192,32,255],teal:[0,96,112,255]},c={warrior:"axe",knight:"shield",rogue:"dagger",mage:"hat"};function o(e){var t=function e(t,a){var i={};for(var n in a)if(Array.isArray(a[n])){var r=_slicedToArray(a[n],4),o=r[0],l=r[1],s=r[2],c=r[3];i[n]=g(t,o,l,s,c)}else i[n]=e(t,a[n]);return i}(e,a);return{tiles:t.tiles,pieces:function(e){var t={player:{},enemy:{},ally:{},done:{player:{},enemy:{},ally:{}},flashing:null,symbols:e.symbols,shadow:e.shadow},a={player:[dn.cyan,dn.blue,dn.navy],enemy:[dn.pink,dn.red,dn.purple],ally:[dn.lime,dn.green,dn.teal]};for(var i in a){var n=a[i];for(var r in e.symbols){var o=e.symbols[r],l=pn(o.width,o.height);l.drawImage(o,0,0);var s=e.base.getContext("2d").getImageData(0,0,16,16);k.replace(s,dn.white,n[1]),k.replace(s,dn.black,n[2]);var c=pn(s.width,s.height);c.putImageData(s,0,0);var u=l.getImageData(0,0,o.width,o.height);k.replace(u,dn.white,n[0]),l.putImageData(u,0,0),c.drawImage(l.canvas,4,4),k.replace(u,n[0],n[2]),l.putImageData(u,0,0),c.drawImage(l.canvas,4,3),t[i][r]=c.canvas}}for(var f in a){var h=a[f];for(var g in e.symbols){var p=e.symbols[g],d=pn(p.width,p.height);d.drawImage(p,0,0);var v=e.base.getContext("2d").getImageData(0,0,16,16);k.replace(v,dn.white,h[2]);var m=pn(v.width,v.height);m.putImageData(v,0,0);var y=d.getImageData(0,0,p.width,p.height);k.replace(y,dn.white,h[1]),d.putImageData(y,0,0),m.drawImage(d.canvas,4,4),k.replace(y,h[1],dn.black),d.putImageData(y,0,0),m.drawImage(d.canvas,4,3),t.done[f][g]=m.canvas}}var w=e.base.getContext("2d").getImageData(0,0,16,16);k.replace(w,dn.black,dn.white);var b=pn(w.width,w.height);return b.putImageData(w,0,0),t.flashing=b.canvas,t}(t.piece),ui:function(o){var y={symbols:o.symbols,swords:o.swords,cursor:(e=o.cursor,{player:[g(e,0,0,16,16),g(e,16,0,16,16)],enemy:[g(e,0,16,16,16),g(e,16,16,16,16)]}),typeface:p(o.typeface),healthbar:o.healthbar,phases:{player:o["player-phase"],enemy:o["enemy-phase"]},box:{topLeft:g(o.box,0,0,16,16),top:g(o.box,16,0,16,16),topRight:g(o.box,32,0,16,16),left:g(o.box,0,16,16,16),center:g(o.box,16,16,16,16),right:g(o.box,32,16,16,16),bottomLeft:g(o.box,0,32,16,16),bottom:g(o.box,16,32,16,16),bottomRight:g(o.box,32,32,16,16)},squares:{move:g(o.squares,0,0,16,16),attack:g(o.squares,16,0,16,16)},arrows:{player:{left:g(o.arrows,0,0,16,16),right:g(o.arrows,16,0,16,16),up:g(o.arrows,32,0,16,16),down:g(o.arrows,48,0,16,16),leftStub:g(o.arrows,0,16,16,16),rightStub:g(o.arrows,16,16,16,16),upStub:g(o.arrows,32,16,16,16),downStub:g(o.arrows,48,16,16,16),upLeft:g(o.arrows,0,32,16,16),upRight:g(o.arrows,16,32,16,16),downLeft:g(o.arrows,32,32,16,16),downRight:g(o.arrows,48,32,16,16),horiz:g(o.arrows,0,48,16,16),vert:g(o.arrows,16,48,16,16)},enemy:{left:g(o.arrows,0,64,16,16),right:g(o.arrows,16,64,16,16),up:g(o.arrows,32,64,16,16),down:g(o.arrows,48,64,16,16),leftStub:g(o.arrows,0,80,16,16),rightStub:g(o.arrows,16,80,16,16),upStub:g(o.arrows,32,80,16,16),downStub:g(o.arrows,48,80,16,16),upLeft:g(o.arrows,0,96,16,16),upRight:g(o.arrows,16,96,16,16),downLeft:g(o.arrows,32,96,16,16),downRight:g(o.arrows,48,96,16,16),horiz:g(o.arrows,0,112,16,16),vert:g(o.arrows,16,112,16,16)}}},l={};var e;return y.Text=u,y.Box=h,y.TextBox=function(e){var t=0,a=0,i=null;if(Array.isArray(e)){i=e.map(function(e){return u(e)});var n=e.map(function(e){return e.width}),r=Math.max.apply(Math,_toConsumableArray(n));t=r,a=8*e.length}else i=u(e),t=i.width,a=8;var o=h(t+16,a+16),l=pn(t,a);if(Array.isArray(e))for(var s=0;s<i.length;s++){var c=i[s];l.drawImage(c,0,8*s)}else l.drawImage(i,0,0);return l.canvas.width&&o.getContext("2d").drawImage(l.canvas,8,8),o},y.HealthBar=s,y.UnitDetails=function(e){var t=y.symbols[c[e.type]],a=u(e.name),i=h(a.width+t.width+20,24),n=i.getContext("2d");n.drawImage(t,8,8),n.drawImage(a,20,8);var r=h(84,24),o=s(e.hp/3,e.faction),l=u("HP");return(n=r.getContext("2d")).drawImage(l,8,8),n.drawImage(o,28,8),{name:i,hp:r}},y.Arrow=function(e,t){for(var a=[],i=0;i<e.length;i++){var n=_slicedToArray(e[i],2),r=n[0],o=n[1],l=!1,s=!1,c=!1,u=!1,f=e[i-1];if(f){var h=r-f[0],g=o-f[1];1===h?l=!0:-1===h&&(s=!0),1===g?c=!0:-1===g&&(u=!0)}var p=e[i+1];if(p){var d=p[0]-r,v=p[1]-o;-1===d?l=!0:1===d&&(s=!0),-1===v?c=!0:1===v&&(u=!0)}if(l||s||c||u){var m=null;l&&s?m="horiz":c&&u?m="vert":c&&l?m="upLeft":c&&s?m="upRight":u&&l?m="downLeft":u&&s?m="downRight":l&&!i?m="leftStub":s&&!i?m="rightStub":c&&!i?m="upStub":u&&!i?m="downStub":l?m="left":s?m="right":c?m="up":u&&(m="down"),m&&a.push({image:y.arrows[t][m],position:[r,o]})}}return a},y;function u(e,t){for(var a=0,i=0;i<e.length;i++){var n=e[i];a+=" "===n?4:8}var r=document.createElement("canvas");r.width=a,r.height=8;for(var o=r.getContext("2d"),l=0,s=0;l<e.length;l++){var c=e[l];if(" "===c)s+=4;else{var u=f(c,t);o.drawImage(u,s,0),s+=8}}return r}function f(e,t){if(!t)return y.typeface[e];if(l[t])return l[t][e];var a=o.typeface,i=a.getContext("2d").getImageData(0,0,a.width,a.height);console.log(t),k.replace(i,dn.white,t);var n=pn(a.width,a.height);n.putImageData(i,0,0);var r=p(n.canvas);return(l[t]=r)[e]}function h(e,t){var a=Math.ceil(e/16),i=Math.ceil(t/16),n=document.createElement("canvas"),r=n.getContext("2d");n.width=e,n.height=t;for(var o=1;o<a-1;o++)r.drawImage(y.box.top,16*o,0),r.drawImage(y.box.bottom,16*o,t-16);for(var l=1;l<i-1;l++)r.drawImage(y.box.left,0,16*l),r.drawImage(y.box.right,e-16,16*l);return r.fillRect(4,4,n.width-8,n.height-8),r.drawImage(y.box.topLeft,0,0),r.drawImage(y.box.topRight,n.width-16,0),r.drawImage(y.box.bottomLeft,0,n.height-16),r.drawImage(y.box.bottomRight,n.width-16,n.height-16),n}function s(e,t){var a=pn(48,8);return a.drawImage(y.healthbar,0,0),a.fillStyle={player:"rgb(144, 224, 232)",enemy:"rgb(248, 192, 224)",ally:"rgb(200, 224, 255)"}[t],a.fillRect(3,3,Math.floor(42*e),2),a.canvas}}(t.ui),effects:function(){var e=pn(1,1);e.fillStyle="white",e.fillRect(0,0,1,1);var t=pn(2,2);return t.fillStyle="white",t.fillRect(0,0,2,2),{small:e.canvas,large:t.canvas}}()}}function p(e){for(var t=e.width/8,a=e.height/8,i={},n=0,r=0;r<a;r++)for(var o=0;o<t;o++){i["0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,.!?abcdefghijklmnopqrstuvwxyz;:'\"()/\\-     "[n++]]=g(e,8*o,8*r,8,8)}return i}var t={name:"grass",solid:!1},i={name:"wall",solid:!0},n={name:"floor",solid:!1};"##########################      ##.......##      ##      ##.......##      ##      ##.......##      ##      ####...####      ##      ####...####      ##      ##.......##      ##    ####.......####    ##    ####.......####    ##    ...............    ##    ####.......####    ##    ####.......####    ##      ##.......##      ##      ###########      ##      ###########      ##                       ##                       ##      ##       ##      ##      ##       ##      ##########       ##################       #########                                                                                                    ".split("").map(function(e){switch(e){case" ":return t;case"#":return i;case".":return n}});var r={name:"grass",solid:!1},l={name:"floor",solid:!1},s={name:"wall",solid:!0},e={tiles:{grass:r,floor:l,wall:s},layout:{size:[20,20],data:["           #########","       ##  #......##"," #     ##  ##......#"," #         ##....###","        #   ###..###","        # #####...##","      ##  ###.#...# ","      ##  #.......# ","          ....##### ","#         ##..##### ","#    #    #####     ","     #     ####     ","                    ","                    ","        ##    #     ","        ##    #     "," #               ## "," ##    #         ## "," ##    #            ","                    "].join("").split("").map(function(e){switch(e){case" ":return r;case".":return l;case"#":return s}})},units:[["Hector","warrior","player",!1,[5,16]],["Oswin","knight","player",!1,[6,14]],["Erk","mage","player",!1,[4,13]],["Matthew","rogue","player",!1,[3,15]],["Nergal","mage","enemy","defend",[15,1]],["GOLEM","knight","enemy","wait",[13,2]],["GOLEM","knight","enemy","wait",[17,1]],["TROLL","knight","enemy","defend",[15,4]],["TROLL","knight","enemy","defend",[16,4]],["ORC","warrior","enemy","attack",[17,5]],["TROLL","knight","enemy","defend",[10,8]],["GOBLIN","rogue","enemy","attack",[8,6]],["ORC","warrior","enemy","attack",[5,8]],["TROLL","knight","enemy","attack",[2,6]],["GOBLIN","rogue","enemy","attack",[9,12]],["ORC","warrior","enemy","attack",[7,12]],["TROLL","knight","enemy","attack",[19,6]],["TROLL","knight","enemy","attack",[19,7]],["TROLL","knight","enemy","attack",[0,0]],["TROLL","knight","enemy","attack",[0,1]]]};function vn(e,t){return Math.abs(t[0]-e[0])+Math.abs(t[1]-e[1])}function u(e){return e[0]}function f(e){return e[1]}function mn(e,t){return u(e)===u(t)&&f(e)===f(t)}function yn(e,t){t||(t=1);for(var a=[{steps:0,cell:e}],i=[];a.length;)for(var n=a.shift(),r=[[u(n.cell)-1,f(n.cell)],[u(n.cell)+1,f(n.cell)],[u(n.cell),f(n.cell)-1],[u(n.cell),f(n.cell)+1]],o=0;o<r.length;o++){var l=r[o];if(!mn(e,l)){for(var s=0;s<i.length;s++){if(mn(l,i[s]))break}s<i.length||(i.push(l),n.steps+1<t&&a.push({steps:n.steps+1,cell:l}))}}return i}function wn(e){return e.layout.size[0]}function bn(e){return e.layout.size[1]}function kn(e,t){return e.layout.data[f(t)*wn(e)+u(t)]}function xn(e,t){for(var a=0;a<e.units.length;a++){var i=e.units[a];if(mn(t,i.cell))return i}}function h(e,t){return 0<=u(t)&&u(t)<wn(e)&&0<=f(t)&&f(t)<bn(e)}function zn(e,t){var a={move:[t.cell],attack:[]},i=On(t),n=[{steps:0,cell:t.cell}];for(i||(n.length=0);n.length;)for(var r=n.shift(),o=yn(r.cell),l=0;l<o.length;l++){if(h(e,c=o[l])&&!kn(e,c).solid){for(var s=0;s<a.move.length&&!mn(c,a.move[s]);s++);if(!(s<a.move.length)){if((u=xn(e,c))||a.move.push(c),u&&!In(t,u)){for(s=0;s<a.attack.length&&!mn(a.attack[s],c);s++);s===a.attack.length&&a.attack.push(c)}r.steps<i-1&&(!u||In(t,u))&&n.push({steps:r.steps+1,cell:c})}}}for(l=0;l<a.move.length;l++)for(o=yn(a.move[l],t.equipment.weapon.rng),s=0;s<o.length;s++){var c,u;if(h(e,c=o[s])&&!kn(e,c).solid&&!mn(t.cell,c))if(!(u=xn(e,c))||!In(t,u)){for(var f=0;f<a.attack.length&&!mn(a.attack[f],c);f++);f===a.attack.length&&a.attack.push(c)}}return a}function In(e,t){return e.faction===t.faction||"player"===e.faction&&"ally"===t.faction||"ally"===e.faction&&"player"===t.faction}function O(e,t,a){e.cell=t}function Mn(e,t){var a=Sn(e,t);return a&&(t.hp-=Math.min(t.hp,a)),a}function Sn(e,t){var a,i,n,r;if((r=(n=e).equipment.weapon,n.stats.agi+(r?r.acc:0)-(i=(a=t).equipment.armor,a.stats.agi-(i?i.wt:0)))<0)return null;if("warrior"===e.type)switch(t.type){case"warrior":case"knight":return 2;case"rogue":return 0;case"mage":return 3}else if("knight"===e.type)switch(t.type){case"warrior":return 2;case"knight":return 1;case"rogue":case"mage":return 2}else if("rogue"===e.type)switch(t.type){case"warrior":return 2;case"knight":return 0;case"rogue":return 1;case"mage":return 2}else if("mage"===e.type)switch(t.type){case"warrior":return 2;case"knight":case"rogue":case"mage":return 1}}function H(e){return e.equipment.weapon.rng}function On(e){if("defend"===e.ai)return 0;var t=e.equipment.armor;return 5-(t?t.wt:0)+Math.floor(e.stats.agi/2)}var d={warrior:{str:2,int:0,agi:1},knight:{str:1,int:0,agi:0},rogue:{str:1,int:1,agi:2},mage:{str:1,int:1,agi:1}},v={axe:{target:"str",atk:2,acc:0,rng:1},lance:{target:"str",atk:3,acc:2,rng:1},dagger:{target:"str",atk:2,acc:1,rng:1},tome:{target:"int",atk:1,acc:1,rng:2}},m={warrior:{weapon:v.axe,armor:null},knight:{weapon:v.lance,armor:{def:2,wt:1}},rogue:{weapon:v.dagger,armor:null},mage:{weapon:v.tome,armor:null}};function qn(e,t){var a=e.phase.pending,i=a.indexOf(t);return-1!==i&&(a.splice(i,1),a.length||An(e),!0)}function An(e){var t=e.map,a=e.phase;a.faction="player"===a.faction?"enemy":"player",a.pending=t.units.filter(function(e){return e.faction===a.faction}),a.pending.length||An(e)}function Ln(e,t){return{options:e,index:t||0,done:!1}}function K(e,t){t?--e.index<0&&(e.index=e.options.length-1):++e.index>=e.options.length&&(e.index=0)}function Rn(e){return"rgba("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}function Cn(e,t,a){for(var i=[],n=[t],r={},o={},l={},s={},c={},u=0;u<e.length;u++){s[h=e[u]]=1/0,c[h]=1/0}for(s[t]=0,c[t]=vn(t,a);n.length;){var f={score:1/0,index:-1,cell:null};for(u=0;u<n.length;u++){(v=c[h=n[u]])<f.score&&(f.score=v,f.index=u,f.cell=h)}var h;if(mn(h=f.cell,a)){for(;!mn(h,t);)i.unshift(h),h=l[h];return i.unshift(h),i}n.splice(f.index,1),r[h]=!1,o[h]=!0;var g=yn(h);for(u=0;u<g.length;u++){var p=g[u];if(!o[p]){for(var d=0;d<e.length;d++){if(mn(e[d],p))break}var v;if(d!==e.length)r[p]||(r[p]=!0,n.push(p)),(v=s[h]+1)>=s[p]||(l[p]=h,s[p]=v,c[p]=v+vn(p,a))}}}}function y(){return{height:0,time:0,floating:!1}}y.update=function(e){if(!e.done){var t=e.data;if(t.time++,e.floating){var a=t.time%120/120;t.height=4+Math.sin(2*Math.PI*a)}else 4==++t.height&&(e.floating=!0)}};var w=Object.freeze({default:y});function b(e){return{height:Math.round(e||4)}}b.update=function(e){e.done||--e.data.height||(e.done=!0)};var x=Object.freeze({default:b});function z(e){return{path:e,cell:e[0].slice(),time:0}}z.update=function(e){if(e.done)return!1;var t=e.data,a=Math.floor(t.time/4),i=t.time%4*.25,n=t.path[a],r=t.path[a+1];return r?t.cell=[n[0]+(r[0]-n[0])*i,n[1]+(r[1]-n[1])*i]:(t.cell=n.slice(),e.done=!0),t.time++,!0};var I=Object.freeze({default:z});function M(e,t){var a=[t[0]-e[0],t[1]-e[1]],i=Math.sqrt(a[0]*a[0]+a[1]*a[1]);return{src:e,norm:[a[0]/i,a[1]/i],cell:e.slice(),time:0,connected:!1}}M.update=function(e){if(!e.done){var t=e.data,a=t.time<=7?t.time:7-(t.time-7);8<=t.time&&(t.connected=!0),t.cell[0]=t.src[0]+t.norm[0]/8*a,t.cell[1]=t.src[1]+t.norm[1]/8*a,15==++t.time&&(e.done=!0)}};var S=Object.freeze({default:M});function q(){return{time:0,flashing:!1}}q.update=function(e){if(!e.done){var t=e.data;t.flashing=!t.flashing,15==++t.time&&(e.done=!0)}};var A=Object.freeze({default:q});function L(){return{time:0,visible:!0}}L.update=function(e){if(!e.done){var t=e.data;t.visible=!t.visible,30==++t.time&&(e.done=!0)}};var R=Object.freeze({default:L});function C(){return{time:0,state:"enter",text:{x:0},bg:{x:0,width:0,height:0}}}C.update=function(e){if(!e.done){var t=e.data,a=t.time,i=t.text,n=t.bg;if(10<a&&a<=25){t.state="enter";var r=(a-10)/15,o=Math.sin(Math.PI/2*r);i.x=o}else if(25<a&&a<=40)t.state="pass",i.x=(a-25)/15;else if(40<a&&a<=55){t.state="exit";var l=(a-40)/15,s=1-Math.sin(Math.PI/2+Math.PI/2*l);i.x=s}if(a<=40){if(n.width<1)n.width+=1/16;else if(n.height<1){var c=(a-16)/8,u=Math.sin(Math.PI/2*c);n.height=u}}else 0<n.height?n.height-=1/8:n.x<1&&(n.x+=1/16);65==++t.time&&(e.done=!0)}};var T=Object.freeze({default:C}),Tn={lift:w&&y||w,drop:x&&b||x,move:I&&z||I,attack:S&&M||S,flinch:A&&q||A,fade:R&&L||R,phase:T&&C||T};function Dn(e,t,a){return{type:e,target:t,data:a,done:!1}}var En={warrior:"axe",knight:"shield",rogue:"dagger",mage:"hat"};function J(e,t){var a=e.context,i=e.sprites,n=e.cache,r=e.state,o=r.time,l=r.cursor,s=r.viewport,c=r.anims,u=r.attacks,f=r.dialogs,h=r.log,g=r.ai,p=t.map,d=a.canvas,v=c[0],m=u[0],y=f[0],w=["floors","squares","shadows","walls","pieces","arrows","cursor","selection","effects","ui"],b={},k=!0,x=!1,z=void 0;try{for(var I,M=w[Symbol.iterator]();!(k=(I=M.next()).done);k=!0){b[I.value]=[]}}catch(e){x=!0,z=e}finally{try{!k&&M.return&&M.return()}finally{if(x)throw z}}if(a.beginPath(),a.fillStyle="black",a.fillRect(0,0,d.width,d.height),n.units||(n.units=p.units.map(function(e){return Object.assign({original:e},e)})),n.map||(n.map=function(e,t){for(var a=wn(e),i=bn(e),n=pn(16*a,16*i),r=pn(16*a,16*i),o=0;o<i;o++)for(var l=0;l<a;l++){var s=16*l,c=16*o,u=kn(e,[l,o]),f=null;if("wall"===u.name)f=o+1<i&&"wall"!==kn(e,[l,o+1]).name?t["wall-base"]:t.wall,r.drawImage(f,s,c);else{var h=null;0<=l-1&&"wall"===kn(e,[l-1,o]).name&&0<=o-1&&"wall"!==kn(e,[l-1,o-1]).name?h=t["shadow-corner"]:0<=l-1&&"wall"===kn(e,[l-1,o]).name&&(h=t["shadow-edge"]),f=t[u.name],n.drawImage(f,s,c),h&&n.drawImage(h,s,c)}}return{floors:n.canvas,walls:r.canvas}}(p,i.tiles)),b.floors.push({image:n.map.floors,position:[0,0]}),b.walls.push({image:n.map.walls,position:[0,0]}),!l.cell){var S=p.units.find(function(e){return"player"===e.faction});l.cell=S.cell.slice(),l.prev=l.cell.slice()}if(!n.log){var O=i.ui.Box(s.size[0]-16,36),q={image:O,position:[8,s.size[1]]};n.log={row:0,col:0,focus:0,time:0,interrupt:!0,bookmark:0,box:q,texts:[],surface:pn(O.width-16,O.height-16)}}var A=p.units.filter(function(e){return"enemy"===e.faction}),L=g.strategy?g.allies[g.index]:null,R=y&&"actions"===y.type&&y,C=y&&"forecast"===y.type&&y,T=y&&"pause"===y.type&&y,D=!h.length||n.log.row===h.length-1&&n.log.col===h[h.length-1].length-1,E=(!D||!n.log.interrupt&&n.log.time<300)&&(m||!n.log.interrupt&&.001<!vn(l.cell,l.prev))&&!T;if(E){var j=n.log,B=j.box,N=j.surface;n.log.interrupt&&(n.log.interrupt=!1,n.log.time=0,B.image.getContext("2d").fillRect(8,8,B.image.width-16,B.image.height-16));var P=s.size[1]-B.image.height-8;if(B.position[1]+=(P-B.position[1])/8,Math.abs(P-B.position[1])<4){n.log.focus<n.log.row&&2<=n.log.row&&n.log.row<h.length&&(n.log.focus+=(n.log.row-n.log.focus)/8);var _=h[n.log.row].slice(0,n.log.col+1),U=i.ui.Text(_);n.log.texts[n.log.row]=U,N.canvas.height=Math.max(0,12*(h.length-n.log.bookmark)-4);n.log.row,n.log.bookmark;for(var F=n.log.bookmark;F<=n.log.row;F++){var G=n.log.texts[F];N.drawImage(G,0,12*(F-n.log.bookmark))}var K=pn(B.image.width-16,B.image.height-16),H=Math.max(0,12*(n.log.focus-n.log.bookmark-1));K.drawImage(n.log.surface.canvas,0,-Math.ceil(H));var J=B.image.getContext("2d");J.fillRect(8,8,B.image.width-16,B.image.height-16),J.drawImage(K.canvas,8,8),n.log.col!==h[n.log.row].length-1?n.log.col++:n.log.row!==h.length-1?(n.log.row++,n.log.col=0):n.log.time++}b.ui.push(B)}else{n.log.interrupt||(n.log.interrupt=!0,n.log.bookmark=n.log.row+1);var V=n.log.box,W=s.size[1]+V.image.height;V.position[1]<W&&(V.position[1]+=Math.min(8,W-V.position[1]),b.ui.push(V))}(c.length||m||!D)&&n.phase.pending||(n.phase.faction!==t.phase.faction&&(l.cell=t.phase.pending[0].cell.slice(),v=c[0]=Dn("phase",t.phase.faction,Tn.phase())),n.phase={pending:t.phase.pending.slice(),faction:t.phase.faction,done:!1});var Q=v&&"phase"===v.type,X=null;if(!Q||!s.target)if(m)X=m.target.cell;else if("enemy"===t.phase.faction&&L)X=L.cell;else if(C&&!n.moved){X=y.options[y.index].cell}else l.selection&&t.phase.pending.includes(l.selection.unit)&&!n.moved?l.selection&&t.phase.pending.includes(l.selection.unit)&&(X=l.selection.unit.cell):X=l.cell;s.target||(s.target=[]);var Y=16*wn(p);Y>s.size[0]?X&&(s.target[0]=16*X[0]+8-s.size[0]/2):s.target[0]=Y/2-s.size[0]/2;var Z=16*bn(p);if(Z>s.size[1]?X&&(s.target[1]=16*X[1]+8-s.size[1]/2):s.target[1]=Z/2-s.size[1]/2,!(!Q&&(C||m||"enemy"===n.phase.faction))){var $=Y-s.size[0];Y>s.size[0]&&(s.target[0]<0?s.target[0]=0:s.target[0]>$&&(s.target[0]=$));var ee=Z-s.size[1];Z>s.size[1]&&(s.target[1]<0?s.target[1]=0:s.target[1]>ee&&(s.target[1]=ee))}if(s.position){var te=[s.target[0]-s.position[0],s.target[1]-s.position[1]];s.velocity[0]+=(te[0]/16-s.velocity[0])/4,s.velocity[1]+=(te[1]/16-s.velocity[1])/4,s.position[0]+=s.velocity[0],s.position[1]+=s.velocity[1]}else s.position=s.target.slice();if(n.attack&&n.attack.connected&&1===n.attack.time&&(s.shake=30),s.shake){s.shake--;var ae=m.power,ie=1-s.shake%5/5,ne=m.attacker.cell[1]-m.target.cell[1]?1:0;s.offset[ne]=Math.sin(2*ie*Math.PI)*ae*s.shake/30}else s.offset[0]=0,s.offset[1]=0;var re=l.selection||n.selection;if(re&&"enemy"!==n.phase.faction){var oe=re.unit,le=re.time,se=p.units.indexOf(oe),ce=n.units[se],ue=n.ranges[se];ue||(ue=n.ranges[se]=zn(p,oe));var fe=n.squares[se];if(!fe){var he=!0,ge=!(n.squares[se]=fe=[]),pe=void 0;try{for(var de,ve=ue.move[Symbol.iterator]();!(he=(de=ve.next()).done);he=!0){var me=de.value;fe.push({sprite:i.ui.squares.move,cell:me})}}catch(e){ge=!0,pe=e}finally{try{!he&&ve.return&&ve.return()}finally{if(ge)throw pe}}var ye=!0,we=!1,be=void 0;try{for(var ke,xe=ue.attack[Symbol.iterator]();!(ye=(ke=xe.next()).done);ye=!0){var ze=ke.value,Ie=!0,Me=!0,Se=!1,Oe=void 0;try{for(var qe,Ae=ue.move[Symbol.iterator]();!(Me=(qe=Ae.next()).done);Me=!0){if(mn(ze,qe.value)){Ie=!1;break}}}catch(e){Se=!0,Oe=e}finally{try{!Me&&Ae.return&&Ae.return()}finally{if(Se)throw Oe}}Ie&&fe.push({sprite:i.ui.squares.attack,cell:ze})}}catch(e){we=!0,be=e}finally{try{!ye&&xe.return&&xe.return()}finally{if(we)throw be}}}l.selection&&n.selection!==l.selection&&(n.selection=re,n.path=null),l.selection&&!c.find(function(e){return e.target===ce})&&c.push(Dn("lift",ce,Tn.lift())),n.selection&&n.selection!==l.selection&&(n.moved=!1,v&&"lift"===v.type&&(v.done=!0,c.push(Dn("drop",v.target,Tn.drop(v.data.height))),n.selection.time=0));var Le=v&&"move"===v.type&&v.target===ce,Re=v&&"attack"===v.type&&v.target===ce;if(!n.moved){var Ce=0;if(l.selection)Ce=re.time;else{var Te=0,De=!0,Ee=!1,je=void 0;try{for(var Be,Ne=fe[Symbol.iterator]();!(De=(Be=Ne.next()).done);De=!0){var Pe=Be.value,_e=vn(oe.cell,Pe.cell);Te<_e&&(Te=_e)}}catch(e){Ee=!0,je=e}finally{try{!De&&Ne.return&&Ne.return()}finally{if(Ee)throw je}}Ce=Math.max(0,Te-re.time)}Ce&&(fe=fe.filter(function(e){return vn(oe.cell,e.cell)<=Ce}),function(e,t,a){var i=!0,n=!1,r=void 0;try{for(var o,l=a[Symbol.iterator]();!(i=(o=l.next()).done);i=!0){var s=o.value,c=s.sprite,u=16*s.cell[0],f=16*s.cell[1];e.squares.push({image:c,position:[u,f]})}}catch(e){n=!0,r=e}finally{try{!i&&l.return&&l.return()}finally{if(n)throw r}}}(b,i.ui.squares,fe))}var Ue=n.path,Fe=xn(p,l.cell);if(mn(l.cell,oe.cell))Ue&&(Ue.length=1);else if(t.phase.pending.includes(oe)&&l.selection){var Ge=ue.move.slice(),Ke=p.units.filter(function(e){return In(oe,e)}),He=!0,Je=!1,Ve=void 0;try{for(var We,Qe=Ke[Symbol.iterator]();!(He=(We=Qe.next()).done);He=!0){var Xe=We.value;Ge.push(Xe.cell)}}catch(e){Je=!0,Ve=e}finally{try{!He&&Qe.return&&Qe.return()}finally{if(Je)throw Ve}}var Ye=oe.cell;if(Ue&&Ue.length&&(Ye=Ue[Ue.length-1]),ue.move.find(function(e){return mn(l.cell,e)}))if(Ue){for(var Ze=0;Ze<Ue.length;Ze++){var $e=Ue[Ze];if(mn(l.cell,$e))break}if(Ze<Ue.length-1)Ue.splice(Ze+1,Ue.length-Ze-1);else{var et,tt=Cn(Ge.filter(function(t){return!Ue.find(function(e){return mn(t,e)})}),Ue[Ue.length-1],l.cell);if(tt&&Ue.length+tt.length-2<=On(oe))tt.shift(),(et=Ue).push.apply(et,_toConsumableArray(tt));else Ue=n.path=Cn(Ge,oe.cell,l.cell)}}else Ue=n.path=Cn(Ge,oe.cell,l.cell);else if(Fe&&!In(oe,Fe)&&vn(Ye,Fe.cell)>oe.equipment.weapon.rng){var at=yn(Fe.cell,oe.equipment.weapon.rng);if(Ue){var it=function(){var t=Ue[Ze];if(Fe&&at.find(function(e){return mn(t,e)}))return Ue.splice(Ze+1,Ue.length-Ze-1),"break"};for(Ze=Ue.length;Ze--;){if("break"===it())break}}if(!Ue||-1===Ze){for(var nt=null,rt=function(e){var t=ue.move[e];if(at.find(function(e){return mn(t,e)}))return nt=t,"break"},ot=0;ot<ue.move.length;ot++){if("break"===rt(ot))break}Ue=n.path=Cn(Ge,oe.cell,nt)}}}if(Ue&&(l.selection&&!n.moved||Le&&le%2)){var lt,st=i.ui.Arrow(Ue,n.phase.faction);(lt=b.arrows).push.apply(lt,_toConsumableArray(st.map(function(e){return{image:e.image,position:[16*e.position[0],16*e.position[1]]}})))}if(n.moved&&!Le&&!Re&&!f.length){var ct=null,ut=yn(ce.cell,ce.equipment.weapon.rng),ft=[],ht=!0,gt=!1,pt=void 0;try{for(var dt,vt=ut[Symbol.iterator]();!(ht=(dt=vt.next()).done);ht=!0){var mt=xn(p,dt.value);mt&&!In(oe,mt)&&ft.push(mt)}}catch(e){gt=!0,pt=e}finally{try{!ht&&vt.return&&vt.return()}finally{if(gt)throw pt}}if(ct=(n.enemies=ft).length?["attack","wait"]:["wait"],f.push({type:"actions",menu:Ln(ct)}),n.target){var yt=n.target.unit,wt=ft.indexOf(yt);f.unshift({type:"forecast",menu:Ln(ft,wt)}),l.cell=yt.cell.slice(),l.prev=yt.cell.slice()}}}if(e.state.paused)if(f.length){var bt=T.menu;if(bt.done)"end turn"===bt.options[bt.index]&&An(t),e.state.paused=!1,f.shift()}else f.push({type:"pause",menu:Ln(["end turn"])});var kt=16*l.cell[1]+8-s.target[1]>=s.size[1]/2,xt=l.selection||m&&n.selected||l.under,zt=n.dialogs.selection;if(!xt||n.selected&&xt!==n.selected||Q||T||C&&zt&&8===zt.name.position[1]||zt&&!C&&!m&&(kt&&!C&&zt&&8!==zt.name.position[1]||!kt&&zt&&8===zt.name.position[1])){if(n.selected){n.selected.unit;var It=n.dialogs.selection;if(It){var Mt=It.name,St=It.hp;Mt.position[0]>-Mt.image.width||St.position[0]>-St.image.width?(Mt.position[0]-=16,St.position[0]-=16):(n.dialogs.selection=null,n.selected=null),b.ui.push(Mt,St)}}}else{n.selected||(n.selected=xt);var Ot=xt.unit,qt=t.map.units.indexOf(Ot),At=n.units[qt];if(!n.dialogs.selection){var Lt=s.size[1]-68;kt&&!C&&(Lt=0);var Rt=i.ui.UnitDetails(At);n.dialogs.selection={name:{image:Rt.name,position:[-Rt.name.width,Lt+8]},hp:{image:Rt.hp,position:[-Rt.hp.width,Lt+36]}}}var Ct=n.dialogs.selection,Tt=Ct.name,Dt=Ct.hp,Et=0,jt=0;m||E?Et=(jt=s.size[1]-4-36-4-Dt.image.height-4)-4-Tt.image.height:kt&&!C||(Et=(jt=s.size[1]-4-Dt.image.height-4)-4-Tt.image.height),(m||!kt||C)&&(Tt.position[1]+=(Et-Tt.position[1])/8,Dt.position[1]+=(jt-Dt.position[1])/8),xt&&(12<=xt.time&&(Tt.position[0]+=(8-Tt.position[0])/8),16<=xt.time&&(Dt.position[0]+=(8-Dt.position[0])/8)),b.ui.push(Tt,Dt)}var Bt=null,Nt=n.dialogs.target;if(C){var Pt=C.menu;Bt=Pt.options[Pt.index],Bt=n.target?n.target.unit!==Bt?{unit:Bt,time:0}:n.target:n.target={unit:Bt,time:0},l.cell=Bt.unit.cell.slice()}else m?Bt=n.target:l.selection&&"enemy"!==n.phase.faction&&l.under&&l.selection!==l.under&&!In(l.selection.unit,l.under.unit)&&(Bt=l.under);if(!Bt||n.target&&Bt!==n.target||R||Q||C&&Nt&&8===Nt.name.position[1]){if(n.target){n.target.unit;var _t=n.dialogs.target;if(_t){var Ut=_t.name,Ft=_t.hp;Ut.position[0]<s.size[0]||Ft.position[0]<s.size[0]?(Ut.position[0]+=16,Ft.position[0]+=16):(n.dialogs.target=null,n.target=null),b.ui.push(Ut,Ft)}}}else{n.target||(n.target=Bt);var Gt=Bt.unit;if(!n.dialogs.target){var Kt=s.size[1]-68;kt&&!C&&(Kt=0);var Ht=i.ui.UnitDetails(Gt);n.dialogs.target={name:{image:Ht.name,position:[s.size[0],Kt+8]},hp:{image:Ht.hp,position:[s.size[0],Kt+36]}}}var Jt=n.dialogs.target,Vt=Jt.name,Wt=Jt.hp,Qt=0,Xt=0;if(m||E?Qt=(Xt=s.size[1]-8-36-4-Wt.image.height)-4-Vt.image.height:kt&&!C||(Qt=(Xt=s.size[1]-8-Wt.image.height)-4-Vt.image.height),(m||!kt||C)&&(Vt.position[1]+=(Qt-Vt.position[1])/8,Wt.position[1]+=(Xt-Wt.position[1])/8),Bt){if(12<=Bt.time){var Yt=s.size[0]-8-Vt.image.width;Vt.position[0]+=(Yt-Vt.position[0])/8}if(16<=Bt.time){var Zt=s.size[0]-8-Wt.image.width;Wt.position[0]+=(Zt-Wt.position[0])/8}}b.ui.push(Vt,Wt)}if(m&&!Q){var $t=m.attacker,ea=m.target,ta=m.power,aa=m.damage,ia=p.units.indexOf($t),na=n.units[ia];if(n.attack){if(n.attack.countdown&&!--n.attack.countdown){var ra=Dn("attack",na,Tn.attack($t.cell,ea.cell));c.push(ra),n.attack.normal=ra.data.norm}}else{if(n.attack={countdown:7,time:0,connected:!1,normal:null},"player"===n.phase.faction&&"player"===$t.faction){var oa=Dn("drop",na,Tn.drop());c.push(oa)}m.counter?h.push($t.name+" counters -"):h.push($t.name+" attacks")}if(v&&"attack"===v.type&&v.data.connected&&!n.attack.connected)if(n.attack.connected=!0,null===ta){var la="player"===ea.faction?".":"!";h.push(ea.name+" dodges the attack"+la)}else if(0===ta){var sa="player"===ea.faction?".":"!";h.push(ea.name+" blocks the attack"+sa)}else{var ca=3===aa?"!!":".";h.push(ea.name+" suffers "+aa+" damage"+ca)}if(n.attack&&n.attack.connected){var ua=n.attack.time;if(45<=ua&&!ea.hp&&p.units.includes(ea)){var fa=p.units.indexOf(ea);p.units.splice(fa,1),"player"===ea.faction?h.push(ea.name+" is defeated."):"enemy"===ea.faction&&h.push("Defeated "+ea.name+".")}var ha=m.counter?n.dialogs.selection:n.dialogs.target;if(ha){var ga=ha.hp.image.getContext("2d"),pa=0;2*ua<=14*aa?(pa=Math.min(14*aa,2*ua),ga.fillStyle=Rn(dn.red)):(pa=ua-14*aa,ga.fillStyle="black"),0<pa&&pa<=14*aa&&ga.fillRect(31+14*(ea.hp+aa)-pa,11,pa,2)}if(60<=ua&&ea.hp||75<=ua){if(u.shift(),n.attack=null,ea.hp){var da=t.map.units.indexOf(ea);n.units[da].hp=ea.hp}m.counter||"player"!==n.phase.faction||(qn(t,$t),l.cell=$t.cell.slice(),l.prev=$t.cell.slice())}else{if(1===ua&&null!==ta)for(var va=[ea.cell[0]-$t.cell[0],ea.cell[1]-$t.cell[1]],ma=Math.sqrt(va[0]*va[0]+va[1]*va[1]),ya=[va[0]/ma,va[1]/ma],wa=Math.atan2(va[1],va[0]),ba=[16*ea.cell[0]+8-4*ya[0],16*ea.cell[1]+8-4*ya[1]],ka=(aa+1)/2*48,xa=0;xa<ka;xa++){var za="small";Math.random()<.25&&(za="large");var Ia=i.effects[za],Ma=wa+1*Math.random()-.5,Sa=[-Math.cos(Ma)*Math.random()*2,-Math.sin(Ma)*Math.random()*2];n.particles.push({position:ba.slice(),velocity:Sa,image:Ia,time:0})}if(ua<=45){var Oa=n.attack.value;if(Oa){Oa.offset+=Oa.velocity,Oa.velocity+=.25;0<Oa.offset&&(Oa.offset=0,Oa.velocity*=-1/3)}else{var qa=dn.gray,Aa=null;3===ta?Aa="3!":0===ta?Aa="0":null===ta?Aa="MISS":(Aa=ta.toString(),qa=dn.red);var La=[],Ra=i.ui.Text(Aa);if(3===ta){var Ca=i.ui.Text(Aa,dn.red),Ta=pn(8*Aa.length+1,9);Ta.drawImage(Ca,1,1),Ta.drawImage(Ra,0,0);var Da=pn(8*Aa.length+1,9);Da.drawImage(Ra,1,1),Da.drawImage(Ca,0,0),La.push(Ta.canvas,Ta.canvas,Da.canvas,Da.canvas)}else{var Ea=i.ui.Text(Aa,qa),ja=pn(8*Aa.length+1,9);ja.drawImage(Ea,1,1),ja.drawImage(Ra,0,0),La.push(ja.canvas)}Oa=n.attack.value={offset:0,velocity:-2,images:La}}var Ba=ua%Oa.images.length,Na=Oa.images[Ba];b.effects.push({image:Na,position:[16*ea.cell[0]+8-Na.width/2,16*ea.cell[1]-12+Oa.offset]})}}}}for(var Pa=n.particles,_a=0;_a<Pa.length;_a++){var Ua=Pa[_a];Ua.time++,Ua.position[0]+=Ua.velocity[0],Ua.position[1]+=Ua.velocity[1],Ua.velocity[0]*=.875,Ua.velocity[1]*=.875;var Fa=Math.random();b.effects.push(Ua),Fa<Ua.time/240&&Pa.splice(_a--,1)}if(R){var Ga=R.menu;if(Ga.done){var Ka=Ga.options[Ga.index];if("wait"===Ka){var Ha=l.selection.unit,Ja=p.units.indexOf(Ha),Va=n.units[Ja];Ha.cell=Va.cell,l.selection=null,n.selection=null,n.squares.length=0,n.ranges.length=0,n.moved=!1,v.done=!0,c.push(Dn("drop",v.target,Tn.drop(v.data.height))),qn(t,Ha),l.cell=Ha.cell.slice(),l.prev=Ha.cell.slice(),f.shift()}else"attack"===Ka&&f.unshift({type:"forecast",menu:Ln(n.enemies)})}}var Wa=e.state.menu;if(T||R||C&&1<C.menu.options.length){var Qa=null;T?Qa=T.menu:C?Qa=C.menu:R&&(Qa=R.menu),Wa||(Wa=e.state.menu={data:Qa,box:{size:[0,0],targetSize:null,element:{image:null,position:[144,48]}},cursor:null});var Xa=Wa.box;if(Wa.data!==Qa||!Xa.targetSize){n.menu.labels.length=0,Wa.cursor=null;var Ya=(Wa.data=Qa).options;C&&(Ya=Ya.map(function(e){return e.name}));var Za=null,$a=!0,ei=!1,ti=void 0;try{for(var ai,ii=Ya[Symbol.iterator]();!($a=(ai=ii.next()).done);$a=!0){var ni=ai.value,ri=C?ni:ni.toUpperCase(),oi=i.ui.Text(ri);(!Za||oi.width>Za.width)&&(Za=oi),n.menu.labels.push(oi)}}catch(e){ei=!0,ti=e}finally{try{!$a&&ii.return&&ii.return()}finally{if(ei)throw ti}}Xa.size=[0,0],Xa.targetSize=[Za.width+36,16*Wa.data.options.length+16]}Xa.size[0]+=(Xa.targetSize[0]-Xa.size[0])/4,Xa.size[1]+=(Xa.targetSize[1]-Xa.size[1])/4}else if(Wa){var li=Wa.box;li.size[0]&&(li.size[0]-=Math.min(li.size[0],li.targetSize[0]/5),li.size[1]-=Math.min(li.size[1],li.targetSize[1]/5))}if(Wa){var si=Wa.box;if(si.size[0]&&si.size[1]){var ci,ui=si.targetSize[0]-si.size[0];if(si.element.image=(ci=i.ui).Box.apply(ci,_toConsumableArray(si.size.map(Math.round))),n.menu.box=si.element.image,ui<4){for(var fi=si.element.image.getContext("2d"),hi=0;hi<n.menu.labels.length;hi++){var gi=n.menu.labels[hi];fi.drawImage(gi,24,12+16*hi)}var pi=null,di=Wa.data.options[Wa.data.index];if("attack"===di?pi=i.ui.symbols.sword:"wait"===di?pi=i.ui.symbols.clock:"end turn"===di?pi=i.ui.symbols.next:C&&(pi=i.ui.symbols.sword),pi){var vi=o%180/180,mi=Math.sin(2*Math.PI*vi*2),yi=12+16*Wa.data.index-mi;null===Wa.cursor?Wa.cursor=yi:Wa.cursor+=(yi-Wa.cursor)/2,fi.drawImage(pi,12,Wa.cursor)}}b.ui.push(si.element)}}if(C){var wi=C.menu,bi=wi.options[wi.index];if(!n.dialogs.forecast){var ki=i.ui.Text("COMBAT FORECAST"),xi=i.ui.Box(ki.width+28,24),zi=xi.getContext("2d"),Ii=i.ui.symbols.eye;zi.drawImage(Ii,8,8),zi.drawImage(ki,20,8),n.dialogs.forecast={title:{image:xi,position:[-xi.width,8]}}}var Mi=n.dialogs.forecast.title;Mi.position[0]+=(8-Mi.position[0])/8,b.ui.push(Mi);var Si=l.selection.unit,Oi=p.units.indexOf(Si),qi=e.cache.units[Oi],Ai=yn(qi.cell,Si.equipment.weapon.rng),Li=!0,Ri=!1,Ci=void 0;try{for(var Ti,Di=Ai[Symbol.iterator]();!(Li=(Ti=Di.next()).done);Li=!0){var Ei=Ti.value;b.squares.push({image:i.ui.squares.attack,position:[16*Ei[0],16*Ei[1]]})}}catch(e){Ri=!0,Ci=e}finally{try{!Li&&Di.return&&Di.return()}finally{if(Ri)throw Ci}}void 0===y.time?y.time=0:y.time++;var ji=Math.floor(14),Bi=255*Math.sin(y.time%60/60*Math.PI),Ni=vn(qi.cell,bi.cell),Pi=!1,_i=n.dialogs.target;if(_i){var Ui=Math.min(bi.hp,Ni<=Si.equipment.weapon.rng?Number(Sn(Si,bi)):0);if(Ui){bi.hp-Ui<=0&&(Pi=!0);var Fi=pn(Ui*ji,2);Fi.fillStyle="rgb("+Bi+", "+Bi+", "+Bi+")",Fi.fillRect(0,0,Fi.canvas.width,Fi.canvas.height),b.ui.push({image:Fi.canvas,position:[_i.hp.position[0]+31+(bi.hp-Ui)*ji,_i.hp.position[1]+11]})}}if(!Pi){var Gi=n.dialogs.selection;if(Gi){var Ki=Math.min(Si.hp,Ni<=bi.equipment.weapon.rng?Number(Sn(bi,Si)):0);if(Ki){var Hi=pn(Ki*ji,2);Hi.fillStyle="rgb("+Bi+", "+Bi+", "+Bi+")",Hi.fillRect(0,0,Hi.canvas.width,Hi.canvas.height),b.ui.push({image:Hi.canvas,position:[Gi.hp.position[0]+31+(Si.hp-Ki)*ji,Gi.hp.position[1]+11]})}}}if(wi.done){Si.cell=qi.cell;var Ji=Sn(Si,bi),Vi=Math.min(bi.hp,Number(Ji));if(Mn(Si,bi),u.push({attacker:Si,target:bi,power:Ji,damage:Vi}),!Pi&&Ni<=bi.equipment.weapon.rng){var Wi=Sn(bi,Si),Qi=Math.min(Si.hp,Number(Wi));Mn(bi,Si),u.push({attacker:bi,target:Si,power:Wi,damage:Qi,counter:!0})}n.squares.length=0,n.ranges.length=0,n.moved=!1,l.selection=null,n.selection=null,f.length=0,v.done=!0}}else{var Xi=n.dialogs.forecast;if(Xi){var Yi=Xi.title;Yi.position[0]>-Yi.image.width?(Yi.position[0]-=Math.max(16,-Yi.image.width-Yi.position[0]),b.ui.push(Yi)):n.dialogs.forecast=null}}var Zi=n.dialogs.objective;if(!Zi){var $i=i.ui.TextBox("OBJECTIVE"),en=i.ui.TextBox("Defeat Nergal");Zi=n.dialogs.objective={lastUpdate:null,time:0,title:{image:$i,position:[s.size[0],s.size[1]-$i.height-36]},body:{image:en,position:[s.size[0],s.size[1]-en.height-8]}}}p.units.length!==Zi.lastUpdate&&(Zi.body.image=i.ui.TextBox("Defeat Nergal"),Zi.lastUpdate=A.length);var tn=Zi,an=tn.title,nn=tn.body;l.selection||l.under||n.attack||T||!(vn(l.cell,l.prev)<.001)||kt!==(8===an.position[1])&&(an.position[0]!==s.size[0]||nn.position[0]!==s.size[0])?Zi.time=0:Zi.time||(Zi.time=1);if(Zi.time&&(an.position[0]===s.size[0]&&(kt?(an.position[1]=8,nn.position[1]=36):(an.position[1]=s.size[1]-an.image.height-36,nn.position[1]=s.size[1]-nn.image.height-8)),150<=++Zi.time&&(an.position[0]+=(s.size[0]-an.image.width-8-an.position[0])/8),154<=Zi.time&&(nn.position[0]+=(s.size[0]-nn.image.width-8-nn.position[0])/8)),Zi.time<150&&(an.position[0]<s.size[0]||nn.position[0]<s.size[0])&&(an.position[0]+=Math.min(16,s.size[0]-an.position[0]),nn.position[0]+=Math.min(16,s.size[0]-nn.position[0]),Zi.time=0),b.ui.push(an,nn),Q){var rn=0,on=v.data,ln=i.ui.phases[v.target];if("enter"===on.state){var sn=-ln.width,cn=s.size[0]/2-ln.width/2-3;rn=on.text.x*(cn-sn)+sn}else if("pass"===on.state){var un=s.size[0]/2-ln.width/2-3;rn=6*on.text.x+un}else if("exit"===on.state){var fn=s.size[0]/2-ln.width/2+3,hn=s.size[0];rn=on.text.x*(hn-fn)+fn}var gn=pn(256*(on.bg.width-on.bg.x),2+10*on.bg.height);gn.fillStyle="player"===v.target?Rn(dn.blue):Rn(dn.red),gn.fillRect(0,0,gn.canvas.width,gn.canvas.height),gn.canvas.width&&b.ui.push({image:gn.canvas,position:[256*on.bg.x,s.size[1]/2-gn.canvas.height/2]}),b.ui.push({image:ln,position:[rn,s.size[1]/2-ln.height/2]})}n.attack&&3===m.power&&1===n.attack.time?(a.fillStyle="white",a.fillRect(0,0,a.canvas.width,a.canvas.height)):("player"!==n.phase.faction||m||T||Q||(R||n.moved)&&!C||function(e,t,a,i){var n=i.state.time,r=(i.cache,a.cell[0]-a.prev[0]),o=a.cell[1]-a.prev[1],l=Math.abs(r)+Math.abs(o);a.prev[0]+=r/4,a.prev[1]+=o/4;var s=0;a.selection&&!i.state.dialogs.length?s=1:l<.001&&(s=Math.floor(n/30)%2);var c=16*a.prev[0],u=16*a.prev[1],f=t[i.cache.phase.faction][s];e.cursor.push({image:f,position:[c,u]})}(b,i.ui.cursor,l,e),function(e,t,a,i){for(var n=a.map,r=(a.phase,i.cache),o=i.state.attacks,l=i.state.anims,s=l[0],c=0;c<r.units.length;c++){var u=r.units[c],f=u.original,h=u.cell,g=16*h[0],p=16*h[1],d=0,v=t[u.faction][En[u.type]];if("player"!==u.faction||"player"!==r.phase.faction||!r.phase.pending||r.phase.pending.includes(f)||o.length&&o[0].target===f||s&&s.target===u&&("move"===s.type||"attack"===s.type)||(v=t.done[u.faction][En[u.type]]),n.units[c]===f?mn(u.cell,f.cell)||r.moved||(s&&(s.done=!0),s=l[0]=Dn("move",u,Tn.move(r.path)),r.moved=!0):l.length||(s&&(s.done=!0),s=l[0]=Dn("fade",u,Tn.fade())),s&&s.target===u){if("lift"===s.type||"drop"===s.type)d=s.data.height;else if("move"===s.type||"attack"===s.type)g=16*s.data.cell[0],p=16*s.data.cell[1];else if("fade"===s.type){if(s.done){r.units.splice(c--,1);continue}if(!s.data.visible)continue}e.selection.push({image:v,position:[g,p-d]})}else{var m=o[0];if(r.attack&&!r.attack.countdown&&m.target===f){var y=r.attack,w=y.connected,b=y.time,k=y.normal;if(w&&(m.damage&&b<45&&b%2&&(v=t.flashing),b<20&&m.power&&("knight"!==u.type||m.damage===u.hp))){var x=b;10<b&&(x=20-b),g+=k[0]*x/2*m.power/2,p+=k[1]*x/2*m.power/2}e.selection.unshift({image:v,position:[g,p]})}(!r.attack||r.attack.countdown||m&&m.target!==f)&&e.pieces.push({image:v,position:[g,p]})}e.shadows.push({image:t.shadow,position:[g+1,p+4]})}}(b,i.pieces,t,e),function(e,t,a,i){var n=!0,r=!1,o=void 0;try{for(var l,s=t[Symbol.iterator]();!(n=(l=s.next()).done);n=!0){var c=l.value,u=e[c];"ui"!==c&&u.sort(function(e,t){return e.position[1]-t.position[1]});var f=!0,h=!1,g=void 0;try{for(var p,d=u[Symbol.iterator]();!(f=(p=d.next()).done);f=!0){var v=p.value,m=Math.round(v.position[0]),y=Math.round(v.position[1]-(v.position[2]||0));"ui"!==c&&(m-=a.position[0]+a.offset[0],y-=a.position[1]+a.offset[1]),i.drawImage(v.image,m,y)}}catch(e){h=!0,g=e}finally{try{!f&&d.return&&d.return()}finally{if(h)throw g}}}}catch(e){r=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw o}}}(b,w,s,a))}var D=15,E=3;function V(t,e,a,i){var n=e.held,r=e.prev,o=a.map,l=a.phase;if(n.confirm&&!r.confirm)if(t.selection){var s=t.selection.unit;if(l.pending.includes(s)&&"player"===l.faction){var c=o.units.indexOf(s),u=i.cache.units[c],f=i.cache.ranges[c];if(f){var h=i.cache.path;if(h&&1<h.length){var g=h[h.length-1].slice(),p=xn(o,t.cell);f.move.find(function(e){return mn(e,t.cell)})?O(u,g):p&&f.attack.find(function(e){return mn(e,t.cell)})&&(O(u,g),i.cache.target||(i.cache.target={unit:p,time:0}))}else i.cache.moved=!0}}else W(t)}else t.under&&(t.selection=t.under,t.selection.time=0);if(n.mod&&t.selection&&l.pending.includes(t.selection.unit)){var d=t.selection.unit,v=o.units.indexOf(d),m=i.cache.ranges[v];if(!n.left||r.left||n.right){if(n.right&&!r.right&&!n.left){for(w=t.cell[0];w<o.layout.size[0];w++){for(b=0;b<m.move.length;b++){var y=m.move[b];if(y[0]===w+1&&y[1]===t.cell[1])break}if(b===m.move.length)break}t.cell[0]=w}}else{for(var w=t.cell[0];0<=w;w--){for(var b=0;b<m.move.length;b++){var k=m.move[b];if(k[0]===w-1&&k[1]===t.cell[1])break}if(b===m.move.length)break}t.cell[0]=w}if(!n.up||r.up||n.down){if(n.down&&!r.down&&!n.up){for(z=t.cell[1];z<o.layout.size[1];z++){for(b=0;b<m.move.length;b++){var x=m.move[b];if(x[1]===z+1&&x[0]===t.cell[0])break}if(b===m.move.length)break}t.cell[1]=z}}else{for(var z=t.cell[1];0<=z;z--){for(var b=0;b<m.move.length;b++){var I=m.move[b];if(I[1]===z-1&&I[0]===t.cell[0])break}if(b===m.move.length)break}t.cell[1]=z}}else(n.left&&!r.left||n.left>D&&!(n.left%E))&&!n.right?j(t,"left",o):(n.right&&!r.right||n.right>D&&!(n.right%E))&&!n.left&&j(t,"right",o),(n.up&&!r.up||n.up>D&&!(n.up%E))&&!n.down?j(t,"up",o):(n.down&&!r.down||n.down>D&&!(n.down%E))&&!n.up&&j(t,"down",o);var M=xn(o,t.cell);if(M?t.under&&M===t.under.unit?t.under.time++:!t.under&&i.cache.selected&&i.cache.selected.unit===M?t.under=i.cache.selected:t.under={unit:M,time:0}:t.under=null,!t.selection&&n.select&&!r.select){var S=n.mod;!function(e,t,a){var i=t.map,n=t.phase,r=xn(i,e.cell);if(!r)return(r=n.pending.find(function(e){return e.faction===n.faction}))&&(e.cell=r.cell.slice());var o=null,l=i.units.filter(function(e){return e.faction===r.faction}),s=r.faction===n.faction?n.pending:l,c=s.indexOf(r);if(s===n.pending&&-1===c){if(c=l.indexOf(r),a){for(var u=c-1;0<=u;u--){var f=l[u];if(n.pending.includes(f))break}if(-1===u)for(var u=l.length-1;c<u;u--){var h=l[u];if(n.pending.includes(h))break}}else{for(var u=c+1;u<l.length;u++){var g=l[u];if(n.pending.includes(g))break}if(u===l.length)for(var u=0;u<c;u++){var p=l[u];if(n.pending.includes(p))break}}o=l[c=u]}else o=a?0<=c-1?s[c-1]:s[s.length-1]:c+1<s.length?s[c+1]:s[0];o&&(e.cell=o.cell.slice())}(t,a,S)}}function W(e){e.selection=null}function j(e,t,a){var i=a.layout.size;"left"===t?--e.cell[0]<0&&(e.cell[0]=0):"right"===t?++e.cell[0]>=i[0]&&(e.cell[0]=i[0]-1):"up"===t?--e.cell[1]<0&&(e.cell[1]=0):"down"===t&&++e.cell[1]>=i[1]&&(e.cell[1]=i[1]-1)}var B,N={left:["KeyA","ArrowLeft"],up:["KeyW","ArrowUp"],right:["KeyD","ArrowRight"],down:["KeyS","ArrowDown"],confirm:["Space"],cancel:["Escape"],select:["Tab"],mod:["ShiftLeft"]};function Q(a,e){(e=e.slice()).sort(function(e,t){return e.hp-t.hp});for(var t=1/0,i=0;i<e.length;i++){var n=e[i];if(!(n.hp<=t)){e=e.slice(0,i+1);break}t=n.hp}return e.sort(function(e,t){return Sn(a,t)-Sn(a,e)}),e[0]}(B="sprites.png",new Promise(function(e,t){var a=new Image;a.src=B,a.onload=function(){e(a)},a.onerror=function(){t(new Error("Failed to load image `"+B+"`"))}})).then(function(e){var G=(a=256,i=240,n=o(e),r=document.createElement("canvas"),r.width=a,r.height=i,{sprites:n,context:r.getContext("2d"),state:{time:0,anims:[Dn("phase","player",Tn.phase())],cursor:{cell:null,prev:null,selection:null,under:null},viewport:{size:[a,i],position:null,target:null,velocity:[0,0],offset:[0,0],shake:0},ai:{strategy:null,index:0,action:0,moved:!1,attacked:!1},menu:null,paused:!1,attacks:[],dialogs:[],log:[]},cache:{map:null,selection:null,selected:null,target:null,moved:!1,attack:null,phase:{faction:"player",pending:null,done:!1},units:null,ranges:[],squares:[],particles:[],log:null,menu:{box:null,labels:[]},dialogs:{objective:null,selection:null,target:null}}}),t=G.context.canvas;var a,i,n,r;document.querySelector("main").appendChild(t),function e(){J(G,X);!function(e){var t=e.cache,a=e.state;a.time++;var i=a.cursor;i.selection?i.selection.time++:t.selection&&t.selection.time++,t.target&&t.target.time++,t.attack&&t.attack.connected&&t.attack.time++;var n=e.state.anims,r=n[0];r&&(r.done?n.shift():Tn[r.type].update(r))}(G);var t=Y.held,a=Y.prev;var i=G.state.cursor;var n=G.state.anims;var r=G.state.dialogs;var o=r[0];o?(l=o.menu,c=(s=Y).held,u=s.prev,c.confirm&&!u.confirm&&(l.done=!0),l.done||(c.select&&!u.select?K(l,c.mod):!c.up||u.up||c.down?!c.down||u.down||c.up||K(l):K(l,!0))):"player"!==X.phase.faction||G.state.attacks.length||G.cache.moved||n.length&&"phase"===n[0].type||V(i,Y,X,G);var l,s,c,u;var f=G.state.ai;if("enemy"!==G.cache.phase.faction||G.cache.phase.done)f.strategy=null;else if(f.strategy){var h=f.strategy[f.index],g=f.allies[f.index],p=X.map.units.indexOf(g),d=G.cache.units[p],v=h&&h[f.action];if(v){var m=_slicedToArray(v,2),y=m[0],w=m[1],b=G.state.viewport,k=vn(b.position,b.target),x=k<96;if("move"===y){if(!n.length)if(f.moved)f.action++,G.cache.moved=!1,d.cell=w.slice();else if(x){f.moved=!0;var z=zn(X.map,g),I=z.move.slice(),M=!0,S=!1,O=void 0;try{for(var q,A=f.allies[Symbol.iterator]();!(M=(q=A.next()).done);M=!0){var L=q.value;I.push(L.cell)}}catch(e){S=!0,O=e}finally{try{!M&&A.return&&A.return()}finally{if(S)throw O}}var R=Cn(I,g.cell,w);G.cache.path=R,G.cache.moved=!1,g.cell=w.slice()}}else if("attack"===y){var C=Sn(g,w),T=Math.min(w.hp,Number(C));if(!G.state.attacks.length)if(f.attacked)f.action++,i.selection=null,i.under=null;else if(x){if(f.attacked=!0,Mn(g,w),G.cache.target={unit:w,time:0},G.state.attacks.push({attacker:g,target:w,power:C,damage:T}),w.hp&&vn(w.cell,g.cell)<=H(w)){var D=Sn(w,g),E=Math.min(g.hp,Number(D));Mn(w,g),G.state.attacks.push({attacker:w,target:g,power:D,damage:E,counter:!0})}i.selection={unit:g,time:0},i.under=g}}}else if(f.moved=!1,f.attacked=!1,f.index++,f.action=0,g&&qn(X,g),f.index===f.strategy.length){f.index=0,f.strategy=null,G.cache.phase.done=!0;var j=X.map.units.find(function(e){return"player"===e.faction});j&&(i.cell=j.cell.slice(),i.prev=j.cell.slice(),i.selection=null,i.under=null)}}else{var B=X.map.units.filter(function(e){return"enemy"===e.faction}),N=X.map.units.filter(function(e){return"player"===e.faction});N.length&&(f.strategy=function(U,t){for(var F=[],G={tiles:U.tiles,layout:U.layout,units:U.units.map(function(e){return Object.assign({},e)})},K=[],e=_slicedToArray(U.layout.size,2),a=e[0],i=e[1],n=0;n<i;n++)for(var r=0;r<a;r++){var o=n*a+r;U.layout.data[o].solid||K.push([r,n])}var l=G.units.filter(function(e){return e.faction===t}),s=function(t){var e=[];F.push(e);var a=[];if("defend"===t.ai){var i=yn(t.cell,H(t)),n=!0,r=!1,o=void 0;try{for(var l,s=i[Symbol.iterator]();!(n=(l=s.next()).done);n=!0){var c=l.value,u=xn(G,c);u&&u.hp&&!In(t,u)&&a.push(u)}}catch(e){r=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw o}}if(a.length){var f=Q(t,a);e.push(["attack",U.units[G.units.indexOf(f)]]),Mn(t,f)}}else if("wait"===t.ai){var h=zn(G,t),g=!0,p=!1,d=void 0;try{for(var v,m=h.attack[Symbol.iterator]();!(g=(v=m.next()).done);g=!0){var y=v.value,w=xn(G,y);w&&w.hp&&!In(t,w)&&a.push(w)}}catch(e){p=!0,d=e}finally{try{!g&&m.return&&m.return()}finally{if(p)throw d}}if(a.length){var b=Q(t,a),k=yn(b.cell,H(t)).filter(function(t){return h.move.find(function(e){return mn(e,t)})&&!xn(G,t)});if(k.length){k.sort(function(e,t){return vn(b.cell,t)-vn(b.cell,e)});var x=k[0];e.push(["move",x],["attack",U.units[G.units.indexOf(b)]]),t.cell=x,Mn(t,b)}}}else if("attack"===t.ai){var z=zn(G,t),I=!0,M=!1,S=void 0;try{for(var O,q=z.attack[Symbol.iterator]();!(I=(O=q.next()).done);I=!0){var A=O.value,L=xn(G,A);L&&L.hp&&!In(t,L)&&a.push(L)}}catch(e){M=!0,S=e}finally{try{!I&&q.return&&q.return()}finally{if(M)throw S}}if(a.length){var R=Q(t,a),C=yn(R.cell,H(t)).filter(function(t){return z.move.find(function(e){return mn(e,t)})});if(C.length){C.sort(function(e,t){return vn(R.cell,t)-vn(R.cell,e)});var T=C[0];mn(t.cell,T)||e.push(["move",T]),e.push(["attack",U.units[G.units.indexOf(R)]]),t.cell=T,Mn(t,R)}}else if((a=G.units.filter(function(e){return!In(t,e)})).length){var D=a.map(function(e){return Cn(K,t.cell,e.cell).slice(0,-1)});a.sort(function(e,t){return D[a.indexOf(e)].length-D[a.indexOf(t)]});for(var E=a[0],j=D.find(function(e){return 1===vn(e[e.length-1],E.cell)}),B=[],N=function(e){var t=z.move[e],a=j.find(function(e){return mn(t,e)});a&&!xn(G,t)&&B.push(a)},P=0;P<z.move.length;P++)N(P);if(B.length){B.sort(function(e,t){return j.indexOf(t)-j.indexOf(e)});var _=B[0];e.push(["move",_]),t.cell=_}}}},c=!0,u=!1,f=void 0;try{for(var h,g=l[Symbol.iterator]();!(c=(h=g.next()).done);c=!0)s(h.value)}catch(e){u=!0,f=e}finally{try{!c&&g.return&&g.return()}finally{if(u)throw f}}return F}(X.map,"enemy"),f.allies=B,i.selection=null,i.under=null)}if(t.cancel&&!a.cancel){var P=G.state.anims[0];if(!P||"move"!==P.type)if(o){if("pause"===o.type)G.state.paused=!1;else if("actions"===o.type){var _=G.state.cursor.selection.unit,U=X.map.units.indexOf(_);G.cache.units[U].cell=_.cell,G.cache.moved=null}r.shift(),r.length&&"actions"===(o=r[0]).type&&(o.menu.done=!1)}else i.selection?W(i):G.state.attacks.length||P&&"phase"===P.type||(G.state.paused=!0)}F=Y,Object.assign(F.prev,F.held);var F;requestAnimationFrame(e)}()});var P,_,X=(_=(P=e).units.map(function(e){return function(e,t,a,i,n){return{name:e,type:t,faction:a,ai:i,cell:n,hp:3,stats:d[t],equipment:m[t]}}.apply(void 0,_toConsumableArray(e))}),{map:{tiles:P.tiles,layout:P.layout,units:_},phase:{faction:"player",pending:_.filter(function(e){return"player"===e.faction})}}),Y={held:function(e,i){var n={},r=!1;function t(e){var t=null;if(i)for(var t in i){for(var a=0;a<i[t].length&&i[t][a]!==e.code;a++);if(a<i[t].length)break;t=null}t||(t=e.code),"keydown"===e.type?n[t]||(n[t]=1):"keyup"===e.type&&(n[t]=0),r||(r=!0,requestAnimationFrame(o))}function o(){for(var e in n)n[e]&&n[e]++;requestAnimationFrame(o)}return e.addEventListener("keydown",t),e.addEventListener("keyup",t),n}(window,N),prev:{}};window.addEventListener("keydown",function(e){"Tab"===e.code&&e.preventDefault()})}();